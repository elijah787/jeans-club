
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeans Club - Raised on Denim</title>
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" defer></script>
<script>
  window.OneSignal = window.OneSignal || [];
  OneSignal.push(function() {
    OneSignal.init({
      appId: "d1126f8b-8799-41dc-8f13-9b921989582b",
      
      serviceWorkerParam: { scope: '/jeans-club/' }
    });
  });
</script>
    <style>
        /* MERCEDES-BENZ INSPIRED HEADER & NAVIGATION */
        .mercedes-header {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: white;
            font-family: 'Arial', sans-serif;
            position: relative;
            z-index: 1000;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .brand-logo {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #ffffff;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .logo-jeans {
            color: #00AFF0;
        }

        .logo-club {
            color: #ffffff;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .search-icon, .user-icon, .menu-toggle {
            cursor: pointer;
            font-size: 20px;
            transition: color 0.3s;
        }

        .search-icon:hover, .user-icon:hover, .menu-toggle:hover {
            color: #00AFF0;
        }

        /* Search Modal */
        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: flex-start;
            padding-top: 100px;
        }

        .search-modal.active {
            display: flex;
        }

        .search-container {
            width: 90%;
            max-width: 600px;
        }

        .search-input {
            width: 100%;
            padding: 20px;
            font-size: 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid #00AFF0;
            color: white;
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .search-results {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .search-result-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .search-close {
            position: absolute;
            top: 30px;
            right: 30px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Navigation */
        .main-navigation {
            display: flex;
            justify-content: center;
            padding: 0 40px;
            background: rgba(0, 0, 0, 0.95);
        }

        .nav-links {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 40px;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            color: #ffffff;
            text-decoration: none;
            padding: 20px 0;
            display: inline-block;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: #00AFF0;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: #00AFF0;
            transition: width 0.3s;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
        }

        .menu-toggle span {
            width: 25px;
            height: 2px;
            background: white;
            transition: 0.3s;
        }

        /* Full Page Background */
        body {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                        url('https://images.unsplash.com/photo-1542272604-787c3835535d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
        }

        /* Hero Section - REMOVED THE STATEMENT */
        .hero-section {
            color: white;
            padding: 100px 20px;
            text-align: center;
            margin-bottom: 60px;
            background: transparent;
        }

        .hero-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .hero-subtitle {
            font-size: 20px;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto 40px;
            line-height: 1.6;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* Information Pages */
        .info-page {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            margin: 20px auto;
            max-width: 1200px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .info-page h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-align: center;
        }

        .info-page h2 {
            color: #667eea;
            margin: 30px 0 15px;
            font-size: 1.8em;
        }

        .info-page p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .info-page ul, .info-page ol {
            color: #555;
            margin-left: 20px;
            margin-bottom: 20px;
        }

        .info-page li {
            margin-bottom: 10px;
        }

        .tiers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .tier-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 4px solid;
        }

        .tier-card.pearl { border-color: #FFF8DC; }
        .tier-card.bronze { border-color: #B76E79; }
        .tier-card.silver { border-color: #2C3E50; }
        .tier-card.ruby { border-color: #8B475D; }
        .tier-card.gold { border-color: #FFD700; }
        .tier-card.sapphire { border-color: #34495E; }
        .tier-card.platinum { border-color: #2F4F4F; }

        .tier-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .benefits-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .benefit-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .benefit-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        /* Enhanced Voucher/QR Details Display */
        .voucher-details-display, .qr-details-display {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .detail-item strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        /* Social Media Links */
        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .social-link {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.3s;
        }

        .social-link:hover {
            transform: translateY(-2px);
        }

        .social-tiktok { background: #000000; }
        .social-instagram { background: #E4405F; }
        .social-x { background: #000000; }

        /* REST OF YOUR EXISTING CSS STYLES */
        * {
            margin: 0;
            padding: 0;
            border: 0;
            font-size: 100%;
            font: inherit;
            vertical-align: baseline;
            box-sizing: inherit;
        }

        *, *::after, *::before {
            box-sizing: inherit;
        }

        html {
            width: 100%;
            height: auto;
            overflow-x: visible;
            overflow-x: initial;
            font-size: 10px;
            line-height: 1;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            -ms-text-size-adjust: 100%;
            -webkit-text-size-adjust: 100%;
            --scrollWidth: 0px;
        }

        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            color: #333;
            font-size: 1.4rem;
            font-family: HelveticaNeue-Light, Helvetica, Arial, sans-serif;
            line-height: 1.1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-shadow: 1px 1px 1px rgba(0, 0, 0, .004);
        }

        /* TYPOGRAPHY SYSTEM */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            font-family: Emirates-Bold, Helvetica, Arial, Lucida Grande, sans-serif;
            display: inline-block;
            margin: 0 0 1rem;
            text-align: left;
        }

        h1 {
            font-size: 2.5em;
        }

        h2 {
            font-size: 1.6rem;
        }

        .reset-h {
            display: block;
        }

        .links-section__heading {
            margin: 0;
            padding: 10px;
            color: #fff;
            font-weight: 400;
            font-size: 1.8rem;
            line-height: 2.5rem;
            opacity: .9;
            -webkit-font-smoothing: antialiased;
        }

        @media only screen and (min-width: 1024px) {
            .links-section__heading {
                padding: 25px 0 0;
            }
        }

        /* YOUR EXISTING COMPONENT STYLES */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #333;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            color: #666;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        input, select, button, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: HelveticaNeue-Light, Helvetica, Arial, sans-serif;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            font-family: Emirates-Bold, Helvetica, Arial, sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.google {
            background: white;
            color: #333;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn.google img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .section-title {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-family: Emirates-Bold, Helvetica, Arial, sans-serif;
        }

        .member-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-family: Emirates-Bold, Helvetica, Arial, sans-serif;
        }

        .info-card p {
            color: #666;
            font-size: 1.1em;
        }

        .tier-pearl { color: #FFF8DC; }
        .tier-bronze { color: #B76E79; }
        .tier-silver { color: #2C3E50; }
        .tier-ruby { color: #8B475D; }
        .tier-gold { color: #FFD700; }
        .tier-sapphire { color: #34495E; }
        .tier-platinum { color: #2F4F4F; }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .activity-log {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .discount-result {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .discount-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .discount-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .admin-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
        }

        .members-list {
            display: grid;
            gap: 15px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-buttons .btn {
            flex: 1;
        }

        .newsletter-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .newsletter-checkbox input {
            width: auto;
        }

        .newsletter-checkbox label {
            margin: 0;
            font-weight: normal;
        }

        /* IMPROVED MEMBER CARD STYLES - FIXED FOR MOBILE */
        .member-card-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            perspective: 1000px;
        }

        .member-card {
            width: 360px;
            height: 220px;
            border-radius: 20px;
            padding: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.25);
            font-family: 'Arial', sans-serif;
            color: white;
            transition: transform 0.3s ease;
            transform-style: preserve-3d;
        }

        .member-card:hover {
            transform: translateY(-5px) rotateX(5deg);
        }

        /* UPDATED TIER COLORS */
        .member-card.pearl {
            background: linear-gradient(135deg, #FFF8DC 0%, #F5DEB3 100%);
            color: #333;
        }

        .member-card.bronze {
            background: linear-gradient(135deg, #B76E79 0%, #8B475D 100%);
        }

        .member-card.silver {
            background: linear-gradient(135deg, #2C3E50 0%, #34495E 100%);
        }

        .member-card.ruby {
            background: linear-gradient(135deg, #8B475D 0%, #6B3648 100%);
        }

        .member-card.gold {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
        }

        .member-card.sapphire {
            background: linear-gradient(135deg, #34495E 0%, #1F2B3A 100%);
        }

        .member-card.platinum {
            background: linear-gradient(135deg, #2F4F4F 0%, #000000 100%);
        }

        /* Card design elements */
        .card-background-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.1;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.8) 2px, transparent 2px),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.6) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .card-logo {
            position: absolute;
            top: 20px;
            right: 25px;
            font-weight: bold;
            font-size: 18px;
            letter-spacing: 1px;
        }

        .card-chip {
            position: absolute;
            top: 20px;
            left: 25px;
            width: 40px;
            height: 30px;
            background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .card-chip::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 30px;
            height: 20px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 3px;
        }

        /* FIXED JC ID DISPLAY FOR MOBILE */
        .card-number {
            position: absolute;
            top: 75px; /* Adjusted for better mobile spacing */
            left: 25px;
            font-size: 20px; /* Slightly larger for better readability */
            letter-spacing: 3px; /* Increased spacing */
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            width: calc(100% - 50px);
            white-space: nowrap;
            overflow: visible;
            text-overflow: clip;
            display: flex;
            justify-content: flex-start;
            gap: 5px;
        }

        /* FIXED CARD HOLDER POSITIONING */
        .card-holder {
            position: absolute;
            bottom: 70px; /* Positioned above JC ID with more space */
            left: 25px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .card-holder-name {
            font-size: 18px; /* Slightly larger for mobile */
            font-weight: bold;
            margin-top: 8px; /* More space between label and name */
            text-transform: uppercase;
            letter-spacing: 1.5px;
            line-height: 1.2;
        }

        .card-tier {
            position: absolute;
            bottom: 25px;
            left: 25px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .card-date {
            position: absolute;
            bottom: 25px;
            right: 25px;
            font-weight: bold;
            font-size: 14px;
            letter-spacing: 1px;
        }

        /* Special number styling like the reference images */
        .card-number span {
            display: inline-block;
            background: rgba(0,0,0,0.2);
            padding: 2px 8px;
            margin: 0 1px;
            border-radius: 4px;
            min-width: 22px;
            text-align: center;
        }

        /* SIM card holographic effect */
        .card-hologram {
            position: absolute;
            top: 20px;
            right: 80px;
            width: 50px;
            height: 30px;
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 5px,
                    rgba(255,255,255,0.2) 5px,
                    rgba(255,255,255,0.2) 10px
                ),
                repeating-linear-gradient(
                    -45deg,
                    transparent,
                    transparent 5px,
                    rgba(255,255,255,0.1) 5px,
                    rgba(255,255,255,0.1) 10px
                );
            border-radius: 5px;
            transform: skewX(-10deg);
            box-shadow: 0 0 5px rgba(255,255,255,0.3);
        }

        /* NEW VOUCHER MANAGEMENT STYLES */
        .voucher-management-section {
            margin-top: 30px;
        }

        .voucher-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
        }

        .voucher-item.used {
            border-left-color: #6c757d;
            opacity: 0.7;
        }

        .voucher-item.expired {
            border-left-color: #dc3545;
        }

        .voucher-code {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px 0;
        }

        .voucher-qr {
            margin: 10px 0;
            text-align: center;
        }

        .voucher-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-used {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .scan-voucher-section {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }

        /* QR Redemption Styles */
        .redemption-option {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .redemption-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .redemption-option.selected {
            border-color: #28a745;
            background: #e8f5e8;
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .option-tier {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .selected-option-details {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success-card {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .info-message {
            background: #e7f3ff;
            color: #2196F3;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        /* QR Code Container */
        .qr-code-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .qr-share-section {
            display: block !important;
        }

        /* Redemption Item */
        .redemption-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .redemption-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .redemption-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px 0;
        }

        /* NEW IMPROVED CAMERA SCANNER STYLES */
        .camera-scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .camera-scanner-modal.active {
            display: flex;
        }

        .camera-container {
            width: 100%;
            max-width: 600px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .scanner-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .scanner-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .scanner-header p {
            margin: 5px 0 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .scanner-viewport {
            position: relative;
            width: 100%;
            height: 400px;
            background: #000;
            overflow: hidden;
        }

        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: #ff4757;
            box-shadow: 0 0 10px #ff4757;
            animation: scan 2s infinite linear;
            z-index: 10;
        }

        @keyframes scan {
            0% { top: 0; }
            50% { top: calc(100% - 4px); }
            100% { top: 0; }
        }

        #cameraCanvas {
            display: none;
        }

        .scanner-controls {
            background: #f8f9fa;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .camera-select {
            width: 100%;
        }

        .camera-select select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .camera-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .camera-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .camera-btn.start {
            background: #28a745;
            color: white;
        }

        .camera-btn.start:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .camera-btn.stop {
            background: #dc3545;
            color: white;
        }

        .camera-btn.stop:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .camera-btn.switch {
            background: #17a2b8;
            color: white;
        }

        .camera-btn.switch:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .camera-btn.close {
            background: #6c757d;
            color: white;
        }

        .camera-btn.close:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .camera-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none !important;
        }

        .scan-status {
            text-align: center;
            padding: 12px;
            margin: 0;
            border-radius: 5px;
            font-weight: bold;
            background: #e7f3ff;
            color: #2196F3;
        }

        .scan-status.active {
            background: #d4edda;
            color: #155724;
        }

        .scan-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .scanner-results {
            background: white;
            padding: 20px;
            border-top: 1px solid #eee;
            max-height: 200px;
            overflow-y: auto;
        }

        .result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        #scannerResult {
            word-break: break-all;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #ddd;
            min-height: 80px;
            font-family: monospace;
            font-size: 14px;
            color: #333; /* Add this to ensure text is visible */
    margin-top: 10px;
    max-height: 150px;
    overflow-y: auto;
        }
           /* Make scanner results more prominent when data is detected */
#scannerResult:not(:empty) {
    background: #d4edda !important;
    border-color: #28a745 !important;
    color: #155724 !important;
    font-weight: bold;
}
       /* Ensure camera modal is on top */
.camera-scanner-modal {
    z-index: 9999; /* Increase z-index */
}
     

   





        /* Quick Scan Button */
        .quick-scan-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.3s;
            margin: 10px 0;
        }

        .quick-scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .quick-scan-btn i {
            font-size: 20px;
        }

        /* Scan Results Display */
        .scan-results {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease;
        }

        .scan-results.success {
            border-left: 5px solid #28a745;
        }

        .scan-results.error {
            border-left: 5px solid #dc3545;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            .nav-links {
                gap: 20px;
            }
            
            .header-top {
                padding: 15px 20px;
            }
            
            .main-navigation {
                padding: 0 20px;
            }
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
            }
            
            .nav-links {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, 0.95);
                flex-direction: column;
                padding: 20px;
                gap: 10px;
            }
            
            .nav-links.active {
                display: flex;
            }
            
            .nav-link {
                padding: 15px;
                width: 100%;
            }
            
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .member-info {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            /* MOBILE CARD ADJUSTMENTS */
            .member-card {
                width: 320px;
                height: 200px;
                padding: 20px;
            }
            
            .card-number {
                top: 70px;
                font-size: 18px;
                letter-spacing: 2px;
            }
            
            .card-number span {
                padding: 2px 6px;
                min-width: 18px;
            }
            
            .card-holder {
                bottom: 65px;
            }
            
            .card-holder-name {
                font-size: 16px;
                margin-top: 6px;
            }
            
            .card-tier, .card-date {
                bottom: 20px;
                font-size: 12px;
            }
            
            .card-logo {
                font-size: 16px;
                top: 15px;
                right: 20px;
            }
            
            .card-chip {
                top: 15px;
                left: 20px;
                width: 35px;
                height: 25px;
            }
            
            .hero-title {
                font-size: 36px;
            }
            
            .hero-subtitle {
                font-size: 18px;
            }
            
            .tiers-grid, .benefits-list {
                grid-template-columns: 1fr;
            }
            
            .scanner-viewport {
                height: 300px;
            }
            
            .camera-buttons {
                flex-direction: column;
            }
            
            .camera-btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .member-card {
                width: 290px;
                height: 180px;
                padding: 15px;
            }
            
            .card-number {
                top: 65px;
                font-size: 16px;
                letter-spacing: 1.5px;
            }
            
            .card-number span {
                padding: 1px 4px;
                min-width: 16px;
            }
            
            .card-holder {
                bottom: 60px;
                font-size: 10px;
            }
            
            .card-holder-name {
                font-size: 14px;
                margin-top: 4px;
                letter-spacing: 1px;
            }
            
            .card-tier, .card-date {
                bottom: 15px;
                font-size: 10px;
            }
            
            .card-logo {
                font-size: 14px;
                top: 10px;
                right: 15px;
            }
            
            .card-chip {
                top: 10px;
                left: 15px;
                width: 30px;
                height: 20px;
            }
            
            .hero-title {
                font-size: 28px;
            }
            
            .hero-subtitle {
                font-size: 16px;
            }
            
            .scanner-viewport {
                height: 250px;
            }
        }

        @media (max-width: 360px) {
            .member-card {
                width: 280px;
                height: 170px;
            }
            
            .card-number {
                font-size: 14px;
            }
            
            .card-holder-name {
                font-size: 13px;
            }
        }

        /* Footer */
        .footer {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 60px 20px 30px;
            margin-top: 60px;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
        }

        .footer-section h3 {
            color: #00AFF0;
            margin-bottom: 20px;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .footer-section p {
            color: #999;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 30px;
            margin-top: 30px;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: #666;
            font-size: 14px;
        }

        /* ===== SCANNER RESULTS FIXES ===== */

/* Make sure scanner results are always visible when they exist */
.scanner-results {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    background: white !important;
    padding: 20px !important;
    border-top: 1px solid #eee !important;
    max-height: 400px !important;
    overflow-y: auto !important;
    min-height: 200px !important;
}

/* Fix the scanner result text display */
#scannerResult {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    min-height: 150px !important;
    background: white !important;
    border: 2px solid #ddd !important;
    border-radius: 8px !important;
    padding: 15px !important;
    margin-top: 10px !important;
    color: #333 !important;
    font-family: monospace !important;
    font-size: 14px !important;
    word-break: break-all !important;
    overflow-y: auto !important;
    max-height: 300px !important;
     line-height: 1.5 !important; /* Added for better readability */

}

/* When scanner result has content, make it stand out */
#scannerResult:not(:empty) {
    background: #d4edda !important;
    border-color: #28a745 !important;
    color: #155724 !important;
    font-weight: bold !important;
    border-width: 3px !important;
}

/* Make sure the scanner modal is always on top */
.camera-scanner-modal {
    z-index: 9999 !important;
}

/* Fix for the scan results display in admin panel */
#scanResults {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    animation: fadeIn 0.3s ease !important;
}

/* Add fade-in animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Make sure details grid is visible */
.details-grid {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
    gap: 15px !important;
    margin-top: 15px !important;
}

.detail-item {
    padding: 10px !important;
    background: white !important;
    border-radius: 5px !important;
    border: 1px solid #ddd !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.detail-item strong {
    color: #333 !important;
    display: block !important;
    margin-bottom: 5px !important;
    font-size: 12px !important;
    text-transform: uppercase !important;
    color: #666 !important;
}

.detail-item div {
    font-size: 14px !important;
    color: #333 !important;
    font-weight: 500 !important;
}

/* Fix the scan results section in admin panel */
.scan-results {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    background: white !important;
    border-radius: 10px !important;
    padding: 20px !important;
    margin-top: 20px !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1) !important;
    animation: slideIn 0.3s ease !important;
    border-left: 5px solid !important;
}

.scan-results.success {
    border-left-color: #28a745 !important;
}

.scan-results.error {
    border-left-color: #dc3545 !important;
}

.scan-results h4 {
    margin-top: 0 !important;
    margin-bottom: 15px !important;
    font-size: 18px !important;
}

.scan-results p {
    margin: 10px 0 !important;
}

/* Make result title more prominent */
.result-title {
    font-weight: bold !important;
    color: #333 !important;
    margin-bottom: 15px !important;
    font-size: 16px !important;
    display: block !important;
}

/* Force display of scanner results area */
.scanner-results {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
}

/* Make sure the scanner result area is not hidden */
#scannerResult.hidden,
.scanner-results.hidden,
.scan-results.hidden {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
}
    </style>
    <!-- Add Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Add jsQR Library (Replacing html5-qrcode) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
    <!-- Search Modal -->
    <div class="search-modal" id="searchModal">
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search for members, vouchers, redemptions...">
            <div class="search-results" id="searchResults"></div>
        </div>
        <div class="search-close" onclick="hideSearch()">√ó</div>
    </div>

    <!-- NEW IMPROVED CAMERA SCANNER MODAL -->
    <div class="camera-scanner-modal" id="cameraScannerModal">
        <div class="camera-container">
            <div class="scanner-header">
                <h2>QR Code Scanner</h2>
                <p>Scan vouchers, redemptions, or member QR codes</p>
            </div>
            
            <div class="scanner-viewport">
                <video id="cameraVideo" playsinline></video>
                <div class="scan-line"></div>
                <canvas id="cameraCanvas"></canvas>
            </div>
            
            <div class="scan-status" id="scanStatus">
                Click Start Scanner to begin
            </div>
            
            <div class="scanner-controls">
                <div class="camera-select">
                    <select id="cameraSelect">
                        <option value="">Select Camera</option>
                    </select>
                </div>
                
                <div class="camera-buttons">
                    <button class="camera-btn start" id="startScannerBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/>
                        </svg>
                        Start Scanner
                    </button>
                    <button class="camera-btn stop" id="stopScannerBtn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/>
                        </svg>
                        Stop Scanner
                    </button>
                    <button class="camera-btn switch" id="switchCameraBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11.5V13H9v2.5L5.5 12 9 8.5V11h6V8.5l3.5 3.5-3.5 3.5z"/>
                        </svg>
                        Switch Camera
                    </button>
                    <button class="camera-btn close" onclick="closeCameraScanner()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                        Close
                    </button>
                </div>
            </div>
            
            <div class="scanner-results">
                <div class="result-title">Scanned Result:</div>
                <div id="scannerResult">No QR code scanned yet</div>
            </div>
        </div>
    </div>

    <!-- Mercedes-Benz Inspired Header -->
    <header class="mercedes-header">
        <div class="header-top">
            <div class="brand-logo">
                <div class="logo">
                    <span class="logo-jeans">JEANS</span>
                    <span class="logo-club">CLUB</span>
                </div>
            </div>
            
            <div class="header-actions">
                <div class="search-icon" onclick="showSearch()">üîç</div>
                <div class="user-icon" onclick="toggleUserMenu()">üë§</div>
                <div class="menu-toggle" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
        
        <nav class="main-navigation">
            <ul class="nav-links" id="navLinks">
                <li class="nav-item"><a href="#dashboard" class="nav-link" onclick="showDashboardSection()">Dashboard</a></li>
                <li class="nav-item"><a href="#membership" class="nav-link" onclick="showMembershipInfo()">Membership</a></li>
                <li class="nav-item"><a href="#benefits" class="nav-link" onclick="showBenefits()">Benefits</a></li>
                <li class="nav-item"><a href="#tiers" class="nav-link" onclick="showTiers()">Tiers</a></li>
                <li class="nav-item"><a href="#rewards" class="nav-link" onclick="showRewards()">Rewards</a></li>
                <li class="nav-item"><a href="#qr" class="nav-link" onclick="showQRRedemptionPanel()">QR Redemption</a></li>
                <li class="nav-item"><a href="#contact" class="nav-link" onclick="showContact()">Contact</a></li>
            </ul>
        </nav>
    </header>

    <!-- Hero Section - REMOVED THE PROBLEMATIC STATEMENT -->
    <section class="hero-section">
        <h1 class="hero-title">Raised on Denim</h1>
        <!-- Statement removed as requested -->
    </section>

    <div class="container" id="main-content">
        <!-- Information Pages -->
        <div id="membershipInfoPage" class="info-page hidden">
            <div class="nav-buttons">
                <button class="btn secondary" onclick="showDashboardSection()">‚Üê Back to Dashboard</button>
            </div>
            
            <h1>Membership Information</h1>
            
            <h2>Welcome to Jeans Club Membership</h2>
            <p>Our loyalty program is designed to reward our most valued customers with exclusive benefits, points, and tiered privileges. As a member, you'll enjoy a premium denim shopping experience like no other.</p>
            
            <h2>üí∞ New Points System</h2>
            <div class="benefits-list">
                <div class="benefit-item">
                    <div class="benefit-icon">üí∞</div>
                    <h3>Earn Points</h3>
                    <p><strong>1 point for every 1,000 UGX spent</strong></p>
                    <p>Shop more, earn more points automatically</p>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">üí∏</div>
                    <h3>Redeem Points</h3>
                    <p><strong>1 point = 250 UGX discount</strong></p>
                    <p>Convert your points into shopping discounts</p>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">üìà</div>
                    <h3>Simple & Transparent</h3>
                    <p>Easy to calculate your rewards</p>
                    <p>No complex formulas or hidden rules</p>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">üéØ</div>
                    <h3>Example</h3>
                    <p>Spend 50,000 UGX = 50 points</p>
                    <p>50 points = 12,500 UGX discount</p>
                </div>
            </div>
            
            <h2>How to Join</h2>
            <ol>
                <li>Sign up using your email address or Google account</li>
                <li>Receive your unique JC ID (Jeans Club Identification)</li>
                <li>Get your starting points and referral code</li>
                <li>Start shopping to earn points and climb tiers</li>
            </ol>
            
            <h2>Membership Features</h2>
            <div class="benefits-list">
                <div class="benefit-item">
                    <div class="benefit-icon">üéÅ</div>
                    <h3>Simple Points System</h3>
                    <p>Earn 1 point for every 1,000 UGX spent. Redeem 1 point for 250 UGX discount.</p>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">‚≠ê</div>
                    <h3>7 Tiers</h3>
                    <p>Progress through Pearl, Bronze, Silver, Ruby, Gold, Sapphire, and Platinum tiers.</p>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">üë•</div>
                    <h3>Referral Program</h3>
                    <p>Earn 100 points for each friend who joins using your referral code.</p>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">üíé</div>
                    <h3>Exclusive Discounts</h3>
                    <p>Convert points to discount vouchers or use points for purchases.</p>
                </div>
            </div>
            
            <h2>Getting Started</h2>
            <p>Upon joining, you'll receive:</p>
            <ul>
                <li>10 welcome points (20 if referred by a friend)</li>
                <li>Unique JC ID for all transactions</li>
                <li>Personal referral code to share with friends</li>
                <li>Starting tier: Pearl</li>
                <li>Access to your digital membership card</li>
            </ul>
            
            <h2>Managing Your Membership</h2>
            <p>Use your dashboard to:</p>
            <ul>
                <li>Track your points balance and tier progress</li>
                <li>View purchase history and activity log</li>
                <li>Create and manage discount vouchers</li>
                <li>Share your referral code</li>
                <li>Update newsletter preferences</li>
            </ul>
            
            <div style="text-align: center; margin-top: 40px;">
                <button class="btn" onclick="showSignupScreen()">Join Now</button>
                <button class="btn secondary" onclick="showLoginScreen()" style="margin-left: 10px;">Login</button>
            </div>
        </div>

        <div id="benefitsInfoPage" class="info-page hidden">
            <div class="nav-buttons">
                <button class="btn secondary" onclick="showDashboardSection()">‚Üê Back to Dashboard</button>
            </div>
            
            <h1>Member Benefits</h1>
            
            <h2>üåü Exclusive Member Benefits</h2>
            <p>As a Jeans Club member, you unlock a world of exclusive benefits designed to enhance your denim shopping experience.</p>
            
            <div class="benefits-list">
                <div class="benefit-item">
                    <div class="benefit-icon">üí∞</div>
                    <h3>New Points System</h3>
                    <p><strong>Earn:</strong> 1 point for every 1,000 UGX spent</p>
                    <p><strong>Redeem:</strong> 1 point = 250 UGX discount</p>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">üé´</div>
                    <h3>QR Code Redemption</h3>
                    <p>Generate QR codes for instant redemption at checkout.</p>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">üìß</div>
                    <h3>Exclusive Emails</h3>
                    <p>Receive personalized offers, new arrival alerts, and style tips.</p>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">‚ö°</div>
                    <h3>Faster Checkout</h3>
                    <p>Quick QR code scanning for seamless purchases.</p>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">üéÅ</div>
                    <h3>Birthday Rewards</h3>
                    <p>Special birthday discounts and bonus points.</p>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">üëë</div>
                    <h3>VIP Access</h3>
                    <p>Early access to sales and exclusive collections.</p>
                </div>
            </div>
            
            <h2>üí∞ Points Calculation Examples</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3>Simple & Transparent Rewards</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr style="background: #667eea; color: white;">
                            <th style="padding: 10px; text-align: left;">Spending</th>
                            <th style="padding: 10px; text-align: left;">Points Earned</th>
                            <th style="padding: 10px; text-align: left;">Discount Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px;">10,000 UGX</td>
                            <td style="padding: 10px;">10 points</td>
                            <td style="padding: 10px;">2,500 UGX</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px;">50,000 UGX</td>
                            <td style="padding: 10px;">50 points</td>
                            <td style="padding: 10px;">12,500 UGX</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px;">100,000 UGX</td>
                            <td style="padding: 10px;">100 points</td>
                            <td style="padding: 10px;">25,000 UGX</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">200,000 UGX</td>
                            <td style="padding: 10px;">200 points</td>
                            <td style="padding: 10px;">50,000 UGX</td>
                        </tr>
                    </tbody>
                </table>
                <p style="margin-top: 15px; font-size: 14px; color: #666;">*Points are calculated automatically with every purchase</p>
            </div>
            
            <h2>üéØ Tier-Specific Benefits</h2>
            <p>Your benefits increase as you progress through tiers:</p>
            
            <h3>Pearl & Bronze Tiers</h3>
            <ul>
                <li>Basic points earning (1 point per 1,000 UGX spent)</li>
                <li>Discount voucher creation</li>
                <li>Newsletter subscription</li>
                <li>Referral program access</li>
            </ul>
            
            <h3>Silver & Ruby Tiers</h3>
            <ul>
                <li>Higher points multipliers (1.1x - 1.3x)</li>
                <li>Pay-with-points redemption options</li>
                <li>Extended voucher validity</li>
                <li>Priority email support</li>
            </ul>
            
            <h3>Gold & Sapphire Tiers</h3>
            <ul>
                <li>Premium multipliers (1.4x - 1.5x)</li>
                <li>Higher discount percentages</li>
                <li>Lifetime spending bonuses</li>
                <li>Exclusive event invitations</li>
            </ul>
            
            <h3>Platinum Tier</h3>
            <ul>
                <li>Maximum multiplier (1.6x)</li>
                <li>All redemption options available</li>
                <li>Personalized shopping assistance</li>
                <li>Highest discount rates</li>
            </ul>
            
            <h2>üîß How to Maximize Benefits</h2>
            <ol>
                <li>Shop regularly to earn more points (1 point per 1,000 UGX)</li>
                <li>Use referral codes to earn bonus points (100 points per referral)</li>
                <li>Redeem points for discounts (1 point = 250 UGX)</li>
                <li>Subscribe to newsletters for exclusive offers</li>
                <li>Use QR codes for faster redemptions</li>
                <li>Combine points for larger discounts</li>
                <li>Participate in seasonal promotions</li>
            </ol>
            
            <div style="text-align: center; margin-top: 40px;">
                <button class="btn" onclick="showDashboardSection()">View Your Benefits</button>
            </div>
        </div>

        <div id="tiersInfoPage" class="info-page hidden">
            <div class="nav-buttons">
                <button class="btn secondary" onclick="showDashboardSection()">‚Üê Back to Dashboard</button>
            </div>
            
            <h1>Tier System</h1>
            
            <h2>üéØ Our 7-Tier System</h2>
            <p>Progress through our carefully designed tier system to unlock increasingly valuable benefits and rewards.</p>
            
            <div class="tiers-grid">
                <div class="tier-card pearl">
                    <h3>PEARL</h3>
                    <p><strong>Points Range:</strong> 0 - 7,499</p>
                    <p><strong>Multiplier:</strong> 1.0x</p>
                    <p><strong>Earning Rate:</strong> 1 point / 1,000 UGX</p>
                    <p><strong>Discount Value:</strong> 1 point = 250 UGX</p>
                    <p><strong>Benefits:</strong></p>
                    <ul>
                        <li>Basic points earning</li>
                        <li>Discount vouchers</li>
                        <li>Newsletter access</li>
                        <li>Referral program</li>
                    </ul>
                </div>
                
                <div class="tier-card bronze">
                    <h3>BRONZE</h3>
                    <p><strong>Points Range:</strong> 7,500 - 24,999</p>
                    <p><strong>Multiplier:</strong> 1.1x</p>
                    <p><strong>Earning Rate:</strong> 1.1 points / 1,000 UGX</p>
                    <p><strong>Discount Value:</strong> 1 point = 250 UGX</p>
                    <p><strong>Benefits:</strong></p>
                    <ul>
                        <li>All Pearl benefits</li>
                        <li>Higher point multiplier</li>
                        <li>8% spending redemption</li>
                        <li>Extended support</li>
                    </ul>
                </div>
                
                <div class="tier-card silver">
                    <h3>SILVER</h3>
                    <p><strong>Points Range:</strong> 25,000 - 99,999</p>
                    <p><strong>Multiplier:</strong> 1.25x</p>
                    <p><strong>Earning Rate:</strong> 1.25 points / 1,000 UGX</p>
                    <p><strong>Discount Value:</strong> 1 point = 250 UGX</p>
                    <p><strong>Benefits:</strong></p>
                    <ul>
                        <li>10% spending redemption</li>
                        <li>Pay-with-points option</li>
                        <li>Priority support</li>
                        <li>Early sale access</li>
                    </ul>
                </div>
                
                <div class="tier-card ruby">
                    <h3>RUBY</h3>
                    <p><strong>Points Range:</strong> 100,000 - 249,999</p>
                    <p><strong>Multiplier:</strong> 1.3x</p>
                    <p><strong>Earning Rate:</strong> 1.3 points / 1,000 UGX</p>
                    <p><strong>Discount Value:</strong> 1 point = 250 UGX</p>
                    <p><strong>Benefits:</strong></p>
                    <ul>
                        <li>12% spending redemption</li>
                        <li>Higher discount caps</li>
                        <li>Exclusive offers</li>
                        <li>Faster processing</li>
                    </ul>
                </div>
                
                <div class="tier-card gold">
                    <h3>GOLD</h3>
                    <p><strong>Points Range:</strong> 250,000 - 499,999</p>
                    <p><strong>Multiplier:</strong> 1.4x</p>
                    <p><strong>Earning Rate:</strong> 1.4 points / 1,000 UGX</p>
                    <p><strong>Discount Value:</strong> 1 point = 250 UGX</p>
                    <p><strong>Benefits:</strong></p>
                    <ul>
                        <li>15% spending redemption</li>
                        <li>Loyalty bonuses</li>
                        <li>VIP treatment</li>
                        <li>Event invitations</li>
                    </ul>
                </div>
                
                <div class="tier-card sapphire">
                    <h3>SAPPHIRE</h3>
                    <p><strong>Points Range:</strong> 500,000 - 999,999</p>
                    <p><strong>Multiplier:</strong> 1.5x</p>
                    <p><strong>Earning Rate:</strong> 1.5 points / 1,000 UGX</p>
                    <p><strong>Discount Value:</strong> 1 point = 250 UGX</p>
                    <p><strong>Benefits:</strong></p>
                    <ul>
                        <li>18% + 2% lifetime bonus</li>
                        <li>Maximum discounts</li>
                        <li>Personal assistant</li>
                        <li>Custom fittings</li>
                    </ul>
                </div>
                
                <div class="tier-card platinum">
                    <h3>PLATINUM</h3>
                    <p><strong>Points Range:</strong> 1,000,000+</p>
                    <p><strong>Multiplier:</strong> 1.6x</p>
                    <p><strong>Earning Rate:</strong> 1.6 points / 1,000 UGX</p>
                    <p><strong>Discount Value:</strong> 1 point = 250 UGX</p>
                    <p><strong>Benefits:</strong></p>
                    <ul>
                        <li>25% + 5% lifetime bonus</li>
                        <li>All redemption options</li>
                        <li>Exclusive collections</li>
                        <li>Highest privileges</li>
                    </ul>
                </div>
            </div>
            
            <h2>üí∞ Points System Explained</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3>Simple & Rewarding</h3>
                <p><strong>Earning Points:</strong> You earn 1 point for every 1,000 UGX you spend. Higher tiers earn points faster with multipliers.</p>
                
                <p><strong>Example for Pearl Tier:</strong></p>
                <ul>
                    <li>Spend 10,000 UGX = 10 points</li>
                    <li>Spend 50,000 UGX = 50 points</li>
                    <li>Spend 100,000 UGX = 100 points</li>
                </ul>
                
                <p><strong>Example for Gold Tier (1.4x multiplier):</strong></p>
                <ul>
                    <li>Spend 10,000 UGX = 14 points</li>
                    <li>Spend 50,000 UGX = 70 points</li>
                    <li>Spend 100,000 UGX = 140 points</li>
                </ul>
                
                <p><strong>Redeeming Points:</strong> Each point is worth 250 UGX in discount. The higher your tier, the more redemption options you have.</p>
            </div>
            
            <h2>üìà Tier Progression</h2>
            <p>Your tier is automatically calculated based on your total points. Points never expire and tiers only go up - once you reach a tier, you never downgrade!</p>
            
            <h3>How to Move Up Tiers</h3>
            <ol>
                <li><strong>Make Purchases:</strong> Every purchase earns points based on your current tier multiplier</li>
                <li><strong>Refer Friends:</strong> Earn 100 points for each successful referral</li>
                <li><strong>Participate in Promotions:</strong> Seasonal events offer bonus points</li>
                <li><strong>Be Consistent:</strong> Regular shopping accelerates tier progression</li>
            </ol>
            
            <h3>Important Notes</h3>
            <ul>
                <li>Points are permanent and never expire</li>
                <li>Tiers only increase - no downgrading</li>
                <li>Higher tiers = better multipliers and benefits</li>
                <li>All benefits are cumulative</li>
                <li>Redemption options expand with higher tiers</li>
                <li>Base rate: 1 point per 1,000 UGX spent</li>
                <li>1 point = 250 UGX discount value</li>
            </ul>
            
            <div style="text-align: center; margin-top: 40px;">
                <button class="btn" onclick="showDashboardSection()">Check Your Tier Progress</button>
            </div>
        </div>

        <div id="contactInfoPage" class="info-page hidden">
            <div class="nav-buttons">
                <button class="btn secondary" onclick="showDashboardSection()">‚Üê Back to Dashboard</button>
            </div>
            
            <h1>Contact Us</h1>
            
            <h2>üìû Get in Touch</h2>
            <p>We're here to help you with any questions about your Jeans Club membership, points, redemptions, or general inquiries.</p>
            
            <div class="benefits-list">
                <div class="benefit-item">
                    <div class="benefit-icon">üìß</div>
                    <h3>Email</h3>
                    <p><strong>Primary:</strong> oliviakamukama@gmail.com</p>
                    <p><strong>Support:</strong> support@jeansclub.com</p>
                </div>
                
                <div class="benefit-item">
                    <div class="benefit-icon">üì±</div>
                    <h3>Phone</h3>
                    <p><strong>Customer Service:</strong> +256 772558913</p>
                    <p><strong>WhatsApp:</strong> +256 772558913</p>
                </div>
                
                <div class="benefit-item">
                    <div class="benefit-icon">‚è∞</div>
                    <h3>Business Hours</h3>
                    <p><strong>Monday - Saturday:</strong> 8:00 AM - 9:00 PM</p>
                    <p><strong>Sunday:</strong> Closed</p>
                </div>
                
                <div class="benefit-item">
                    <div class="benefit-icon">üìç</div>
                    <h3>Location</h3>
                    <p>Kampala, Uganda</p>
                    <p>Premium Denim Boutique</p>
                </div>
            </div>
            
            <h2>üåê Connect With Us</h2>
            <p>Follow us on social media for the latest updates, style tips, and exclusive offers:</p>
            
            <div class="social-links" style="justify-content: center; margin: 30px 0;">
                <a href="https://www.tiktok.com/@jeansclubug?_r=1&_t=ZM-91wJ0p98EMG" target="_blank" class="social-link social-tiktok">
                    <span>üéµ</span> TikTok
                </a>
                <a href="https://www.instagram.com/jeans_club_ug?igsh=NmFkNTI5MDYzMTZk" target="_blank" class="social-link social-instagram">
                    <span>üì∏</span> Instagram
                </a>
                <a href="https://x.com/jeansclub_ug?s=20" target="_blank" class="social-link social-x">
                    <span>ùïè</span> X (Twitter)
                </a>
            </div>
            
            <h2>üìã Frequently Asked Questions</h2>
            
            <h3>Membership Questions</h3>
            <p><strong>Q: How do I join Jeans Club?</strong><br>
            A: Click "Sign Up" on our website and follow the simple registration process.</p>
            
            <p><strong>Q: Is there a membership fee?</strong><br>
            A: No, Jeans Club membership is completely free!</p>
            
            <p><strong>Q: How do I check my points balance?</strong><br>
            A: Log into your dashboard to see your current points and tier status.</p>
            
            <h3>Points & Redemptions</h3>
            <p><strong>Q: How do I earn points?</strong><br>
            A: Earn 1 point for every 1,000 UGX you spend. Higher tiers earn points faster with multipliers.</p>
            
            <p><strong>Q: How much is 1 point worth?</strong><br>
            A: Each point is worth 250 UGX in discount value.</p>
            
            <p><strong>Q: How do I redeem points?</strong><br>
            A: You can create discount vouchers or use the QR redemption system for instant savings.</p>
            
            <p><strong>Q: Do points expire?</strong><br>
            A: No, your points never expire as long as your account remains active.</p>
            
            <h3>Tier System</h3>
            <p><strong>Q: How do I move to a higher tier?</strong><br>
            A: Accumulate points through purchases and referrals to automatically progress to higher tiers.</p>
            
            <p><strong>Q: Can I be downgraded to a lower tier?</strong><br>
            A: No, once you reach a tier, you never go down. Our system only allows tier upgrades.</p>
            
            <h2>üÜò Need Immediate Help?</h2>
            <p>For urgent issues or assistance during checkout, please call us directly at <strong>+256 772558913</strong> during business hours.</p>
            
            <div style="text-align: center; margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3>Ready to Shop?</h3>
                <p>Visit our store or contact us for personalized shopping assistance!</p>
                <button class="btn" onclick="showDashboardSection()">Go to Dashboard</button>
            </div>
        </div>

        <!-- Rest of your existing HTML content -->
        <!-- Signup Section -->
        <div id="signupSection" class="card">
            <h2 class="section-title">Create Account</h2>
            <div class="form-group">
                <label for="userName">Full Name</label>
                <input type="text" id="userName" placeholder="Enter your full name" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="userEmail">Email Address</label>
                <input type="email" id="userEmail" placeholder="Enter your email" autocomplete="off">
                <small style="color: #666; display: block; margin-top: 5px;">Use your real email address. Temporary/disposable emails are blocked.</small>
            </div>
            <div class="form-group">
                <label for="userPassword">Password</label>
                <input type="password" id="userPassword" placeholder="Create a password" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label for="referralCode">Referral Code (Optional)</label>
                <input type="text" id="referralCode" placeholder="Enter referral code if any" autocomplete="off">
                <small style="color: #666; display: block; margin-top: 5px;">Cannot use your own referral code</small>
            </div>
            
            <div class="newsletter-checkbox">
                <input type="checkbox" id="newsletterSignup" checked>
                <label for="newsletterSignup">Subscribe to our newsletter for exclusive deals and updates</label>
            </div>
            
            <button class="btn" onclick="signUpWithEmail()">Create Account</button>
            <div class="form-group" style="text-align: center; margin: 20px 0;">
                <div style="border-bottom: 1px solid #ddd; line-height: 0.1em; margin: 10px 0 20px;">
                    <span style="background: white; padding: 0 10px; color: #666;">OR</span>
                </div>
                <div class="google-signin-button"></div>
            </div>
            <div class="form-group" style="text-align: center;">
                <p>Already have an account? <a href="#" onclick="showLoginScreen()" style="color: #667eea; text-decoration: none;">Login here</a></p>
            </div>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="card hidden">
            <h2 class="section-title">Login to Your Account</h2>
            <div class="form-group">
                <label for="loginJCId">JC ID</label>
                <input type="text" id="loginJCId" placeholder="Enter your JC ID" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password">
            </div>
            <button class="btn" onclick="loginWithCredentials()">Login</button>
            
            <div class="form-group" style="text-align: center; margin: 20px 0;">
                <a href="#" onclick="showPasswordResetScreen()" style="color: #667eea; text-decoration: none;">Forgot Password?</a>
            </div>
            
            <div class="form-group" style="text-align: center; margin: 20px 0;">
                <div style="border-bottom: 1px solid #ddd; line-height: 0.1em; margin: 10px 0 20px;">
                    <span style="background: white; padding: 0 10px; color: #666;">OR</span>
                </div>
                <div class="google-login-button"></div>
            </div>
            <div class="form-group" style="text-align: center;">
                <p>Don't have an account? <a href="#" onclick="showSignupScreen()" style="color: #667eea; text-decoration: none;">Sign up here</a></p>
            </div>
            <div class="form-group" style="text-align: center; margin-top: 20px;">
                <button class="btn secondary" onclick="showAdminLogin()">Staff Login</button>
            </div>
        </div>

        <!-- Password Reset Section -->
        <div id="passwordResetSection" class="card hidden">
            <div class="nav-buttons">
                <button class="btn secondary" onclick="showLoginScreen()">Back to Login</button>
            </div>

            <h2 class="section-title">Reset Your Password</h2>
            
            <div class="info-card">
                <h3>Request Password Reset</h3>
                <div class="form-group">
                    <label for="resetJCId">Your JC ID</label>
                    <input type="text" id="resetJCId" placeholder="Enter your JC ID">
                </div>
                <button class="btn" onclick="requestPasswordReset()">Send Reset Code</button>
                <div id="resetRequestResult" style="margin-top: 10px;"></div>
            </div>

            <div id="resetForm" class="info-card hidden">
                <h3>Enter Reset Code & New Password</h3>
                <div class="form-group">
                    <label for="resetToken">Reset Code (Check your email)</label>
                    <input type="text" id="resetToken" placeholder="Enter the reset code from email">
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm new password">
                </div>
                <button class="btn" onclick="executePasswordReset()">Reset Password</button>
                <div id="resetExecuteResult" style="margin-top: 10px;"></div>
            </div>

            <div class="info-card">
                <h3>Need Help?</h3>
                <p>If you're having trouble resetting your password:</p>
                <ul>
                    <li>Make sure you're entering the correct JC ID</li>
                    <li>Check your spam folder for the reset email</li>
                    <li>Reset codes expire after 1 hour</li>
                    <li>Google accounts don't use passwords - use Google Sign-In</li>
                </ul>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="card hidden">
            <div class="nav-buttons">
                <button class="btn secondary" onclick="logout()">Logout</button>
                <button class="btn" onclick="refreshData()">Refresh Data</button>
                <button class="btn" onclick="showQRRedemptionPanel()">üéüÔ∏è QR Code Redemption</button>
            </div>
            
            <h2 class="section-title">Member Dashboard</h2>
            
            <!-- IMPROVED MEMBER CARD DISPLAY -->
            <div class="member-card-container">
                <div id="memberCard" class="member-card">
                    <div class="card-background-pattern"></div>
                    <div class="card-logo">JEANS CLUB</div>
                    <div class="card-chip"></div>
                    <div class="card-hologram"></div>
                    <div class="card-number" id="cardNumber">XXXX XXXX XXXX XXXX</div>
                    <div class="card-holder">
                        CARD HOLDER
                        <div class="card-holder-name" id="cardHolderName">-</div>
                    </div>
                    <div class="card-tier" id="cardTier">-</div>
                    <div class="card-date" id="cardDate">MM/YY</div>
                </div>
            </div>
            
            <div class="member-info">
                <div class="info-card">
                    <h3>JC ID</h3>
                    <p id="memberJcId">-</p>
                </div>
                <div class="info-card">
                    <h3>Name</h3>
                    <p id="memberName">-</p>
                </div>
                <div class="info-card">
                    <h3>Email</h3>
                    <p id="memberEmail">-</p>
                </div>
                <div class="info-card">
                    <h3>Login Method</h3>
                    <p id="memberLoginMethod">-</p>
                </div>
            </div>

            <div class="member-info">
                <div class="info-card">
                    <h3>Current Tier</h3>
                    <p id="memberTier">-</p>
                </div>
                <div class="info-card">
                    <h3>Points Balance</h3>
                    <p id="memberPoints">-</p>
                </div>
                <div class="info-card">
                    <h3>Total Spent</h3>
                    <p id="totalSpent">- UGX</p>
                </div>
                <div class="info-card">
                    <h3>Referral Code</h3>
                    <p id="memberReferralCode">-</p>
                </div>
            </div>

            <div class="info-card">
                <h3>Tier Progress</h3>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <p id="tierProgressText">Loading progress...</p>
            </div>

            <div class="info-card">
                <h3>Points System</h3>
                <p><strong>Earn:</strong> 1 point for every 1,000 UGX spent</p>
                <p><strong>Redeem:</strong> 1 point = 250 UGX discount</p>
                <p><small>Higher tiers earn points faster with multipliers</small></p>
            </div>

            <div class="info-card">
                <h3>Newsletter Preferences</h3>
                <p>Get exclusive deals, new arrivals, and style tips delivered to your inbox</p>
                <button class="btn" onclick="toggleNewsletter()" id="newsletterToggle">
                    Subscribe to Newsletter
                </button>
            </div>

            <div class="info-card">
                <h3>Referral Stats</h3>
                <p id="referralStats">Loading stats...</p>
                <button class="btn" onclick="shareReferral()" style="margin-top: 10px;">Share Referral Code</button>
            </div>

            <div class="info-card">
                <h3>Redeem Points for Discount</h3>
                <div class="form-group">
                    <label for="discountPoints">Points to Use (Min: 4)</label>
                    <input type="number" id="discountPoints" placeholder="Enter points to redeem" min="4">
                </div>
                <button class="btn" onclick="calculateDiscount()">Calculate Discount</button>
                <div id="discountResult" class="discount-result"></div>
                <button class="btn" onclick="redeemPoints()" style="margin-top: 10px;">Generate Discount Voucher</button>
            </div>

            <!-- NEW VOUCHER MANAGEMENT SECTION -->
            <div class="info-card voucher-management-section">
                <h3>My Discount Vouchers</h3>
                <div id="vouchersList" class="activity-log">
                    <div class="activity-item">Loading vouchers...</div>
                </div>
            </div>

            <div class="info-card">
                <h3>Recent Activity</h3>
                <div id="activityLog" class="activity-log">
                    <div class="activity-item">Loading activity...</div>
                </div>
            </div>
        </div>

        <!-- Admin Section with Quick Scan Button -->
        <div id="adminSection" class="card hidden">
            <div class="nav-buttons">
                <button class="btn secondary" onclick="logout()">Logout</button>
                <button class="btn" onclick="showAdminPanel()">Refresh Members</button>
                <button class="btn secondary" onclick="showDeleteMemberSection()">Delete Member</button>
                <button class="btn" onclick="showVoucherManagementPanel()">Manage Vouchers</button>
                <button class="btn" onclick="showQRRedemptionManagementPanel()">QR Redemptions</button>
                <!-- REMOVED: Open Camera Scanner button - only keeping Quick Scan QR -->
            </div>

            <h2 class="section-title">Staff Admin Panel</h2>
            
            <div class="info-card">
                <h3>Add Purchase</h3>
                <div class="form-group">
                    <label for="purchaseJCId">Member JC ID</label>
                    <input type="text" id="purchaseJCId" placeholder="Enter JC ID">
                </div>
                <div class="form-group">
                    <label for="purchaseAmount">Amount (UGX)</label>
                    <input type="number" id="purchaseAmount" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label for="purchaseDescription">Description</label>
                    <input type="text" id="purchaseDescription" placeholder="Purchase description">
                </div>
                <button class="btn" onclick="adminAddPurchase()">Add Purchase</button>
                <div id="purchaseResult" style="margin-top: 10px;"></div>
            </div>

            <!-- ENHANCED VOUCHER SCANNING SECTION -->
            <div class="scan-voucher-section">
                <h3>üì± Scan & Redeem Voucher/QR Code</h3>
                
                <!-- Quick Scan Option -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="quick-scan-btn" onclick="openCameraScanner()">
                        üì∑ Quick Scan QR
                    </button>
                    <p style="color: #666; font-size: 14px; margin-top: 10px;">OR enter code manually below</p>
                </div>
                
                <div class="form-group">
                    <label for="voucherCodeInput">Voucher Code or QR Data</label>
                    <input type="text" id="voucherCodeInput" placeholder="Enter voucher code or QR code data">
                </div>
                <div class="form-group">
                    <label for="salespersonName">Your Name (Salesperson)</label>
                    <input type="text" id="salespersonName" placeholder="Enter your name" required>
                </div>
                <button class="btn" onclick="processScan()">Process Scan</button>
                <div id="scanDetails" class="voucher-details-display hidden" style="margin-top: 20px;">
                    <!-- Details will be shown here -->
                </div>
                <div id="voucherRedeemResult" style="margin-top: 10px;"></div>
                
                <!-- Scan Results Display -->
                <div id="scanResults" class="scan-results hidden"></div>
            </div>

            <div class="info-card">
                <h3>Send Newsletter</h3>
                <div class="form-group">
                    <label for="newsletterSubject">Subject</label>
                    <input type="text" id="newsletterSubject" placeholder="Enter newsletter subject">
                </div>
                <div class="form-group">
                    <label for="newsletterContent">Content</label>
                    <textarea id="newsletterContent" placeholder="Enter newsletter content" rows="6" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; font-family: inherit;"></textarea>
                </div>
                <button class="btn" onclick="sendNewsletter()">Send Newsletter to All Subscribers</button>
                <div id="newsletterResult" style="margin-top: 10px;"></div>
            </div>

            <div id="adminContent">
                <!-- Members list will be loaded here -->
            </div>
        </div>

        <!-- Delete Member Section -->
        <div id="deleteMemberSection" class="card hidden">
            <div class="nav-buttons">
                <button class="btn secondary" onclick="showAdminPanel()">Back to Admin</button>
            </div>

            <h2 class="section-title">Delete Member Account</h2>
            
            <div class="info-card" style="border-left-color: #dc3545;">
                <h3 style="color: #dc3545;">Warning: This action cannot be undone</h3>
                <div class="form-group">
                    <label for="deleteJCId">Member JC ID to Delete</label>
                    <input type="text" id="deleteJCId" placeholder="Enter JC ID to delete">
                </div>
                <button class="btn" style="background: #dc3545;" onclick="confirmDeleteMember()">Delete Member Account</button>
                <div id="deleteResult" style="margin-top: 10px;"></div>
            </div>
        </div>

        <!-- NEW Voucher Management Section -->
        <div id="voucherManagementSection" class="card hidden">
            <div class="nav-buttons">
                <button class="btn secondary" onclick="showAdminPanel()">Back to Admin</button>
                <button class="btn" onclick="refreshVouchers()">Refresh Vouchers</button>
            </div>

            <h2 class="section-title">Voucher Management</h2>
            
            <div class="info-card">
                <h3>All Vouchers</h3>
                <div id="allVouchersList" class="activity-log">
                    <div class="activity-item">Loading all vouchers...</div>
                </div>
            </div>

            <div class="info-card">
                <h3>Voucher Statistics</h3>
                <div id="voucherStats" style="margin-top: 10px;">
                    Loading voucher statistics...
                </div>
            </div>
        </div>

        <!-- QR Code Redemption Section -->
        <div id="qrRedemptionSection" class="card hidden">
            <div class="nav-buttons">
                <button class="btn secondary" onclick="showDashboard(clubManager.currentMember)">‚Üê Back to Dashboard</button>
            </div>
            
            <h2 class="section-title">üéüÔ∏è QR Code Redemption</h2>
            
            <div class="content-grid" style="display: grid; gap: 20px; margin-top: 20px;">
                <div class="info-card">
                    <h3>Step 1: Enter Purchase Amount</h3>
                    <div class="form-group">
                        <label for="qrPurchaseAmount">Purchase Amount (UGX):</label>
                        <input type="number" id="qrPurchaseAmount" placeholder="Enter purchase amount">
                        <button class="btn" onclick="calculateRedemptionOptions()" style="width: 100%; margin-top: 10px;">
                            Calculate Redemption Options
                        </button>
                    </div>
                </div>
                
                <div class="info-card">
                    <h3>Step 2: Choose Redemption Option</h3>
                    <div id="redemptionOptions">
                        <div class="info-card">
                            <p>Enter a purchase amount to see available redemption options based on your tier.</p>
                        </div>
                    </div>
                </div>
                
                <div class="info-card">
                    <h3>Step 3: Selected Option Details</h3>
                    <div id="selectedOptionDetails">
                        <div class="info-card">
                            <p>No option selected yet.</p>
                        </div>
                    </div>
                </div>
                
                <div class="info-card">
                    <h3>Step 4: Generate QR Code</h3>
                    <div id="qrCodeContainer">
                        <div class="info-card">
                            <p>Select a redemption option to generate QR code.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="qrRedemptionResult" style="margin-top: 20px;"></div>
        </div>

        <!-- QR Redemption Management Section -->
        <div id="qrRedemptionManagementSection" class="card hidden">
            <div class="nav-buttons">
                <button class="btn secondary" onclick="showAdminPanel()">‚Üê Back to Admin</button>
            </div>
            
            <h2 class="section-title">üìä QR Redemption Management</h2>
            
            <div class="card">
                <h3>Redemption Statistics</h3>
                <div id="qrRedemptionStats"></div>
            </div>
            
            <div class="card">
                <h3>All Redemptions</h3>
                <div id="allRedemptionsList" class="activity-log"></div>
            </div>
        </div>

      <!-- QR Code Section -->
<div class="card qr-share-section" style="text-align: center; margin-top: 20px;">
    <h3 style="color: #333; margin-bottom: 20px;">Share Jeans Club</h3>
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://elijah787.github.io/jeans-club" 
         alt="QR Code for Jeans Club"
         style="border: 2px solid #ddd; border-radius: 10px; padding: 10px; display: block; margin: 0 auto;">
    <p style="color: #666; margin-top: 15px;">Scan to share with friends</p>
</div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Jeans Club</h3>
                <p>Premium denim loyalty program with tiered privileges and exclusive benefits for our valued members.</p>
                <p><strong>Earn 1 point per 1,000 UGX | Redeem 1 point for 250 UGX discount</strong></p>
                <p>Raised on Denim, Elevated by Experience.</p>
                <div class="social-links">
                    <a href="https://www.tiktok.com/@jeansclubug?_r=1&_t=ZM-91wJ0p98EMG" target="_blank" class="social-link social-tiktok">
                        <span>üéµ</span> TikTok
                    </a>
                    <a href="https://www.instagram.com/jeans_club_ug?igsh=NmFkNTI5MDYzMTZk" target="_blank" class="social-link social-instagram">
                        <span>üì∏</span> Instagram
                    </a>
                    <a href="https://x.com/jeansclub_ug?s=20" target="_blank" class="social-link social-x">
                        <span>ùïè</span> X
                    </a>
                </div>
            </div>
            
            <div class="footer-section">
                <h3>Quick Links</h3>
                <p><a href="#" onclick="showSignupScreen()" style="color: #999; text-decoration: none;">Sign Up</a></p>
                <p><a href="#" onclick="showLoginScreen()" style="color: #999; text-decoration: none;">Login</a></p>
                <p><a href="#" onclick="showBenefits()" style="color: #999; text-decoration: none;">Benefits</a></p>
                <p><a href="#" onclick="showTiers()" style="color: #999; text-decoration: none;">Tiers</a></p>
            </div>
            
            <div class="footer-section">
                <h3>Contact</h3>
                <p>Email: oliviakamukama@gmail.com</p>
                <p>Phone: +256 772558913</p>
                <p>Hours: Mon-Saturday 8AM-9PM</p>
                <p>üìç Kampala, Uganda</p>
            </div>
            
            <div class="footer-section">
                <h3>Points System</h3>
                <p><strong>Earn:</strong> 1 point per 1,000 UGX spent</p>
                <p><strong>Redeem:</strong> 1 point = 250 UGX discount</p>
                <p>Higher tiers earn points faster</p>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2026 Jeans Club. All rights reserved. | Premium Denim Loyalty Program | Earn 1 point per 1,000 UGX | 1 point = 250 UGX discount</p>
        </div>
    </footer>

    <script>
        // ===========================
        // GLOBAL VARIABLE DECLARATIONS
        // ===========================
        
        let voucherSystem;
        let qrRedemptionSystem;
        let clubManager;
        
        // ===========================
        // NEW IMPROVED CAMERA SCANNER FUNCTIONALITY
        // ===========================
        
        let scannerStream = null;
        let scannerScanning = false;
        let scannerFacingMode = 'environment';
        let scannerCameras = [];
        let scannerCanvasContext = null;

        // Open camera scanner
        function openCameraScanner() {
            if (!clubManager.isAdmin) {
                showToast("Please login as staff first", "error");
                return;
            }

            const modal = document.getElementById('cameraScannerModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Initialize scanner
            initScanner();
        }

        // Initialize scanner
        async function initScanner() {
            try {
                // Get canvas context
                const canvas = document.getElementById('cameraCanvas');
                scannerCanvasContext = canvas.getContext('2d');
                
                // Get available cameras
                await getAvailableCameras();
                
                // Set up event listeners
                document.getElementById('startScannerBtn').onclick = startScanner;
                document.getElementById('stopScannerBtn').onclick = stopScanner;
                document.getElementById('switchCameraBtn').onclick = switchScannerCamera;
                document.getElementById('cameraSelect').onchange = handleCameraSelectChange;
                
                // Update status
                updateScannerStatus('Click Start Scanner to begin', false);
                
            } catch (error) {
                console.error("Scanner initialization error:", error);
                updateScannerStatus("Scanner initialization failed: " + error.message, false);
            }
        }

        // Get available cameras
        async function getAvailableCameras() {
            try {
                // First get permission to access cameras
                await navigator.mediaDevices.getUserMedia({ video: true });
                
                // Then enumerate devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                // Clear previous options
                const cameraSelect = document.getElementById('cameraSelect');
                cameraSelect.innerHTML = '<option value="">Select Camera</option>';
                
                // Add camera options
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
                scannerCameras = videoDevices;
                
                // Auto-select first camera
                if (videoDevices.length > 0) {
                    cameraSelect.value = videoDevices[0].deviceId;
                }
                
            } catch (error) {
                console.error("Error getting cameras:", error);
                updateScannerStatus("Could not access camera: " + error.message, false);
            }
        }

        // Start scanner
        async function startScanner() {
            try {
                if (scannerScanning) return;
                
                const cameraSelect = document.getElementById('cameraSelect');
                const selectedDeviceId = cameraSelect.value;
                
                // Stop any existing stream
                if (scannerStream) {
                    scannerStream.getTracks().forEach(track => track.stop());
                }
                
                // Constraints for video stream
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: selectedDeviceId ? undefined : scannerFacingMode
                    }
                };
                
                // If a specific device is selected, use it
                if (selectedDeviceId) {
                    constraints.video.deviceId = { exact: selectedDeviceId };
                }
                
                // Get video stream
                scannerStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('cameraVideo');
                video.srcObject = scannerStream;
                
                // Wait for video to load
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
                // Set canvas dimensions
                const canvas = document.getElementById('cameraCanvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Update UI
                document.getElementById('startScannerBtn').disabled = true;
                document.getElementById('stopScannerBtn').disabled = false;
                scannerScanning = true;
                
                updateScannerStatus('Scanner active - Point at QR code', true);
                
                // Start scanning loop
                scanQRCode();
                
            } catch (error) {
                console.error("Error starting scanner:", error);
                updateScannerStatus("Failed to start scanner: " + error.message, false);
                showToast("Camera error: " + error.message, "error");
            }
        }

        // Stop scanner
        function stopScanner() {
            scannerScanning = false;
            
            // Stop video stream
            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }
            
            // Clear video source
            const video = document.getElementById('cameraVideo');
            video.srcObject = null;
            
            // Update UI
            document.getElementById('startScannerBtn').disabled = false;
            document.getElementById('stopScannerBtn').disabled = true;
            
            updateScannerStatus('Scanner stopped', false);
        }

        // Switch camera
        function switchScannerCamera() {
            if (!scannerScanning) return;
            
            // Toggle facing mode
            scannerFacingMode = scannerFacingMode === 'environment' ? 'user' : 'environment';
            
            // Restart scanner with new facing mode
            stopScanner();
            setTimeout(startScanner, 500);
        }

        // Handle camera select change
        function handleCameraSelectChange() {
            if (scannerScanning) {
                // Restart with selected camera
                stopScanner();
                setTimeout(startScanner, 500);
            }
        }

        // Scan for QR codes
        function scanQRCode() {
            if (!scannerScanning) return;
            
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                // Draw video frame to canvas
                scannerCanvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Get image data from canvas
                const imageData = scannerCanvasContext.getImageData(0, 0, canvas.width, canvas.height);
                
                // Try to decode QR code
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                // If QR code found
                if (code) {
                    handleQRCodeDetected(code.data);
                    
                    // Draw rectangle around QR code
                    scannerCanvasContext.strokeStyle = '#28a745';
                    scannerCanvasContext.lineWidth = 4;
                    scannerCanvasContext.strokeRect(
                        code.location.topLeftCorner.x,
                        code.location.topLeftCorner.y,
                        code.location.bottomRightCorner.x - code.location.topLeftCorner.x,
                        code.location.bottomRightCorner.y - code.location.topLeftCorner.y
                    );
                }
            }
            
            // Continue scanning
            if (scannerScanning) {
                requestAnimationFrame(scanQRCode);
            }
        }

        
        // Handle detected QR code
async function handleQRCodeDetected(qrData) {
    console.log("QR Code detected:", qrData);
    
    // Stop scanner immediately
    scannerScanning = false;
    
    // Update result display
    const resultElement = document.getElementById('scannerResult');
    if (resultElement) {
        resultElement.textContent = qrData;
        resultElement.style.backgroundColor = '#d4edda';
        resultElement.style.color = '#155724';
        resultElement.style.borderColor = '#28a745';
        resultElement.style.fontWeight = 'bold';
        resultElement.style.padding = '15px';
        resultElement.style.whiteSpace = 'pre-wrap';
        resultElement.style.wordBreak = 'break-word';
        resultElement.classList.remove('hidden');
        
        const scannerResults = document.querySelector('.scanner-results');
        if (scannerResults) {
            scannerResults.style.display = 'block';
            scannerResults.style.visibility = 'visible';
            scannerResults.style.opacity = '1';
            scannerResults.classList.remove('hidden');
        }
    }
    
    // Play scan beep sound
    playScanBeep();
    
    // Show success message
    updateScannerStatus('QR Code detected! Processing...', true);
    
    // Close scanner and redirect to admin panel
    setTimeout(() => {
        closeCameraScanner();
        showAdminPanel();
        
        // Focus on salesperson name field
        setTimeout(() => {
            const salespersonInput = document.getElementById('salespersonName');
            if (salespersonInput) {
                salespersonInput.focus();
                salespersonInput.select();
            }
            
            // Fill the voucher code input with scanned data
            const voucherInput = document.getElementById('voucherCodeInput');
            if (voucherInput) {
                voucherInput.value = qrData;
            }
            
            showToast("QR code scanned! Please enter your name and click 'Process Scan'", "info");
        }, 500);
    }, 1000);
}

        // Play scan beep sound
        function playScanBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                // Sound not critical
            }
        }

        // Update scanner status
        function updateScannerStatus(message, active) {
            const statusElement = document.getElementById('scanStatus');
            statusElement.textContent = message;
            statusElement.className = 'scan-status' + (active ? ' active' : '');
        }

        // Close camera scanner
        function closeCameraScanner() {
            const modal = document.getElementById('cameraScannerModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
            
            stopScanner();
        }

        // ===========================
        // VOUCHER SYSTEM IMPLEMENTATION - FIXED VERSION
        // ===========================
        
        class VoucherSystem {
            constructor() {
                this.vouchers = JSON.parse(localStorage.getItem('jeansClubVouchers') || '[]');
                this.voucherActivity = JSON.parse(localStorage.getItem('jeansClubVoucherActivity') || '[]');
                this.cleanupInterval = null;
                this.startAutoCleanup();
            }

            startAutoCleanup() {
                // Cleanup expired vouchers on startup
                this.cleanupExpiredVouchers();
                
                // Schedule cleanup every 24 hours
                this.cleanupInterval = setInterval(() => {
                    this.cleanupExpiredVouchers();
                }, 24 * 60 * 60 * 1000);
            }

            cleanupExpiredVouchers() {
                const now = new Date();
                const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                
                // Filter out vouchers that expired more than 30 days ago
                const originalCount = this.vouchers.length;
                this.vouchers = this.vouchers.filter(voucher => {
                    if (voucher.status === 'expired') {
                        const expiryDate = new Date(voucher.expiryDate);
                        return expiryDate > thirtyDaysAgo; // Keep if expired less than 30 days ago
                    }
                    return true; // Keep active and used vouchers
                });
                
                const removedCount = originalCount - this.vouchers.length;
                if (removedCount > 0) {
                    this.saveVouchers();
                    console.log(`Cleaned up ${removedCount} old expired vouchers`);
                }
            }

            generateVoucherCode() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let code = '';
                for (let i = 0; i < 8; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return 'JC' + code;
            }

            generateQRCodeData(voucherCode) {
                // SIMPLE TEXT ONLY - No JSON, no encryption
                return voucherCode;
            }

            async createVoucher(memberJCId, memberName, pointsUsed, discountPercentage, expiryDays = 30) {
                const voucherCode = this.generateVoucherCode();
                const createdDate = new Date();
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + expiryDays);

                const voucher = {
                    id: 'voucher_' + Date.now(),
                    code: voucherCode,
                    memberJCId: memberJCId,
                    memberName: memberName,
                    pointsUsed: pointsUsed,
                    discountPercentage: discountPercentage,
                    createdDate: createdDate.toISOString(),
                    expiryDate: expiryDate.toISOString(),
                    status: 'active',
                    usedDate: null,
                    qrCodeData: this.generateQRCodeData(voucherCode)
                };

                this.vouchers.push(voucher);
                this.saveVouchers();
                
                // üî• FIXED: Save to Supabase - wait for it to complete
                await this.saveVoucherToSupabase(voucher);

                this.logVoucherActivity(voucherCode, 'created', memberJCId, `Voucher created: ${discountPercentage}% discount`);

                return voucher;
            }

            getMemberVouchers(memberJCId) {
                return this.vouchers.filter(v => v.memberJCId === memberJCId)
                    .sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));
            }

            getAllVouchers() {
                return this.vouchers.sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));
            }

            async getVoucherByCode(code) {
                // First check local storage
                let voucher = this.vouchers.find(v => v.code === code);
                
                // If not found locally, try Supabase
                if (!voucher) {
                    voucher = await this.getVoucherFromSupabase(code);
                    if (voucher) {
                        // Add to local cache
                        this.vouchers.push(voucher);
                        this.saveVouchers();
                    }
                }
                
                return voucher;
            }

            async redeemVoucher(voucherCode, redeemedBy = 'system') {
                let voucher = await this.getVoucherByCode(voucherCode);
                if (!voucher) {
                    return { success: false, message: "Voucher not found" };
                }

                if (voucher.status === 'used') {
                    return { success: false, message: "Voucher has already been used" };
                }

                if (voucher.status === 'expired') {
                    return { success: false, message: "Voucher has expired" };
                }

                if (new Date() > new Date(voucher.expiryDate)) {
                    voucher.status = 'expired';
                    this.saveVouchers();
                    await this.saveVoucherToSupabase(voucher); // üî• FIXED: Wait for save
                    return { success: false, message: "Voucher has expired" };
                }

                voucher.status = 'used';
                voucher.usedDate = new Date().toISOString();
                voucher.redeemedBy = redeemedBy;
                this.saveVouchers();
                
                // üî• FIXED: Also update in Supabase - wait for it
                await this.saveVoucherToSupabase(voucher);

                this.logVoucherActivity(voucherCode, 'redeemed', voucher.memberJCId, `Voucher redeemed by ${redeemedBy}`);

                return { 
                    success: true, 
                    message: `Voucher redeemed successfully! ${voucher.discountPercentage}% discount applied.`,
                    voucher: voucher
                };
            }

            updateVoucherStatuses() {
                const now = new Date();
                let updated = false;

                this.vouchers.forEach(voucher => {
                    if (voucher.status === 'active' && new Date(voucher.expiryDate) < now) {
                        voucher.status = 'expired';
                        updated = true;
                    }
                });

                if (updated) {
                    this.saveVouchers();
                }
            }

            getVoucherStats() {
                this.updateVoucherStatuses();
                
                const total = this.vouchers.length;
                const active = this.vouchers.filter(v => v.status === 'active').length;
                const used = this.vouchers.filter(v => v.status === 'used').length;
                const expired = this.vouchers.filter(v => v.status === 'expired').length;
                
                const totalDiscount = this.vouchers
                    .filter(v => v.status === 'used')
                    .reduce((sum, v) => sum + v.discountPercentage, 0);
                
                const avgDiscount = used > 0 ? (totalDiscount / used).toFixed(1) : 0;

                return {
                    total,
                    active,
                    used,
                    expired,
                    avgDiscount,
                    redemptionRate: total > 0 ? ((used / total) * 100).toFixed(1) + '%' : '0%'
                };
            }

            logVoucherActivity(voucherCode, action, memberJCId, description) {
                const activity = {
                    timestamp: new Date().toISOString(),
                    voucherCode: voucherCode,
                    action: action,
                    memberJCId: memberJCId,
                    description: description
                };

                this.voucherActivity.unshift(activity);
                if (this.voucherActivity.length > 100) {
                    this.voucherActivity = this.voucherActivity.slice(0, 100);
                }
                localStorage.setItem('jeansClubVoucherActivity', JSON.stringify(this.voucherActivity));
            }

            saveVouchers() {
                localStorage.setItem('jeansClubVouchers', JSON.stringify(this.vouchers));
            }
            
            // üî• FIXED: Save voucher to Supabase with snake_case column names
            // Replace the ENTIRE saveVoucherToSupabase method with this:
async saveVoucherToSupabase(voucher) {
    try {
        console.log("üíæ Saving voucher to Supabase:", voucher.code);
        
        if (!window.supabaseDbInstance) {
            console.error("‚ùå Supabase DB not initialized");
            return false;
        }
        
        const { supabase } = window.supabaseDbInstance;
        
        // Convert to snake_case for Supabase
        const voucherData = {
            id: voucher.id,
            code: voucher.code,
            member_jc_id: voucher.memberJCId,
            member_name: voucher.memberName,
            points_used: voucher.pointsUsed,
            discount_percentage: voucher.discountPercentage,
            created_date: voucher.createdDate,
            expiry_date: voucher.expiryDate,
            status: voucher.status,
            used_date: voucher.usedDate,
            redeemed_by: voucher.redeemedBy,
            qr_code_data: voucher.qrCodeData
        };

        console.log("üì§ Voucher data for Supabase:", voucherData);

        const { data, error } = await supabase
            .from('vouchers')
            .upsert(voucherData, { 
                onConflict: 'code'
            });

        if (error) {
            console.error("‚ùå Supabase voucher save error:", error);
            return false;
        }

        console.log("‚úÖ Voucher saved to Supabase:", voucher.code);
        return true;

    } catch (error) {
        console.error("‚ùå Failed to save voucher to Supabase:", error);
        return false;
    }
}

// Replace the ENTIRE getVoucherFromSupabase method with this:
async getVoucherFromSupabase(code) {
    try {
        if (!window.supabaseDbInstance) {
            console.error("‚ùå Supabase DB not initialized");
            return null;
        }
        
        const { supabase } = window.supabaseDbInstance;
        
        const { data: voucher, error } = await supabase
            .from('vouchers')
            .select('*')
            .eq('code', code)
            .single();

        if (error) {
            if (error.code === 'PGRST116') {
                return null;
            }
            console.error("‚ùå Supabase voucher fetch error:", error);
            return null;
        }

        // Convert snake_case back to camelCase for app
        if (voucher) {
            return {
                id: voucher.id,
                code: voucher.code,
                memberJCId: voucher.member_jc_id,
                memberName: voucher.member_name,
                pointsUsed: voucher.points_used,
                discountPercentage: voucher.discount_percentage,
                createdDate: voucher.created_date,
                expiryDate: voucher.expiry_date,
                status: voucher.status,
                usedDate: voucher.used_date,
                redeemedBy: voucher.redeemed_by,
                qrCodeData: voucher.qr_code_data
            };
        }
        
        return null;
    } catch (error) {
        console.error("‚ùå Failed to fetch voucher from Supabase:", error);
        return null;
    }
}
                  
            
            // üî• NEW: Create vouchers table if it doesn't exist
            async createVouchersTable() {
                try {
                    const sql = `
                        CREATE TABLE IF NOT EXISTS vouchers (
                            id TEXT PRIMARY KEY,
                            code TEXT UNIQUE NOT NULL,
                            member_jc_id TEXT NOT NULL,
                            member_name TEXT NOT NULL,
                            points_used INTEGER NOT NULL,
                            discount_percentage DECIMAL(5,2) NOT NULL,
                            created_date TIMESTAMP WITH TIME ZONE NOT NULL,
                            expiry_date TIMESTAMP WITH TIME ZONE NOT NULL,
                            status TEXT NOT NULL CHECK (status IN ('active', 'used', 'expired')),
                            used_date TIMESTAMP WITH TIME ZONE,
                            redeemed_by TEXT,
                            qr_code_data TEXT,
                            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                        );
                    `;
                    
                    console.log("üìä Creating vouchers table...");
                    // Note: In production, you'd need to run this SQL in Supabase dashboard
                    // For now, just show the SQL
                    alert(`Please run this SQL in your Supabase SQL Editor:\n\n${sql}`);
                    
                    return false; // Table creation needs manual intervention
                } catch (error) {
                    console.error("‚ùå Failed to create vouchers table:", error);
                    return false;
                }
            }
    
         } 

        // Import Supabase
        const { createClient } = supabase;

        // Supabase Database Manager - FIXED VERSION
        class SupabaseDB {
            constructor() {
                this.supabaseUrl = 'https://uoyzsyxjrfygrsfzhlao.supabase.co';
                this.anonKey = 'sb_publishable__gS2-Pd9S7I5dBlq4rmzMQ_K2QMwovA';
                
                this.supabase = createClient(this.supabaseUrl, this.anonKey);
                this.cacheKey = 'jeansClubCache';
                this.init();
                console.log('üöÄ SupabaseDB initialized with URL:', this.supabaseUrl);
                
                // Store globally for easy access
                window.supabaseDbInstance = this;
            }

            async init() {
                if (!this.getCache()) {
                    this.setCache({ members: [], lastSync: 0 });
                }
            }

            getCache() {
                try {
                    const cache = localStorage.getItem(this.cacheKey);
                    return cache ? JSON.parse(cache) : null;
                } catch (error) {
                    console.error('Error reading cache:', error);
                    return null;
                }
            }

            setCache(data) {
                try {
                    localStorage.setItem(this.cacheKey, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Error writing to storage:', error);
                    return false;
                }
            }

            async getAllMembers() {
    try {
        console.log('üîÑ Fetching all members from Supabase...');
        
        const { data: members, error } = await this.supabase
            .from('members')
            .select('*');

        if (error) {
            console.error('‚ùå Supabase error:', error);
            throw error;
        }

        console.log(`‚úÖ Loaded ${members?.length || 0} members from Supabase`);
        
        // Transform all members from snake_case to camelCase
        const transformedMembers = members ? members.map(member => ({
            ...member,
            jcId: member.jc_id,
            referralCode: member.referral_code,
            referredBy: member.referred_by,
            joinedDate: member.joined_date,
            totalSpent: member.total_spent,
            newsletterSubscribed: member.newsletter_subscribed,
            ip_address: member.ip_address,
            lastLogin: member.last_login,
            createdAt: member.created_at,
            
            // Parse JSON fields
            purchaseHistory: member.purchasehistory ? JSON.parse(member.purchasehistory) : [],
            activityLog: member.activitylog ? JSON.parse(member.activitylog) : [],
            challenges: member.challenges ? JSON.parse(member.challenges) : [],
            referrals: member.referrals ? JSON.parse(member.referrals) : []
        })) : [];

        this.setCache({
            members: transformedMembers,
            lastSync: Date.now()
        });

        return transformedMembers;

    } catch (error) {
        console.error('‚ùå Failed to fetch from Supabase, using cache:', error);
        const cache = this.getCache();
        return cache?.members || [];
    }
}

           
          async saveMember(member) {
    try {
        console.log('üíæ Saving member to Supabase:', member.jcId);
        
        // Map your app's camelCase to Supabase's snake_case EXACTLY
        const memberData = {
            id: member.id || 'member_' + Date.now(),
            jc_id: member.jcId,
            email: member.email,
            normalized_email: normalizeEmailForDatabase(member.email),
            name: member.name,
            password: member.password || null,
            
            // Note: You DON'T have googleid column - remove it
            // googleid: member.googleId || null,
            
            // Note: You DON'T have loginmethod column - remove it
            // loginmethod: member.loginMethod || 'email',
            
            points: member.points || 0,
            tier: member.tier || 'PEARL',
            referral_code: member.referralCode,  // snake_case
            referred_by: member.referredBy || null,  // snake_case
            joined_date: member.joinedDate || new Date().toISOString(),  // snake_case
            total_spent: member.totalSpent || 0,  // snake_case
            newsletter_subscribed: member.newsletterSubscribed !== false,
            
            // JSON fields - must be stringified
            purchasehistory: JSON.stringify(member.purchaseHistory || []),
            activitylog: JSON.stringify(member.activityLog || []),
            challenges: JSON.stringify(member.challenges || []),
            referrals: JSON.stringify(member.referrals || []),
            
            resettoken: member.resetToken || null,
            resettokenexpiry: member.resetTokenExpiry || null,
            ip_address: member.ip_address || 'unknown',
            last_login: member.lastLogin || null,
            created_at: member.createdAt || new Date().toISOString()
        };

        console.log('üì§ Saving with EXACT column names:', memberData);

        const { data, error } = await this.supabase
            .from('members')
            .upsert(memberData, { 
                onConflict: 'jc_id'
            });

        if (error) {
            console.error('‚ùå Supabase save error:', error);
            throw error;
        }

        console.log('‚úÖ Member saved successfully to Supabase');
        
        // Update cache
        const cache = this.getCache();
        if (cache) {
            cache.lastSync = 0;
            this.setCache(cache);
        }

        return true;

    } catch (error) {
        console.error('‚ùå Failed to save member to Supabase:', error);
        return false;
    }
}
                   

async deleteMember(jcId) {
    try {
        console.log('üóëÔ∏è Deleting member from Supabase:', jcId);
        
        // Use jc_id (snake_case) not jcId
        const { error } = await this.supabase
            .from('members')
            .delete()
            .eq('jc_id', jcId);  // Changed from 'jcId' to 'jc_id'

        if (error) {
            console.error('‚ùå Supabase delete error:', error);
            throw error;
        }

        console.log('‚úÖ Member deleted successfully from Supabase');
        
        // Also delete from newsletter subscriptions
        try {
            // First get the member to find their email
            const member = await this.getMemberByJCId(jcId);
            if (member && member.email) {
                await this.supabase
                    .from('newsletter_subscriptions')
                    .delete()
                    .eq('email', member.email);
            }
        } catch (newsletterError) {
            console.log('‚ö†Ô∏è Could not delete from newsletter subscriptions:', newsletterError);
            // Continue anyway
        }
        
        // Update cache
        const cache = this.getCache();
        if (cache) {
            cache.lastSync = 0;
            this.setCache(cache);
        }

        return true;

    } catch (error) {
        console.error('‚ùå Failed to delete member from Supabase:', error);
        return false;
    }
}
             async getMemberByJCId(jcId) {
    try {
        console.log('üîç Fetching member from Supabase:', jcId);
        
        const { data: member, error } = await this.supabase
            .from('members')
            .select('*')
            .eq('jc_id', jcId)
            .single();

        if (error && error.code !== 'PGRST116') {
            console.error('‚ùå Supabase fetch error:', error);
            throw error;
        }

        if (member) {
            // Map snake_case back to camelCase for your app
            return {
                ...member,
                // Map columns
                jcId: member.jc_id,
                referralCode: member.referral_code,
                referredBy: member.referred_by,
                joinedDate: member.joined_date,
                totalSpent: member.total_spent,
                newsletterSubscribed: member.newsletter_subscribed,
                ip_address: member.ip_address,
                lastLogin: member.last_login,
                createdAt: member.created_at,
                
                // Parse JSON fields
                purchaseHistory: member.purchasehistory ? JSON.parse(member.purchasehistory) : [],
                activityLog: member.activitylog ? JSON.parse(member.activitylog) : [],
                challenges: member.challenges ? JSON.parse(member.challenges) : [],
                referrals: member.referrals ? JSON.parse(member.referrals) : []
            };
        }
        
        return null;
    } catch (error) {
        console.error('‚ùå Failed to fetch member from Supabase:', error);
        
        // Fallback to cache
        const cache = this.getCache();
        if (cache?.members) {
            return cache.members.find(m => m.jcId === jcId) || null;
        }
        
        return null;
    }
}

            async getMemberByEmail(email) {
    try {
        console.log('üîç Fetching member by email from Supabase:', email);
        
        const { data: member, error } = await this.supabase
            .from('members')
            .select('*')
            .eq('normalized_email', normalizeEmailForDatabase(email))
            .single();

        if (error && error.code !== 'PGRST116') {
            console.error('‚ùå Supabase fetch error:', error);
            throw error;
        }

        if (member) {
            // Map snake_case back to camelCase
            return {
                ...member,
                jcId: member.jc_id,
                referralCode: member.referral_code,
                referredBy: member.referred_by,
                joinedDate: member.joined_date,
                totalSpent: member.total_spent,
                newsletterSubscribed: member.newsletter_subscribed,
                ip_address: member.ip_address,
                lastLogin: member.last_login,
                createdAt: member.created_at,
                
                // Parse JSON fields
                purchaseHistory: member.purchasehistory ? JSON.parse(member.purchasehistory) : [],
                activityLog: member.activitylog ? JSON.parse(member.activitylog) : [],
                challenges: member.challenges ? JSON.parse(member.challenges) : [],
                referrals: member.referrals ? JSON.parse(member.referrals) : []
            };
        }
        
        return null;
    } catch (error) {
        console.error('‚ùå Failed to fetch member by email from Supabase:', error);
        
        // Fallback to cache
        const cache = this.getCache();
        if (cache?.members) {
            return cache.members.find(m => normalizeEmailForDatabase(m.email) === normalizeEmailForDatabase(email)) || null;
        }
        
        return null;
    }
}

            async subscribeToNewsletter(email, name = null) {
                try {
                    console.log('üìß Subscribing to newsletter:', email);
                    
                    const { data, error } = await this.supabase
                        .from('newsletter_subscriptions')
                        .upsert({
                            email: email,
                            normalized_email: normalizeEmailForDatabase(email), // NEW: Store normalized
                            name: name,
                            is_active: true,
                            subscribed_at: new Date().toISOString(),
                            last_sent: null
                        }, { 
                            onConflict: 'email'
                        });

                    if (error) {
                        console.error('‚ùå Newsletter subscription error:', error);
                        throw error;
                    }

                    console.log('‚úÖ Newsletter subscription successful');
                    return true;

                } catch (error) {
                    console.error('‚ùå Failed to subscribe to newsletter:', error);
                    return false;
                }
            }

            async unsubscribeFromNewsletter(email) {
                try {
                    console.log('üìß Unsubscribing from newsletter:', email);
                    
                    const { data, error } = await this.supabase
                        .from('newsletter_subscriptions')
                        .update({ 
                            is_active: false,
                            unsubscribed_at: new Date().toISOString()
                        })
                        .eq('email', email);

                    if (error) {
                        console.error('‚ùå Newsletter unsubscribe error:', error);
                        throw error;
                    }

                    console.log('‚úÖ Newsletter unsubscribe successful');
                    return true;

                } catch (error) {
                    console.error('‚ùå Failed to unsubscribe from newsletter:', error);
                    return false;
                }
            }

            async getNewsletterSubscribers(activeOnly = true) {
                try {
                    let query = this.supabase
                        .from('newsletter_subscriptions')
                        .select('*');

                    if (activeOnly) {
                        query = query.eq('is_active', true);
                    }

                    const { data: subscribers, error } = await query;

                    if (error) {
                        console.error('‚ùå Newsletter fetch error:', error);
                        throw error;
                    }

                    return subscribers || [];

                } catch (error) {
                    console.error('‚ùå Failed to fetch newsletter subscribers:', error);
                    return [];
                }
            }

            async getNewsletterStatus(email) {
                try {
                    const { data: subscription, error } = await this.supabase
                        .from('newsletter_subscriptions')
                        .select('is_active')
                        .eq('email', email)
                        .single();

                    if (error && error.code !== 'PGRST116') {
                        console.error('‚ùå Newsletter status error:', error);
                        throw error;
                    }

                    return subscription ? subscription.is_active : false;

                } catch (error) {
                    console.error('‚ùå Failed to get newsletter status:', error);
                    return false;
                }
            }
            
            // üî• FIXED: Save redemption to Supabase with snake_case column names
       
            
// Replace the ENTIRE saveRedemptionToSupabase method with this:
async saveRedemptionToSupabase(redemption) {
    try {
        console.log("üíæ Saving redemption to Supabase:", redemption.redemptionId);
        
        const redemptionData = {
            id: redemption.redemptionId,
            redemption_id: redemption.redemptionId,
            member_jc_id: redemption.memberJCId,
            member_name: redemption.memberName,
            member_tier: redemption.memberTier,
            purchase_amount: redemption.purchaseAmount,
            selected_option: redemption.selectedOption,
            created_date: redemption.createdDate,
            status: redemption.status,
            redeemed_by: redemption.redeemedBy,
            redeemed_date: redemption.redeemedDate,
            qr_code_data: redemption.qrCodeData
        };

        console.log("üì§ Redemption data for Supabase:", redemptionData);

        const { data, error } = await this.supabase
            .from('redemptions')
            .upsert(redemptionData, { 
                onConflict: 'redemption_id'
            });

        if (error) {
            console.error("‚ùå Supabase redemption save error:", error);
            return false;
        }

        console.log("‚úÖ Redemption saved to Supabase:", redemption.redemptionId);
        return true;

    } catch (error) {
        console.error("‚ùå Failed to save redemption to Supabase:", error);
        return false;
    }
}
            // üî• NEW: Create redemptions table if it doesn't exist
            async createRedemptionsTable() {
                try {
                    const sql = `
                        CREATE TABLE IF NOT EXISTS redemptions (
                            id TEXT PRIMARY KEY,
                            redemption_id TEXT UNIQUE NOT NULL,
                            member_jc_id TEXT NOT NULL,
                            member_name TEXT NOT NULL,
                            member_tier TEXT NOT NULL,
                            purchase_amount DECIMAL(10,2) NOT NULL,
                            selected_option JSONB,
                            created_date TIMESTAMP WITH TIME ZONE NOT NULL,
                            status TEXT NOT NULL CHECK (status IN ('pending', 'completed', 'expired')),
                            redeemed_by TEXT,
                            redeemed_date TIMESTAMP WITH TIME ZONE,
                            qr_code_data TEXT,
                            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                        );
                    `;
                    
                    console.log("üìä Creating redemptions table...");
                    alert(`Please run this SQL in your Supabase SQL Editor:\n\n${sql}`);
                    
                    return false; // Table creation needs manual intervention
                } catch (error) {
                    console.error("‚ùå Failed to create redemptions table:", error);
                    return false;
                }
            }
            
            // üî• FIXED: Get redemption from Supabase with snake_case column names
              // Replace the ENTIRE getRedemptionFromSupabase method with this:
async getRedemptionFromSupabase(redemptionId) {
    try {
        const { data: redemption, error } = await this.supabase
            .from('redemptions')
            .select('*')
            .eq('redemption_id', redemptionId)
            .single();

        if (error) {
            if (error.code === 'PGRST116') {
                return null;
            }
            console.error("‚ùå Supabase redemption fetch error:", error);
            return null;
        }

        // Convert snake_case back to camelCase for app
        if (redemption) {
            return {
                redemptionId: redemption.redemption_id,
                memberJCId: redemption.member_jc_id,
                memberName: redemption.member_name,
                memberTier: redemption.member_tier,
                purchaseAmount: redemption.purchase_amount,
                selectedOption: redemption.selected_option,
                createdDate: redemption.created_date,
                status: redemption.status,
                redeemedBy: redemption.redeemed_by,
                redeemedDate: redemption.redeemed_date,
                qrCodeData: redemption.qr_code_data
            };
        }
        
        return null;
    } catch (error) {
        console.error("‚ùå Failed to fetch redemption from Supabase:", error);
        return null;
    }
}

            
            // üî• FIXED: Get all redemptions from Supabase
           // Replace the ENTIRE getAllRedemptionsFromSupabase method with this:
async getAllRedemptionsFromSupabase() {
    try {
        const { data: redemptions, error } = await this.supabase
            .from('redemptions')
            .select('*')
            .order('created_date', { ascending: false });

        if (error) {
            console.error("‚ùå Supabase redemptions fetch error:", error);
            return [];
        }

        // Convert snake_case back to camelCase for app
        return redemptions.map(redemption => ({
            redemptionId: redemption.redemption_id,
            memberJCId: redemption.member_jc_id,
            memberName: redemption.member_name,
            memberTier: redemption.member_tier,
            purchaseAmount: redemption.purchase_amount,
            selectedOption: redemption.selected_option,
            createdDate: redemption.created_date,
            status: redemption.status,
            redeemedBy: redemption.redeemed_by,
            redeemedDate: redemption.redeemed_date,
            qrCodeData: redemption.qr_code_data
        }));
    } catch (error) {
        console.error("‚ùå Failed to fetch redemptions from Supabase:", error);
        return [];
    }
    }
                    
        }

        // ===========================================
        // NEW: FRAUD PREVENTION & EMAIL NORMALIZATION
        // ===========================================
        
        // List of disposable email domains to block
        const DISPOSABLE_EMAIL_DOMAINS = [
            'tempmail.com', 'mailinator.com', 'guerrillamail.com', '10minutemail.com',
            'yopmail.com', 'throwawaymail.com', 'fakeinbox.com', 'temp-mail.org',
            'sharklasers.com', 'trashmail.com', 'getairmail.com', 'maildrop.cc',
            'tempmailaddress.com', 'fake-mail.com', 'tempinbox.com', 'dispostable.com',
            'mailnesia.com', 'spam4.me', 'tempail.com', 'emailondeck.com',
            'tmpmail.org', 'mailmetrash.com', 'throwawayemailaddress.com', 'deadaddress.com',
            'mailnull.com', 'getnada.com', 'mailcatch.com', 'inboxalias.com',
            'spamgourmet.com', 'spamfree24.org', 'spambox.us', 'tempomail.fr',
            'mytemp.email', 'tempemail.net', 'disposable-email.ml', 'temp-mail.io'
        ];

        // Normalize email addresses to prevent Gmail tricks
        function normalizeEmailForDatabase(email) {
            if (!email || typeof email !== 'string') return '';
            
            // Convert to lowercase
            let normalized = email.trim().toLowerCase();
            
            // Handle googlemail.com = gmail.com
            normalized = normalized.replace('@googlemail.com', '@gmail.com');
            
            // Extract local part and domain
            const atIndex = normalized.indexOf('@');
            if (atIndex === -1) return normalized;
            
            const localPart = normalized.substring(0, atIndex);
            const domain = normalized.substring(atIndex + 1);
            
            // For Gmail addresses: remove dots and everything after +
            if (domain === 'gmail.com') {
                // Remove all dots
                let cleanLocal = localPart.replace(/\./g, '');
                // Remove everything after +
                const plusIndex = cleanLocal.indexOf('+');
                if (plusIndex !== -1) {
                    cleanLocal = cleanLocal.substring(0, plusIndex);
                }
                return cleanLocal + '@gmail.com';
            }
            
            // For other domains: keep as is but remove + trick
            const plusIndex = localPart.indexOf('+');
            if (plusIndex !== -1) {
                return localPart.substring(0, plusIndex) + '@' + domain;
            }
            
            return normalized;
        }

        // Check if email is disposable
        function isDisposableEmail(email) {
            if (!email || typeof email !== 'string') return true;
            
            const domain = email.split('@')[1]?.toLowerCase();
            if (!domain) return true;
            
            // Check against disposable domains list
            if (DISPOSABLE_EMAIL_DOMAINS.includes(domain)) {
                return true;
            }
            
            // Check for patterns common in disposable emails
            const disposablePatterns = [
                /^temp\./,
                /^tmp\./,
                /^fake\./,
                /^trash\./,
                /^spam\./,
                /^throwaway\./,
                /^disposable\./,
                /\.temp$/,
                /\.tmp$/,
                /\.mailinator\.[a-z]+$/,
                /\.yopmail\.[a-z]+$/,
                /\.10minutemail\.[a-z]+$/
            ];
            
            return disposablePatterns.some(pattern => pattern.test(domain));
        }

        // Enhanced email validation with fraud prevention
        function isValidEmailWithFraudPrevention(email) {
            // First do basic validation
            if (!isValidEmail(email)) {
                return { valid: false, message: "Please enter a valid email address" };
            }
            
            // Check if disposable
            if (isDisposableEmail(email)) {
                return { 
                    valid: false, 
                    message: "Temporary/disposable email addresses are not allowed. Please use your real email." 
                };
            }
            
            return { valid: true, message: "Email is valid" };
        }

        // Get client IP address (simplified version)
        async function getClientIP() {
            try {
                // Try to get IP from multiple sources
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip || 'unknown';
            } catch (error) {
                console.log('Could not fetch IP:', error);
                return 'unknown';
            }
        }

        // Check for self-referral
        function isSelfReferral(referralCode, userEmail) {
            if (!referralCode || !userEmail) return false;
            
            // Get all members from local storage first
            const cache = JSON.parse(localStorage.getItem('jeansClubCache') || '{}');
            const members = cache.members || [];
            
            // Find the referrer
            const referrer = members.find(m => m.referralCode === referralCode);
            if (!referrer) return false;
            
            // Check if email matches (after normalization)
            const normalizedReferrerEmail = normalizeEmailForDatabase(referrer.email);
            const normalizedUserEmail = normalizeEmailForDatabase(userEmail);
            
            return normalizedReferrerEmail === normalizedUserEmail;
        }

        // Check for multiple accounts from same IP (simplified)
        async function checkMultipleAccountsFromIP(email, ip) {
            if (ip === 'unknown') return { allowed: true, reason: '' };
            
            try {
                const allMembers = await clubManager.db.getAllMembers();
                const accountsFromSameIP = allMembers.filter(m => 
                    m.ip_address === ip && 
                    normalizeEmailForDatabase(m.email) !== normalizeEmailForDatabase(email)
                );
                
                if (accountsFromSameIP.length >= 3) {
                    return { 
                        allowed: false, 
                        reason: "Maximum account limit reached from this device/network. Contact support if this is an error." 
                    };
                }
                
                return { allowed: true, reason: '' };
            } catch (error) {
                console.error('Error checking multiple accounts:', error);
                return { allowed: true, reason: '' };
            }
        }

        // Google Apps Script Email Service - FIXED VERSION
        class GoogleAppsEmailService {
            constructor() {
                this.scriptURL = 'https://script.google.com/macros/s/AKfycbwPycPrQFn5hux5eHrbAg1KIc8aO96HwrEI-KUZG7YmITm1ACyqIDQJcWGP5pqq9kun/exec';
                this.isActive = true;
                console.log('üìß Email service initialized with URL:', this.scriptURL);
            }

            async sendEmailToGoogleScript(email, type, memberData, extraData = null) {
                try {
                    const emailContent = this.buildEmailContent(type, memberData, extraData);
                    const subject = this.getSubject(type, memberData, extraData);
                    
                    const payload = {
                        action: 'sendEmail',
                        emailData: {
                            email: email,
                            type: type,
                            subject: subject,
                            message: emailContent,
                            html: true
                        }
                    };

                    console.log('üì§ Sending email via Google Apps Script:', payload.emailData.type);
                    console.log('üîó Using URL:', this.scriptURL);

                    try {
                        const response = await fetch(this.scriptURL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log('‚úÖ Email sent successfully via Google Apps Script:', result);
                            return result;
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (fetchError) {
                        console.log('Direct fetch failed, trying with no-cors:', fetchError);
                        
                        await fetch(this.scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        console.log('‚úÖ Email request sent (no-cors fallback mode)');
                        return { 
                            success: true, 
                            message: 'Email sent successfully (fallback mode)',
                            fallback: true 
                        };
                    }
                    
                } catch (error) {
                    console.error('‚ùå All Google Apps Script email attempts failed:', error);
                    return this.fallbackEmail(email, memberData, type, extraData);
                }
            }

            buildEmailContent(type, memberData, extraData = null) {
                let content = '';
                
                switch(type) {
                    case 'welcome':
                        content = this.buildWelcomeEmail(memberData);
                        break;
                    case 'purchase':
                        content = this.buildPurchaseEmail(memberData, extraData);
                        break;
                    case 'discount':
                        content = this.buildDiscountEmail(memberData, extraData);
                        break;
                    case 'referral':
                        content = this.buildReferralEmail(memberData, extraData);
                        break;
                    case 'password_reset':
                        content = this.buildPasswordResetEmail(memberData, extraData);
                        break;
                    case 'password_reset_success':
                        content = this.buildPasswordResetSuccessEmail(memberData);
                        break;
                    case 'newsletter_welcome':
                        content = this.buildNewsletterWelcomeEmail(memberData, extraData);
                        break;
                    case 'newsletter':
                        content = this.buildNewsletterEmail(memberData, extraData);
                        break;
                }
                
                return content;
            }

            buildWelcomeEmail(memberData) {
                return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Welcome to Jeans Club!</title>
            <style>
                body { font-family: 'Arial', 'Helvetica Neue', Helvetica, sans-serif; line-height: 1.6; color: #333333; background-color: #f9f9f9; margin: 0; padding: 0; }
                .email-container { max-width: 600px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
                .email-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 30px; text-align: center; }
                .email-header h1 { margin: 0; font-size: 28px; font-weight: bold; }
                .email-header p { margin: 10px 0 0; opacity: 0.9; font-size: 16px; }
                .email-content { padding: 40px 30px; }
                .email-card { background: #f8f9fa; padding: 25px; margin: 25px 0; border-radius: 8px; border-left: 4px solid #667eea; }
                .highlight-box { background: #e7f3ff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196F3; }
                .benefits-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
                .benefit-item { text-align: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0; }
                .benefit-icon { font-size: 24px; margin-bottom: 10px; }
                .referral-section { background: #fff3cd; padding: 25px; border-radius: 8px; text-align: center; margin: 25px 0; border: 2px dashed #ffc107; }
                .referral-code { font-size: 32px; font-weight: bold; color: #667eea; letter-spacing: 3px; margin: 15px 0; font-family: 'Courier New', monospace; }
                .tier-badge { display: inline-block; background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; margin: 5px 0; }
                .email-footer { text-align: center; margin-top: 30px; padding: 25px; color: #666; font-size: 14px; border-top: 1px solid #eee; background: #f8f9fa; }
                table { width: 100%; border-collapse: collapse; }
                td { padding: 12px 8px; border-bottom: 1px solid #e0e0e0; }
                .btn { display: inline-block; background: #667eea; color: white; padding: 14px 32px; text-decoration: none; border-radius: 5px; margin: 15px 0; font-weight: bold; font-size: 16px; }
                @media (max-width: 600px) { .benefits-grid { grid-template-columns: 1fr; } .email-content { padding: 25px 20px; } .referral-code { font-size: 24px; } }
            </style>
        </head>
        <body>
            <div class="email-container">
                <div class="email-header">
                    <h1> Welcome to Jeans Club!</h1>
                    <p>Your Premium Denim Experience Starts Here</p>
                </div>
                <div class="email-content">
                    <h2 style="color: #333; margin-top: 0;">Hello ${memberData.name},</h2>
                    <p style="font-size: 16px; color: #555;">Welcome to the Jeans Club family! We're thrilled to have you as a member of our exclusive loyalty program where style meets rewards.</p>
                    <div class="email-card">
                        <h3 style="color: #667eea; margin-top: 0;">üéâ Your Membership Details</h3>
                        <table>
                            <tr><td style="font-weight: bold; color: #555;">JC ID:</td><td style="color: #333;">${memberData.jcId}</td></tr>
                            <tr><td style="font-weight: bold; color: #555;">Tier:</td><td><span class="tier-badge">${memberData.tier}</span></td></tr>
                            <tr><td style="font-weight: bold; color: #555;">Starting Points:</td><td style="color: #333;">${memberData.points} points</td></tr>
                            <tr><td style="font-weight: bold; color: #555;">Referral Code:</td><td><code style="background: #f4f4f4; padding: 8px 12px; border-radius: 4px; font-weight: bold; color: #667eea;">${memberData.referralCode}</code></td></tr>
                        </table>
                    </div>
                    <div class="highlight-box">
                        <h3 style="color: #333; margin-top: 0;">üí∞ New Points System</h3>
                        <p style="color: #666; margin: 10px 0;"><strong>Earn:</strong> 1 point for every 1,000 UGX spent</p>
                        <p style="color: #666; margin: 10px 0;"><strong>Redeem:</strong> 1 point = 250 UGX discount</p>
                        <p style="color: #666; margin: 10px 0; font-size: 14px;">Higher tiers earn points faster with multipliers!</p>
                    </div>
                    <div class="referral-section">
                        <h3 style="color: #333; margin-top: 0;">üì£ Share Your Referral Code</h3>
                        <div class="referral-code">${memberData.referralCode}</div>
                        <p style="color: #666; margin: 10px 0;">Share with friends and both of you earn bonus points!</p>
                    </div>
                    <div class="email-footer">
                        <p style="margin: 0 0 10px; color: #333; font-weight: bold;">Thank you for choosing Jeans Club - Where Style Meets Rewards!</p>
                        <p style="margin: 5px 0; color: #666;">üìç Visit us: https://elijah787.github.io/jeans-club</p>
                        <p style="margin: 15px 0 0; font-size: 12px; color: #999;">This is an automated message. Please do not reply to this email.</p>
                    </div>
                </div>
            </div>
        </body>
        </html>`;
            }

            buildNewsletterWelcomeEmail(memberData, extraData) {
                const subject = extraData?.subject || "üì¨ Welcome to Jeans Club Newsletter!";
                const message = extraData?.message || `We're thrilled to welcome you to our exclusive newsletter community! Get ready for exclusive offers and updates.`;
                
                return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${subject}</title>
            <style>
                body { font-family: 'Arial', 'Helvetica Neue', Helvetica, sans-serif; line-height: 1.6; color: #333333; background-color: #f9f9f9; margin: 0; padding: 0; }
                .email-container { max-width: 600px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
                .email-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 30px; text-align: center; }
                .email-header h1 { margin: 0; font-size: 28px; font-weight: bold; }
                .email-content { padding: 40px 30px; }
                .email-footer { text-align: center; margin-top: 30px; padding: 25px; color: #666; font-size: 14px; border-top: 1px solid #eee; background: #f8f9fa; }
                .btn { display: inline-block; background: #667eea; color: white; padding: 14px 32px; text-decoration: none; border-radius: 5px; margin: 15px 0; font-weight: bold; font-size: 16px; }
                @media (max-width: 600px) { .email-content { padding: 25px 20px; } }
            </style>
        </head>
        <body>
            <div class="email-container">
                <div class="email-header">
                    <h1>üì¨ Welcome to Jeans Club Newsletter!</h1>
                    <p>Your Exclusive Fashion Updates Start Here</p>
                </div>
                <div class="email-content">
                    <h2 style="color: #333; margin-top: 0;">Hello ${memberData?.name || 'Valued Member'},</h2>
                    <p style="font-size: 16px; color: #555;">${message}</p>
                    <p style="font-size: 16px; color: #555;">As a newsletter subscriber, you'll receive:</p>
                    <ul style="color: #555; line-height: 1.8;">
                        <li>üéÅ <strong>Exclusive Offers:</strong> Member-only discounts and promotions</li>
                        <li>üëñ <strong>New Arrivals:</strong> First look at our latest denim collections</li>
                        <li>üíé <strong>Style Tips:</strong> Expert advice on rocking your Jeans Club pieces</li>
                        <li>‚≠ê <strong>Early Access:</strong> Be the first to shop sales and special events</li>
                        <li>üì± <strong>Digital Content:</strong> Behind-the-scenes and fashion insights</li>
                    </ul>
                    <div style="text-align: center; margin: 30px 0;">
                        <a href="https://elijah787.github.io/jeans-club" class="btn">Visit Jeans Club</a>
                    </div>
                    <p style="font-size: 14px; color: #777; border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                        <strong>Note:</strong> You can unsubscribe at any time from your member dashboard.
                    </p>
                </div>
                <div class="email-footer">
                    <p style="margin: 0 0 10px; color: #333; font-weight: bold;">Thank you for subscribing to Jeans Club Newsletter!</p>
                    <p style="margin: 5px 0; color: #666;">üìç Visit us: https://elijah787.github.io/jeans-club</p>
                    <p style="margin: 15px 0 0; font-size: 12px; color: #999;">This is an automated message. Please do not reply to this email.</p>
                </div>
            </div>
        </body>
        </html>`;
            }

            buildNewsletterEmail(memberData, extraData) {
                const subject = extraData?.subject || "üì∞ Jeans Club Newsletter";
                const message = extraData?.message || "Here are your latest updates from Jeans Club!";
                
                return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${subject}</title>
            <style>
                body { font-family: 'Arial', 'Helvetica Neue', Helvetica, sans-serif; line-height: 1.6; color: #333333; background-color: #f9f9f9; margin: 0; padding: 0; }
                .email-container { max-width: 600px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
                .email-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 30px; text-align: center; }
                .email-header h1 { margin: 0; font-size: 28px; font-weight: bold; }
                .email-content { padding: 40px 30px; }
                .email-footer { text-align: center; margin-top: 30px; padding: 25px; color: #666; font-size: 14px; border-top: 1px solid #eee; background: #f8f9fa; }
                .btn { display: inline-block; background: #667eea; color: white; padding: 14px 32px; text-decoration: none; border-radius: 5px; margin: 15px 0; font-weight: bold; font-size: 16px; }
                .newsletter-content { line-height: 1.8; color: #555; }
                @media (max-width: 600px) { .email-content { padding: 25px 20px; } }
            </style>
        </head>
        <body>
            <div class="email-container">
                <div class="email-header">
                    <h1>${subject}</h1>
                    <p>Exclusive Updates from Jeans Club</p>
                </div>
                <div class="email-content">
                    <h2 style="color: #333; margin-top: 0;">Hello ${memberData?.name || 'Valued Member'},</h2>
                    <div class="newsletter-content">
                        ${message}
                    </div>
                    <div style="text-align: center; margin: 30px 0;">
                        <a href="https://elijah787.github.io/jeans-club" class="btn">Visit Jeans Club</a>
                    </div>
                    <p style="font-size: 14px; color: #777; border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                        <strong>Note:</strong> You're receiving this email because you subscribed to Jeans Club newsletter.
                        <br>You can unsubscribe at any time from your member dashboard.
                    </p>
                </div>
                <div class="email-footer">
                    <p style="margin: 0 0 10px; color: #333; font-weight: bold;">Thank you for being a Jeans Club member!</p>
                    <p style="margin: 5px 0; color: #666;">üìç Visit us: https://elijah787.github.io/jeans-club</p>
                    <p style="margin: 15px 0 0; font-size: 12px; color: #999;">This is an automated message. Please do not reply to this email.</p>
                </div>
            </div>
        </body>
        </html>`;
            }

            // Other email template methods (purchase, discount, referral, password_reset, etc.)
            buildPurchaseEmail(memberData, extraData) {
                return `<div>Purchase email content...</div>`;
            }

            buildDiscountEmail(memberData, extraData) {
                return `<div>Discount email content...</div>`;
            }

            buildReferralEmail(memberData, extraData) {
                return `<div>Referral email content...</div>`;
            }

            buildPasswordResetEmail(memberData, extraData) {
                return `<div>Password reset email content...</div>`;
            }

            buildPasswordResetSuccessEmail(memberData) {
                return `<div>Password reset success email content...</div>`;
            }

            getSubject(type, memberData, extraData) {
                switch(type) {
                    case 'welcome': return 'üëñ Welcome to Jeans Club! Your Premium Denim Journey Starts Here';
                    case 'purchase': return 'üõçÔ∏è Purchase Recorded - ' + (extraData?.description || '') + ' | Points Earned!';
                    case 'discount': return 'üé´ ' + (extraData?.discountPercentage || 0) + '% Discount Voucher | Jeans Club Rewards';
                    case 'referral': return 'üéä Referral Success! +100 Points | Keep Sharing the Love';
                    case 'password_reset': return 'üîí Password Reset Request | Jeans Club Account Security';
                    case 'password_reset_success': return '‚úÖ Password Reset Successful | Jeans Club Account Secured';
                    case 'newsletter_welcome': return "üì¨ Welcome to Jeans Club Newsletter!";
                    case 'newsletter': return extraData?.subject || "üì∞ Jeans Club Newsletter";
                    default: return 'üíå Message from Jeans Club';
                }
            }

            async sendWelcomeEmail(email, memberData) {
                console.log('Attempting to send welcome email to:', email);
                return this.sendEmailToGoogleScript(email, 'welcome', memberData);
            }

            async sendPurchaseEmail(email, memberData, purchaseData) {
                console.log('Attempting to send purchase email to:', email);
                return this.sendEmailToGoogleScript(email, 'purchase', memberData, purchaseData);
            }

            async sendDiscountEmail(email, memberData, discountData) {
                console.log('Attempting to send discount email to:', email);
                return this.sendEmailToGoogleScript(email, 'discount', memberData, discountData);
            }

            async sendReferralEmail(email, memberData, referralData) {
                console.log('Attempting to send referral email to:', email);
                return this.sendEmailToGoogleScript(email, 'referral', memberData, referralData);
            }

            async sendPasswordResetEmail(email, memberData, resetData) {
                console.log('Attempting to send password reset email to:', email);
                return this.sendEmailToGoogleScript(email, 'password_reset', memberData, resetData);
            }

            async sendPasswordResetSuccessEmail(email, memberData) {
                console.log('Attempting to send password reset success email to:', email);
                return this.sendEmailToGoogleScript(email, 'password_reset_success', memberData);
            }

            async sendNewsletterWelcomeEmail(email, name = null) {
                console.log('Attempting to send newsletter welcome email to:', email);
                const memberData = { name: name, email: email };
                return this.sendEmailToGoogleScript(email, 'newsletter_welcome', memberData, { 
                    subject: "üì¨ Welcome to Jeans Club Newsletter!",
                    message: "We're thrilled to welcome you to our exclusive newsletter community! Get ready for exclusive offers and updates."
                });
            }

            async sendNewsletterEmail(email, subject, content, name = null) {
                console.log('Attempting to send newsletter email to:', email);
                const memberData = { name: name, email: email };
                return this.sendEmailToGoogleScript(email, 'newsletter', memberData, { 
                    subject: subject,
                    message: content
                });
            }

            fallbackEmail(email, memberData, type, extraData = null) {
                let subject, content;

                switch(type) {
                    case 'welcome':
                        subject = ' Welcome to Jeans Club! Your Premium Denim Journey Starts Here';
                        content = this.buildWelcomeEmail(memberData);
                        break;
                    case 'purchase':
                        subject = 'üõçÔ∏è Purchase Recorded - ' + extraData.description + ' | Points Earned!';
                        content = this.buildPurchaseEmail(memberData, extraData);
                        break;
                    case 'discount':
                        subject = 'üé´ ' + extraData.discountPercentage + '% Discount Voucher | Jeans Club Rewards';
                        content = this.buildDiscountEmail(memberData, extraData);
                        break;
                    case 'referral':
                        subject = 'üéä Referral Success! +100 Points | Keep Sharing the Love';
                        content = this.buildReferralEmail(memberData, extraData);
                        break;
                    case 'password_reset':
                        subject = 'üîí Password Reset Request | Jeans Club Account Security';
                        content = this.buildPasswordResetEmail(memberData, extraData);
                        break;
                    case 'password_reset_success':
                        subject = '‚úÖ Password Reset Successful | Jeans Club Account Secured';
                        content = this.buildPasswordResetSuccessEmail(memberData);
                        break;
                    case 'newsletter_welcome':
                        subject = "üì¨ Welcome to Jeans Club Newsletter!";
                        content = this.buildNewsletterWelcomeEmail(memberData, extraData);
                        break;
                    case 'newsletter':
                        subject = extraData?.subject || "üì∞ Jeans Club Newsletter";
                        content = this.buildNewsletterEmail(memberData, extraData);
                        break;
                }

                console.log('FALLBACK EMAIL CONTENT:');
                console.log('To:', email);
                console.log('Subject:', subject);
                console.log('Content:', content);
                
                this.saveEmailToLog(email, subject, content);
                
                return { 
                    success: true, 
                    message: "Email prepared (fallback mode - check console)",
                    fallback: true 
                };
            }

            saveEmailToLog(email, subject, content) {
                try {
                    const emailLog = JSON.parse(localStorage.getItem('jeansClubEmails') || '[]');
                    emailLog.unshift({
                        email: email,
                        subject: subject,
                        content: content,
                        timestamp: new Date().toISOString(),
                        sent: false
                    });
                    
                    if (emailLog.length > 50) emailLog.length = 50;
                    
                    localStorage.setItem('jeansClubEmails', JSON.stringify(emailLog));
                } catch (error) {
                    console.log('Could not save email to storage:', error);
                }
            }
        }

        // Legacy Central Storage (for fallback)
        class CentralStorage {
            constructor() {
                this.storageKey = 'jeansClubCentralData';
                this.init();
            }

            async init() {
                if (!this.getData()) {
                    this.setData({
                        members: [],
                        lastUpdate: new Date().toISOString(),
                        version: '1.0'
                    });
                }
            }

            getData() {
                try {
                    return JSON.parse(localStorage.getItem(this.storageKey));
                } catch (error) {
                    console.error('Error reading storage:', error);
                    return null;
                }
            }

            setData(data) {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Error writing to storage:', error);
                    return false;
                }
            }

            getAllMembers() {
                const data = this.getData();
                return data ? data.members : [];
            }

            saveMember(member) {
                const data = this.getData();
                if (!data) return false;

                const existingIndex = data.members.findIndex(m => m.jcId === member.jcId);
                
                if (existingIndex >= 0) {
                    data.members[existingIndex] = member;
                } else {
                    data.members.push(member);
                }

                data.lastUpdate = new Date().toISOString();
                return this.setData(data);
            }

            deleteMember(jcId) {
                const data = this.getData();
                if (!data) return false;

                data.members = data.members.filter(m => m.jcId !== jcId);
                data.lastUpdate = new Date().toISOString();
                return this.setData(data);
            }

            getMemberByJCId(jcId) {
                const data = this.getData();
                if (!data) return null;
                return data.members.find(m => m.jcId === jcId);
            }

            getMemberByEmail(email) {
                const data = this.getData();
                if (!data) return null;
                return data.members.find(m => m.email === email);
            }
        }

        // Google OAuth Configuration
        const googleConfig = {
            clientId: '607807821474-43243foqc9ml9eq3e0ugu04fnsigbqc5.apps.googleusercontent.com'
        };

        // QR Code Redemption System Implementation - FIXED VERSION
        class QRRedemptionSystem {
            constructor() {
                this.redemptions = JSON.parse(localStorage.getItem('jeansClubRedemptions') || '[]');
                this.tierRules = {
                    PEARL: { 
                        payWithPoints: false,
                        discountVoucherOnly: true,
                        description: "Basic membership - use points for discount vouchers only"
                    },
                    BRONZE: { 
                        months: 2, 
                        percentage: 0.08,
                        multiplier: 1.0,
                        minSpendingThreshold: 300000,
                        maxRedemptionCap: 50000,
                        description: "Redeem 8% of your last 2 months spending as points",
                        pointsPer100UGX: 100
                    },
                    SILVER: { 
                        months: 3, 
                        percentage: 0.10,
                        multiplier: 1.1,
                        minSpendingThreshold: 500000,
                        maxRedemptionCap: 100000,
                        description: "Redeem 10% of your last 3 months spending as points",
                        pointsPer100UGX: 90
                    },
                    RUBY: { 
                        months: 4, 
                        percentage: 0.12,
                        multiplier: 1.3,
                        minSpendingThreshold: 1000000,
                        maxRedemptionCap: 200000,
                        description: "Redeem 12% of your last 4 months spending as points",
                        pointsPer100UGX: 80
                    },
                    GOLD: { 
                        months: 5, 
                        percentage: 0.15,
                        multiplier: 1.4,
                        minSpendingThreshold: 2000000,
                        maxRedemptionCap: 300000,
                        description: "Redeem 15% of your last 5 months spending as points",
                        pointsPer100UGX: 70
                    },
                    SAPPHIRE: { 
                        months: 6, 
                        percentage: 0.18,
                        lifetimeBonus: 0.02,
                        multiplier: 1.5,
                        minSpendingThreshold: 4000000,
                        maxRedemptionCap: 500000,
                        description: "Redeem 18% of last 6 months + 2% lifetime bonus as points",
                        pointsPer100UGX: 60
                    },
                    PLATINUM: { 
                        months: 12, 
                        percentage: 0.25,
                        lifetimeBonus: 0.05,
                        multiplier: 1.6,
                        minSpendingThreshold: 8000000,
                        maxRedemptionCap: 1000000,
                        canChooseAny: true,
                        description: "Redeem 25% of last 12 months + 5% lifetime bonus as points",
                        pointsPer100UGX: 50
                    }
                };
                
                this.discountVoucherLimits = {
                    PEARL: { 
                        min: 1000, 
                        max: 5000, 
                        maxPercentage: 5,
                        pointsPerDiscount: 100
                    },
                    BRONZE: { 
                        min: 2000, 
                        max: 10000, 
                        maxPercentage: 8,
                        pointsPerDiscount: 100
                    },
                    SILVER: { 
                        min: 3000, 
                        max: 15000, 
                        maxPercentage: 10,
                        pointsPerDiscount: 100
                    },
                    RUBY: { 
                        min: 5000, 
                        max: 25000, 
                        maxPercentage: 12,
                        pointsPerDiscount: 100
                    },
                    GOLD: { 
                        min: 10000, 
                        max: 50000, 
                        maxPercentage: 15,
                        pointsPerDiscount: 100
                    },
                    SAPPHIRE: { 
                        min: 20000, 
                        max: 100000, 
                        maxPercentage: 18,
                        pointsPerDiscount: 100
                    },
                    PLATINUM: { 
                        min: 50000, 
                        max: 250000, 
                        maxPercentage: 25,
                        pointsPerDiscount: 100
                    }
                };
            }

            calculateSpendingHistory(member, months) {
                const cutoffDate = new Date();
                cutoffDate.setMonth(cutoffDate.getMonth() - months);
                
                let totalSpent = 0;
                if (member.purchaseHistory) {
                    member.purchaseHistory.forEach(purchase => {
                        const purchaseDate = new Date(purchase.date);
                        if (purchaseDate >= cutoffDate) {
                            totalSpent += purchase.amount || 0;
                        }
                    });
                }
                
                return totalSpent;
            }

            calculateLifetimeSpending(member) {
                return member.totalSpent || 0;
            }

            calculateRedemptionOptions(member, purchaseAmount) {
                const tier = member.tier;
                const options = [];
                const memberPoints = member.points || 0;
                
                if (tier === 'PEARL') {
                    return this.getDiscountVoucherOptions(member, purchaseAmount).filter(option => 
                        memberPoints >= option.pointsRequired
                    );
                }
                
                const eligibleTiers = tier === 'PLATINUM' ? ['BRONZE', 'SILVER', 'RUBY', 'GOLD', 'SAPPHIRE'] : [tier];
                
                eligibleTiers.forEach(tierType => {
                    const rule = this.tierRules[tierType];
                    if (!rule || !rule.months) return;
                    
                    const monthsSpending = this.calculateSpendingHistory(member, rule.months);
                    
                    if (monthsSpending < rule.minSpendingThreshold) {
                        return;
                    }
                    
                    let totalRedemption = monthsSpending * rule.percentage;
                    
                    if (rule.lifetimeBonus) {
                        const lifetimeSpending = this.calculateLifetimeSpending(member);
                        totalRedemption += lifetimeSpending * rule.lifetimeBonus;
                    }
                    
                    totalRedemption = Math.min(totalRedemption, rule.maxRedemptionCap);
                    
                    if (totalRedemption > 0) {
                        const pointsEquivalent = Math.floor(totalRedemption / 100 * rule.pointsPer100UGX);
                        
                        if (memberPoints >= pointsEquivalent) {
                            options.push({
                                type: 'points_redemption',
                                tier: tierType,
                                description: rule.description,
                                monthsSpending: monthsSpending,
                                totalAmount: totalRedemption,
                                maxRedemption: Math.min(totalRedemption, purchaseAmount),
                                pointsEquivalent: pointsEquivalent,
                                pointsValue: rule.pointsPer100UGX + ' points per 100 UGX',
                                eligibility: `Spent ${monthsSpending.toLocaleString()} UGX in last ${rule.months} months`,
                                requiresSufficientPoints: true,
                                memberHasPoints: true
                            });
                        }
                    }
                });
                
                const voucherOptions = this.getDiscountVoucherOptions(member, purchaseAmount)
                    .filter(option => memberPoints >= option.pointsRequired);
                
                options.push(...voucherOptions);
                
                return options.sort((a, b) => (b.maxRedemption || 0) - (a.maxRedemption || 0));
            }

            getDiscountVoucherOptions(member, purchaseAmount) {
                const tier = member.tier;
                const limits = this.discountVoucherLimits[tier] || this.discountVoucherLimits.PEARL;
                
                const options = [];
                
                const discountAmounts = [1000, 2000, 3000, 5000, 10000, 15000, 20000, 25000, 30000, 50000];
                
                discountAmounts.forEach(amount => {
                    if (amount >= limits.min && amount <= limits.max && amount <= purchaseAmount) {
                        const discountPercentage = ((amount / purchaseAmount) * 100).toFixed(1);
                        if (discountPercentage <= 100) {
                            options.push({
                                type: 'discount_voucher',
                                tier: tier,
                                description: `${amount.toLocaleString()} UGX Discount Voucher`,
                                discountAmount: amount,
                                discountPercentage: discountPercentage,
                                applicableAmount: purchaseAmount,
                                pointsRequired: Math.floor(amount / 100)
                            });
                        }
                    }
                });
                
                return options;
            }

            generateQRCodeData(redemptionData) {
                // FIXED: Differentiate between pay-with-points and discount vouchers
                if (redemptionData.selectedOption.type === 'points_redemption') {
                    // Pay-with-points QR codes start with RED
                    return 'RED' + Date.now().toString().slice(-8) + Math.floor(1000 + Math.random() * 9000);
                } else if (redemptionData.selectedOption.type === 'discount_voucher') {
                    // Discount voucher QR codes use regular voucher format
                    return 'JC' + Math.random().toString(36).substr(2, 8).toUpperCase();
                }
                // Fallback for any other type
                return 'QR' + Date.now().toString().slice(-8);
            }

            async createRedemption(member, selectedOption, purchaseAmount) {
                const redemptionId = this.generateQRCodeData({ selectedOption: selectedOption });
                
                const redemptionData = {
                    redemptionId: redemptionId,
                    memberJCId: member.jcId,
                    memberName: member.name,
                    memberTier: member.tier,
                    purchaseAmount: purchaseAmount,
                    selectedOption: selectedOption,
                    createdDate: new Date().toISOString(),
                    status: 'pending',
                    redeemedBy: null,
                    redeemedDate: null,
                    qrCodeData: null
                };

                redemptionData.qrCodeData = redemptionId; // Use same ID for QR code

                this.redemptions.push(redemptionData);
                this.saveRedemptions();
                
                // üî• FIXED: Save to Supabase
                if (window.supabaseDbInstance) {
                    await window.supabaseDbInstance.saveRedemptionToSupabase(redemptionData);
                }

                return redemptionData;
            }

            async getRedemptionById(redemptionId) {
                // First check local storage
                let redemption = this.redemptions.find(r => r.redemptionId === redemptionId);
                
                // If not found locally, try Supabase
                if (!redemption && window.supabaseDbInstance) {
                    redemption = await window.supabaseDbInstance.getRedemptionFromSupabase(redemptionId);
                    if (redemption) {
                        // Add to local cache
                        this.redemptions.push(redemption);
                        this.saveRedemptions();
                    }
                }
                
                return redemption;
            }

            async processRedemption(qrCodeData, salespersonName) {
                console.log("Processing redemption with data:", qrCodeData);
                
                if (!salespersonName || salespersonName.trim() === '') {
                    return { success: false, message: "Salesperson name is required" };
                }

                // Check if it's a pay-with-points QR code (starts with RED)
                if (qrCodeData.startsWith('RED')) {
                    const redemption = await this.getRedemptionById(qrCodeData);
                    if (redemption) {
                        if (redemption.status === 'completed') {
                            return { success: false, message: "Redemption has already been completed" };
                        }
                        
                        if (redemption.status === 'expired') {
                            return { success: false, message: "Redemption has expired" };
                        }
                        
                        redemption.status = 'completed';
                        redemption.redeemedBy = salespersonName.trim();
                        redemption.redeemedDate = new Date().toISOString();
                        this.saveRedemptions();
                        
                        // üî• FIXED: Update Supabase
                        if (window.supabaseDbInstance) {
                            await window.supabaseDbInstance.saveRedemptionToSupabase(redemption);
                        }
                        
                        return {
                            success: true,
                            message: `Pay-with-points redemption completed successfully by ${salespersonName}`,
                            redemption: redemption,
                            type: 'points_redemption'
                        };
                    }
                }
                
                // If not starting with RED, check if it's a voucher code (starts with JC)
                if (qrCodeData.startsWith('JC')) {
                    const voucherResult = await voucherSystem.redeemVoucher(qrCodeData, salespersonName);
                    if (voucherResult.success) {
                        return {
                            success: true,
                            message: voucherResult.message,
                            voucher: voucherResult.voucher,
                            type: 'voucher'
                        };
                    }
                }
                
                // Also check for any other redemption ID that might not start with RED
                const redemption = await this.getRedemptionById(qrCodeData);
                if (redemption) {
                    if (redemption.status === 'completed') {
                        return { success: false, message: "Redemption has already been completed" };
                    }
                    
                    if (redemption.status === 'expired') {
                        return { success: false, message: "Redemption has expired" };
                    }
                    
                    redemption.status = 'completed';
                    redemption.redeemedBy = salespersonName.trim();
                    redemption.redeemedDate = new Date().toISOString();
                    this.saveRedemptions();
                    
                    // üî• FIXED: Update Supabase
                    if (window.supabaseDbInstance) {
                        await window.supabaseDbInstance.saveRedemptionToSupabase(redemption);
                    }
                    
                    return {
                        success: true,
                        message: `Redemption completed successfully by ${salespersonName}`,
                        redemption: redemption
                    };
                }
                
                return { 
                    success: false, 
                    message: "Invalid QR code or redemption ID. Please scan a valid Jeans Club QR code." 
                };
            }

            getMemberRedemptions(memberJCId) {
                return this.redemptions
                    .filter(r => r.memberJCId === memberJCId)
                    .sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));
            }

            async getAllRedemptions() {
                // Also get from Supabase to ensure we have all data
                let supabaseRedemptions = [];
                if (window.supabaseDbInstance) {
                    supabaseRedemptions = await window.supabaseDbInstance.getAllRedemptionsFromSupabase();
                }
                
                // Merge with local redemptions
                const allRedemptions = [...this.redemptions];
                
                supabaseRedemptions.forEach(supabaseRedemption => {
                    const exists = allRedemptions.some(r => r.redemptionId === supabaseRedemption.redemptionId);
                    if (!exists) {
                        allRedemptions.push(supabaseRedemption);
                    }
                });
                
                // Update local storage
                this.redemptions = allRedemptions;
                this.saveRedemptions();
                
                return allRedemptions.sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));
            }

            saveRedemptions() {
                localStorage.setItem('jeansClubRedemptions', JSON.stringify(this.redemptions));
            }

            async getRedemptionStats() {
                const allRedemptions = await this.getAllRedemptions();
                const total = allRedemptions.length;
                const pending = allRedemptions.filter(r => r.status === 'pending').length;
                const completed = allRedemptions.filter(r => r.status === 'completed').length;
                const expired = allRedemptions.filter(r => r.status === 'expired').length;
                
                const totalValue = allRedemptions
                    .filter(r => r.status === 'completed')
                    .reduce((sum, r) => {
                        if (r.selectedOption && r.selectedOption.type === 'points_redemption') {
                            return sum + (r.selectedOption.maxRedemption || 0);
                        } else if (r.selectedOption && r.selectedOption.type === 'discount_voucher') {
                            return sum + (r.selectedOption.discountAmount || 0);
                        }
                        return sum;
                    }, 0);
                
                return {
                    total,
                    pending,
                    completed,
                    expired,
                    totalValue,
                    completionRate: total > 0 ? ((completed / total) * 100).toFixed(1) + '%' : '0%'
                };
            }
        }

        // Jeans Club Configuration - UPDATED WITH NEW POINTS SYSTEM
        const jeansClubConfig = {
            pointValue: 250, // NEW: 1 point = 250 UGX discount
            earningRate: 0.001, // NEW: 1 point per 1,000 UGX spent (1/1000)
            tierRedemptionRates: {
                PEARL: 0.0003,
                BRONZE: 0.0004,
                SILVER: 0.0005,
                RUBY: 0.0006,
                GOLD: 0.0007,
                SAPPHIRE: 0.0008,
                PLATINUM: 0.0010
            },
            
            tiers: {
                PEARL: { 
                    minPoints: 0, 
                    maxPoints: 7499,
                    multiplier: 1.0, 
                    name: "Pearl", 
                    color: "#FFF8DC",
                    discountRate: 0.03,
                    earningDescription: "1 point per 1,000 UGX spent"
                },
                BRONZE: { 
                    minPoints: 7500,    
                    maxPoints: 24999,
                    multiplier: 1.10, 
                    name: "Bronze", 
                    color: "#B76E79",
                    discountRate: 0.04,
                    earningDescription: "1.1 points per 1,000 UGX spent"
                },
                SILVER: { 
                    minPoints: 25000,    
                    maxPoints: 99999,
                    multiplier: 1.25, 
                    name: "Silver", 
                    color: "#2C3E50",
                    discountRate: 0.05,
                    earningDescription: "1.25 points per 1,000 UGX spent"
                },
                RUBY: { 
                    minPoints: 100000,    
                    maxPoints: 249999,
                    multiplier: 1.30, 
                    name: "Ruby", 
                    color: "#8B475D",
                    discountRate: 0.06,
                    earningDescription: "1.3 points per 1,000 UGX spent"
                },
                GOLD: { 
                    minPoints: 250000,    
                    maxPoints: 499999,
                    multiplier: 1.40, 
                    name: "Gold", 
                    color: "#FFD700",
                    discountRate: 0.07,
                    earningDescription: "1.4 points per 1,000 UGX spent"
                },
                SAPPHIRE: { 
                    minPoints: 500000,    
                    maxPoints: 999999,
                    multiplier: 1.50, 
                    name: "Sapphire", 
                    color: "#34495E",
                    discountRate: 0.08,
                    earningDescription: "1.5 points per 1,000 UGX spent"
                },
                PLATINUM: { 
                    minPoints: 1000000,    
                    maxPoints: 9999999,
                    multiplier: 1.60, 
                    name: "Platinum", 
                    color: "#2F4F4F",
                    discountRate: 0.10,
                    earningDescription: "1.6 points per 1,000 UGX spent"
                }
            }
        };

        // Main JeansClubManager - UPDATED WITH NEW POINTS SYSTEM
        class JeansClubManager {
            constructor() {
                this.db = new SupabaseDB();
                this.emailService = new GoogleAppsEmailService();
                this.currentMember = null;
                this.isAdmin = false;
                this.loadCurrentMember();
                console.log('üöÄ JeansClubManager initialized with Supabase DB');
            }

            generateJCId() {
                return 'JC' + Date.now().toString().slice(-6) + Math.floor(100 + Math.random() * 900);
            }

            generateReferralCode() {
                return 'JEANS' + Math.random().toString(36).substr(2, 6).toUpperCase();
            }

            generateResetToken() {
                return Math.random().toString(36).substr(2, 8).toUpperCase();
            }

            loadCurrentMember() {
                const savedMember = localStorage.getItem('jeansClubCurrentMember');
                if (savedMember) {
                    this.currentMember = JSON.parse(savedMember);
                }
            }

            saveCurrentMember() {
                if (this.currentMember) {
                    localStorage.setItem('jeansClubCurrentMember', JSON.stringify(this.currentMember));
                }
            }

            async createAccount(userData, password, referralCode = null) {
                console.log('üë§ Creating account for:', userData.email);
                
                // NEW: Fraud prevention checks
                const emailCheck = isValidEmailWithFraudPrevention(userData.email);
                if (!emailCheck.valid) {
                    return { success: false, message: emailCheck.message };
                }
                
                // Check for self-referral
                if (referralCode && isSelfReferral(referralCode, userData.email)) {
                    return { 
                        success: false, 
                        message: "You cannot use your own referral code. Please remove the referral code or ask a friend for theirs." 
                    };
                }
                
                // Get client IP for fraud detection
                const clientIP = await getClientIP();
                
                // Check for multiple accounts from same IP
                const ipCheck = await checkMultipleAccountsFromIP(userData.email, clientIP);
                if (!ipCheck.allowed) {
                    return { success: false, message: ipCheck.reason };
                }
                
                const existingMember = await this.db.getMemberByEmail(userData.email);
                if (existingMember) {
                    console.log('‚ùå Email already registered:', userData.email);
                    return { 
                        success: false, 
                        message: "This email is already registered. Please use a different email or login with your existing account." 
                    };
                }

                const memberId = 'member_' + Date.now();
                const startingPoints = referralCode ? 20 : 10;
                
                const newMember = {
                    id: memberId,
                    jcId: this.generateJCId(),
                    email: userData.email,
                    normalized_email: normalizeEmailForDatabase(userData.email), // NEW: Store normalized
                    name: userData.name,
                    password: password,
                    googleId: null,
                    loginMethod: 'email',
                    points: startingPoints,
                    tier: 'PEARL',
                    referralCode: this.generateReferralCode(),
                    referredBy: referralCode || null,
                    purchaseHistory: [],
                    activityLog: [
                        {
                            type: 'account_created',
                            description: 'Account created successfully',
                            date: new Date().toISOString(),
                            points: startingPoints,
                            fraud_prevention: 'Email normalization and IP tracking enabled'
                        }
                    ],
                    joinedDate: new Date().toISOString(),
                    totalSpent: 0,
                    challenges: [],
                    referrals: [],
                    resetToken: null,
                    resetTokenExpiry: null,
                    newsletterSubscribed: userData.newsletter || true,
                    ip_address: clientIP // NEW: Store IP
                };

                const saved = await this.db.saveMember(newMember);
                if (!saved) {
                    console.log('‚ùå Failed to save member to database');
                    return { success: false, message: "Failed to create account. Please try again." };
                }

                console.log('‚úÖ Account created successfully:', newMember.jcId);
                console.log('üìä Fraud prevention:', {
                    normalized_email: newMember.normalized_email,
                    ip_address: clientIP,
                    self_referral_prevented: !!referralCode
                });

                if (referralCode) {
                    await this.processReferral(referralCode, newMember);
                }

                try {
                    // Send welcome email
                    await this.emailService.sendWelcomeEmail(newMember.email, newMember);
                    
                    // FIXED: Send newsletter welcome email if subscribed
                    if (userData.newsletter !== false) {
                        console.log('üìß Sending newsletter welcome email to:', newMember.email);
                        await this.emailService.sendNewsletterWelcomeEmail(newMember.email, newMember.name);
                        await this.db.subscribeToNewsletter(newMember.email, newMember.name);
                    }
                } catch (emailError) {
                    console.log('Email sending failed but account created:', emailError);
                }

                this.currentMember = newMember;
                this.saveCurrentMember();

                return {
                    success: true,
                    message: "Account created successfully! Welcome to Jeans Club.",
                    member: newMember,
                    fraud_prevention: {
                        email_normalized: newMember.normalized_email,
                        ip_logged: clientIP,
                        disposable_email_blocked: true
                    }
                };
            }

            async processReferral(referralCode, newMember) {
                try {
                    const allMembers = await this.db.getAllMembers();
                    const referrer = allMembers.find(m => m.referralCode === referralCode);
                    
                    if (referrer) {
                        // Verify this is not self-referral (double-check)
                        const normalizedReferrerEmail = normalizeEmailForDatabase(referrer.email);
                        const normalizedNewEmail = normalizeEmailForDatabase(newMember.email);
                        
                        if (normalizedReferrerEmail === normalizedNewEmail) {
                            console.log('üö´ Self-referral prevented:', newMember.email);
                            return;
                        }
                        
                        referrer.points += 100;
                        referrer.referrals = referrer.referrals || [];
                        referrer.referrals.push({
                            referredJCId: newMember.jcId,
                            referredName: newMember.name,
                            date: new Date().toISOString(),
                            pointsAwarded: 100
                        });
                        
                        referrer.activityLog.unshift({
                            type: 'referral_bonus',
                            description: `Referred ${newMember.name} (${newMember.jcId})`,
                            date: new Date().toISOString(),
                            points: 100
                        });
                        
                        await this.db.saveMember(referrer);
                        
                        try {
                            await this.emailService.sendReferralEmail(
                                referrer.email, 
                                referrer, 
                                {
                                    newMemberName: newMember.name,
                                    newMemberJCId: newMember.jcId
                                }
                            );
                        } catch (emailError) {
                            console.log('Referral email failed:', emailError);
                        }
                    }
                } catch (error) {
                    console.error('Referral processing error:', error);
                }
            }

            async loginWithCredentials(jcId, password) {
                console.log('üîê Attempting login for JC ID:', jcId);
                
                let member = await this.db.getMemberByJCId(jcId);
                
                if (!member) {
                    console.log('‚ùå Member not found in database:', jcId);
                    return { success: false, message: "Invalid JC ID or password" };
                }

                if (member.password !== password) {
                    console.log('‚ùå Invalid password for JC ID:', jcId);
                    return { success: false, message: "Invalid JC ID or password" };
                }

                console.log('‚úÖ Login successful for JC ID:', jcId);
                
                member.lastLogin = new Date().toISOString();
                member.activityLog.unshift({
                    type: 'login',
                    description: 'Logged in successfully',
                    date: new Date().toISOString()
                });
                
                await this.db.saveMember(member);
                
                this.currentMember = member;
                this.saveCurrentMember();
                
                return {
                    success: true,
                    message: "Login successful!",
                    member: member
                };
            }

            async loginWithGoogle(googleUser) {
                console.log('üîê Attempting Google login for:', googleUser.email);
                
                const profile = googleUser.getBasicProfile();
                const googleId = googleUser.getId();
                const email = profile.getEmail();
                
                // NEW: Fraud prevention check for Google signups too
                const emailCheck = isValidEmailWithFraudPrevention(email);
                if (!emailCheck.valid) {
                    return { success: false, message: emailCheck.message };
                }
                
                // Get client IP
                const clientIP = await getClientIP();
                
                let member = await this.db.getMemberByEmail(email);
                
                if (member) {
                    if (!member.googleId) {
                        member.googleId = googleId;
                        await this.db.saveMember(member);
                    }
                } else {
                    member = {
                        id: 'member_' + Date.now(),
                        jcId: this.generateJCId(),
                        email: email,
                        normalized_email: normalizeEmailForDatabase(email), // NEW: Store normalized
                        name: profile.getName(),
                        password: null,
                        googleId: googleId,
                        loginMethod: 'google',
                        points: 10,
                        tier: 'PEARL',
                        referralCode: this.generateReferralCode(),
                        referredBy: null,
                        purchaseHistory: [],
                        activityLog: [{
                            type: 'account_created',
                            description: 'Account created via Google',
                            date: new Date().toISOString(),
                            points: 10,
                            fraud_prevention: 'Google signup with email normalization'
                        }],
                        joinedDate: new Date().toISOString(),
                        totalSpent: 0,
                        challenges: [],
                        referrals: [],
                        resetToken: null,
                        resetTokenExpiry: null,
                        newsletterSubscribed: true,
                        ip_address: clientIP // NEW: Store IP
                    };
                    
                    await this.db.saveMember(member);
                    
                    try {
                        await this.emailService.sendWelcomeEmail(member.email, member);
                        // FIXED: Send newsletter welcome email for Google signups
                        await this.emailService.sendNewsletterWelcomeEmail(member.email, member.name);
                        await this.db.subscribeToNewsletter(member.email, member.name);
                    } catch (emailError) {
                        console.log('Welcome email failed:', emailError);
                    }
                }
                
                member.lastLogin = new Date().toISOString();
                member.activityLog.unshift({
                    type: 'login',
                    description: 'Logged in via Google',
                    date: new Date().toISOString()
                });
                
                await this.db.saveMember(member);
                
                this.currentMember = member;
                this.saveCurrentMember();
                
                return {
                    success: true,
                    message: "Google login successful!",
                    member: member
                };
            }

            async adminLogin(adminCode) {
                const adminCodeHash = this.hashPassword(adminCode);
                
                const storedAdminHash = localStorage.getItem('jeansClubAdminHash');
                
                if (!storedAdminHash) {
                    localStorage.setItem('jeansClubAdminHash', adminCodeHash);
                    this.isAdmin = true;
                    return { success: true, message: "Admin account created successfully!" };
                }
                
                if (adminCodeHash === storedAdminHash) {
                    this.isAdmin = true;
                    return { success: true, message: "Admin login successful!" };
                }
                
                return { success: false, message: "Invalid admin code" };
            }

            hashPassword(password) {
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36);
            }

            logout() {
                this.currentMember = null;
                this.isAdmin = false;
                localStorage.removeItem('jeansClubCurrentMember');
                return { success: true, message: "Logged out successfully!" };
            }

            async toggleNewsletter(email, subscribe = true) {
                try {
                    if (subscribe) {
                        await this.db.subscribeToNewsletter(email, this.currentMember?.name);
                        // FIXED: Send newsletter welcome email when subscribing
                        await this.emailService.sendNewsletterWelcomeEmail(email, this.currentMember?.name);
                    } else {
                        await this.db.unsubscribeFromNewsletter(email);
                    }
                    
                    if (this.currentMember) {
                        this.currentMember.newsletterSubscribed = subscribe;
                        await this.db.saveMember(this.currentMember);
                    }
                    
                    return { success: true, message: subscribe ? "Subscribed to newsletter!" : "Unsubscribed from newsletter!" };
                } catch (error) {
                    console.error('Newsletter toggle error:', error);
                    return { success: false, message: "Failed to update newsletter preferences" };
                }
            }

            async requestPasswordReset(jcId) {
                const member = await this.db.getMemberByJCId(jcId);
                
                if (!member) {
                    return { success: false, message: "JC ID not found" };
                }
                
                if (member.loginMethod === 'google') {
                    return { success: false, message: "Google accounts don't have passwords. Use Google Sign-In instead." };
                }
                
                const resetToken = this.generateResetToken();
                const resetTokenExpiry = new Date(Date.now() + 60 * 60 * 1000);
                
                member.resetToken = resetToken;
                member.resetTokenExpiry = resetTokenExpiry.toISOString();
                await this.db.saveMember(member);
                
                try {
                    await this.emailService.sendPasswordResetEmail(
                        member.email, 
                        member, 
                        {
                            resetToken: resetToken,
                            expiry: resetTokenExpiry.toLocaleString()
                        }
                    );
                    
                    return { 
                        success: true, 
                        message: "Password reset email sent! Check your inbox." 
                    };
                } catch (emailError) {
                    console.log('Reset email failed:', emailError);
                    return { 
                        success: true, 
                        message: "Reset code generated: " + resetToken + " (Email service unavailable)" 
                    };
                }
            }

            async executePasswordReset(jcId, resetToken, newPassword) {
                const member = await this.db.getMemberByJCId(jcId);
                
                if (!member) {
                    return { success: false, message: "JC ID not found" };
                }
                
                if (!member.resetToken || member.resetToken !== resetToken) {
                    return { success: false, message: "Invalid reset code" };
                }
                
                if (new Date() > new Date(member.resetTokenExpiry)) {
                    return { success: false, message: "Reset code has expired" };
                }
                
                member.password = newPassword;
                member.resetToken = null;
                member.resetTokenExpiry = null;
                
                member.activityLog.unshift({
                    type: 'password_reset',
                    description: 'Password reset successfully',
                    date: new Date().toISOString()
                });
                
                await this.db.saveMember(member);
                
                try {
                    await this.emailService.sendPasswordResetSuccessEmail(member.email, member);
                } catch (emailError) {
                    console.log('Confirmation email failed:', emailError);
                }
                
                return { success: true, message: "Password reset successful! You can now login with your new password." };
            }

            calculateDiscount(points) {
                // UPDATED: Minimum 4 points (equivalent to 1,000 UGX discount)
                if (points < 4) {
                    return { 
                        success: false, 
                        message: "Minimum 4 points required for discount (1,000 UGX)" 
                    };
                }
                
                const tier = this.getTier(this.currentMember);
                const redemptionRate = jeansClubConfig.tierRedemptionRates[tier.name] || 0.0003;
                const maxDiscount = jeansClubConfig.tiers[tier.name].discountRate * 100;
                const discountPercentage = Math.min(points * redemptionRate * 100, maxDiscount);
                
                // NEW: Calculate UGX value based on points
                const discountUGX = points * jeansClubConfig.pointValue;
                
                return {
                    success: true,
                    points: points,
                    discountPercentage: discountPercentage.toFixed(1),
                    discountUGX: discountUGX,
                    discountValue: discountUGX.toLocaleString() + ' UGX',
                    maxPossible: maxDiscount + '%',
                    tierMultiplier: tier.multiplier,
                    pointValue: jeansClubConfig.pointValue + ' UGX per point'
                };
            }

            async createDiscountVoucher(points) {
                const discountCalc = this.calculateDiscount(points);
                
                if (!discountCalc.success) {
                    return discountCalc;
                }
                
                if (this.currentMember.points < points) {
                    return { 
                        success: false, 
                        message: `Insufficient points. You have ${this.currentMember.points} points, but need ${points} points.` 
                    };
                }
                
                const currentTier = this.currentMember.tier;
                this.currentMember.points -= points;
                this.currentMember.tier = currentTier;
                
                this.currentMember.activityLog.unshift({
                    type: 'points_redeemed',
                    description: `Redeemed ${points} points for ${discountCalc.discountUGX.toLocaleString()} UGX discount voucher`,
                    date: new Date().toISOString(),
                    points: -points
                });
                
                // Calculate discount percentage based on a standard purchase amount for display
                const standardPurchase = 100000; // 100,000 UGX for percentage calculation
                const discountPercentage = ((discountCalc.discountUGX / standardPurchase) * 100).toFixed(1);
                
                // üî• FIXED: Wait for voucher creation to complete
                const voucher = await voucherSystem.createVoucher(
                    this.currentMember.jcId,
                    this.currentMember.name,
                    points,
                    parseFloat(discountPercentage)
                );
                
                await this.db.saveMember(this.currentMember);
                
                try {
                    await this.emailService.sendDiscountEmail(
                        this.currentMember.email,
                        this.currentMember,
                        {
                            pointsUsed: points,
                            discountPercentage: discountPercentage,
                            discountUGX: discountCalc.discountUGX,
                            voucher: voucher
                        }
                    );
                } catch (emailError) {
                    console.log('Voucher email failed:', emailError);
                }
                
                return {
                    success: true,
                    message: `Voucher created successfully! ${discountCalc.discountValue} discount applied.`,
                    voucher: voucher
                };
            }

            async redeemVoucher(voucherCode, redeemedBy = 'staff') {
                const result = await voucherSystem.redeemVoucher(voucherCode, redeemedBy);
                
                if (result.success) {
                    const member = await this.db.getMemberByJCId(result.voucher.memberJCId);
                    if (member) {
                        try {
                            await this.emailService.sendDiscountEmail(
                                member.email,
                                member,
                                {
                                    pointsUsed: result.voucher.pointsUsed,
                                    discountPercentage: result.voucher.discountPercentage,
                                    voucher: result.voucher
                                }
                            );
                        } catch (emailError) {
                            console.log('Redeem confirmation email failed:', emailError);
                        }
                    }
                }
                
                return result;
            }

            async addPurchase(jcId, amount, description) {
                const member = await this.db.getMemberByJCId(jcId);
                
                if (!member) {
                    return { success: false, message: "Member not found" };
                }
                
                const tier = this.getTier(member);
                
                // NEW: Calculate points based on new system (1 point per 1,000 UGX * tier multiplier)
                const basePoints = Math.floor(amount * jeansClubConfig.earningRate); // 1 point per 1,000 UGX
                const pointsEarned = Math.floor(basePoints * tier.multiplier);
                
                const oldPoints = member.points || 0;
                member.points = oldPoints + pointsEarned;
                member.totalSpent = (member.totalSpent || 0) + amount;
                
                member.purchaseHistory = member.purchaseHistory || [];
                member.purchaseHistory.unshift({
                    amount: amount,
                    description: description,
                    date: new Date().toISOString(),
                    pointsEarned: pointsEarned,
                    basePoints: basePoints,
                    multiplier: tier.multiplier
                });
                
                member.activityLog.unshift({
                    type: 'purchase',
                    description: `Purchase: ${description} - UGX ${amount.toLocaleString()}`,
                    date: new Date().toISOString(),
                    points: pointsEarned,
                    details: `Earned ${pointsEarned} points (${basePoints} base √ó ${tier.multiplier}x multiplier)`
                });
                
                const newTierInfo = this.getTier(member);
                const currentTier = member.tier;
                const newTier = newTierInfo.name;
                
                const tierOrder = ['PEARL', 'BRONZE', 'SILVER', 'RUBY', 'GOLD', 'SAPPHIRE', 'PLATINUM'];
                const currentIndex = tierOrder.indexOf(currentTier);
                const newIndex = tierOrder.indexOf(newTier);
                
                if (newIndex > currentIndex) {
                    member.tier = newTier;
                    member.activityLog.unshift({
                        type: 'tier_upgrade',
                        description: `Tier upgraded from ${currentTier} to ${newTier}`,
                        date: new Date().toISOString(),
                        points: member.points
                    });
                }
                
                await this.db.saveMember(member);
                
                try {
                    await this.emailService.sendPurchaseEmail(
                        member.email,
                        member,
                        {
                            amount: amount,
                            description: description,
                            pointsEarned: pointsEarned,
                            basePoints: basePoints,
                            multiplier: tier.multiplier
                        }
                    );
                } catch (emailError) {
                    console.log('Purchase email failed:', emailError);
                }
                
                return {
                    success: true,
                    message: `Purchase recorded! ${pointsEarned} points added (${basePoints} base √ó ${tier.multiplier}x multiplier).`,
                    member: member,
                    pointsEarned: pointsEarned,
                    basePoints: basePoints,
                    multiplier: tier.multiplier
                };
            }

            async deleteMember(jcId) {
                const member = await this.db.getMemberByJCId(jcId);
                
                if (!member) {
                    return { success: false, message: "Member not found" };
                }
                
                const deleted = await this.db.deleteMember(jcId);
                
                if (deleted) {
                    await this.db.unsubscribeFromNewsletter(member.email);
                    
                    return { success: true, message: "Member deleted successfully!" };
                }
                
                return { success: false, message: "Failed to delete member" };
            }

            getTier(member) {
                const points = member.points || 0;
                let currentTier = jeansClubConfig.tiers.PEARL;
                
                for (const [tierName, tierConfig] of Object.entries(jeansClubConfig.tiers)) {
                    if (points >= tierConfig.minPoints && points <= tierConfig.maxPoints) {
                        currentTier = { ...tierConfig, name: tierName };
                        break;
                    }
                }
                
                return currentTier;
            }

            updateMemberTier(member) {
                const points = member.points || 0;
                let newTier = 'PEARL';
                
                for (const [tierName, tierConfig] of Object.entries(jeansClubConfig.tiers)) {
                    if (points >= tierConfig.minPoints && points <= tierConfig.maxPoints) {
                        newTier = tierName;
                        break;
                    }
                }
                
                if (member.tier !== newTier) {
                    const oldTier = member.tier;
                    member.tier = newTier;
                    
                    member.activityLog.unshift({
                        type: 'tier_upgrade',
                        description: `Tier upgraded from ${oldTier} to ${newTier}`,
                        date: new Date().toISOString()
                    });
                }
                
                return member.tier;
            }

            getTierProgress(member) {
                const tier = this.getTier(member);
                const points = member.points || 0;
                
                const progress = Math.min(
                    ((points - tier.minPoints) / (tier.maxPoints - tier.minPoints)) * 100,
                    100
                );
                
                return {
                    currentTier: tier.name,
                    currentPoints: points,
                    minPoints: tier.minPoints,
                    maxPoints: tier.maxPoints,
                    nextTier: this.getNextTier(tier.name),
                    progress: progress,
                    pointsToNext: tier.maxPoints - points + 1
                };
            }

            getNextTier(currentTier) {
                const tierOrder = ['PEARL', 'BRONZE', 'SILVER', 'RUBY', 'GOLD', 'SAPPHIRE', 'PLATINUM'];
                const currentIndex = tierOrder.indexOf(currentTier);
                
                if (currentIndex < tierOrder.length - 1) {
                    return tierOrder[currentIndex + 1];
                }
                
                return null;
            }

            async sendNewsletter(subject, content) {
                try {
                    const subscribers = await this.db.getNewsletterSubscribers(true);
                    
                    if (subscribers.length === 0) {
                        return { success: false, message: "No active subscribers found" };
                    }
                    
                    let successCount = 0;
                    let failCount = 0;
                    
                    for (const subscriber of subscribers) {
                        try {
                            console.log('üìß Sending newsletter to:', subscriber.email);
                            await this.emailService.sendNewsletterEmail(
                                subscriber.email,
                                subject,
                                content,
                                subscriber.name
                            );
                            successCount++;
                            console.log('‚úÖ Newsletter sent to:', subscriber.email);
                        } catch (error) {
                            console.error(`Failed to send to ${subscriber.email}:`, error);
                            failCount++;
                        }
                    }
                    
                    return {
                        success: true,
                        message: `Newsletter sent to ${successCount} subscribers. ${failCount} failed.`
                    };
                } catch (error) {
                    console.error('Newsletter sending error:', error);
                    return { success: false, message: "Failed to send newsletter: " + error.message };
                }
            }

            async createQRRedemption(purchaseAmount) {
                if (!this.currentMember) {
                    return { success: false, message: "You must be logged in to create a redemption" };
                }
                
                const options = qrRedemptionSystem.calculateRedemptionOptions(this.currentMember, purchaseAmount);
                
                if (options.length === 0) {
                    return { 
                        success: false, 
                        message: "No redemption options available for your tier and purchase amount." 
                    };
                }
                
                return {
                    success: true,
                    options: options,
                    member: this.currentMember,
                    purchaseAmount: purchaseAmount
                };
            }

            async generateQRCodeForRedemption(selectedOption, purchaseAmount) {
                if (!this.currentMember) {
                    return { success: false, message: "You must be logged in" };
                }
                
                // üî• FIXED: Wait for redemption creation to complete
                const redemption = await qrRedemptionSystem.createRedemption(
                    this.currentMember,
                    selectedOption,
                    purchaseAmount
                );
                
                if (selectedOption.type === 'points_redemption') {
                    this.currentMember.points -= selectedOption.pointsEquivalent;
                    
                    this.currentMember.activityLog.unshift({
                        type: 'points_redemption_qr',
                        description: `Created QR redemption for ${selectedOption.totalAmount.toLocaleString()} UGX`,
                        date: new Date().toISOString(),
                        points: -selectedOption.pointsEquivalent
                    });
                    
                    await this.db.saveMember(this.currentMember);
                }
                
                return {
                    success: true,
                    redemption: redemption,
                    qrCodeData: redemption.qrCodeData
                };
            }

            async refreshData() {
                if (this.currentMember) {
                    const updatedMember = await this.db.getMemberByJCId(this.currentMember.jcId);
                    if (updatedMember) {
                        this.currentMember = updatedMember;
                        this.saveCurrentMember();
                    }
                }
                return this.currentMember;
            }
        }

        // ===========================
        // INITIALIZATION FUNCTION
        // ===========================
        
        function initializeSystems() {
            // Initialize systems in correct order
            voucherSystem = new VoucherSystem();
            qrRedemptionSystem = new QRRedemptionSystem();
            clubManager = new JeansClubManager();
            
            // Make systems globally available
            window.voucherSystem = voucherSystem;
            window.qrRedemptionSystem = qrRedemptionSystem;
            window.clubManager = clubManager;
            
            console.log("‚úÖ All systems initialized successfully");
        }

        // Google Sign-In Initialization
        function initGoogleSignIn() {
            google.accounts.id.initialize({
                client_id: googleConfig.clientId,
                callback: handleGoogleSignIn,
                auto_select: false,
                cancel_on_tap_outside: true
            });

            google.accounts.id.renderButton(
                document.querySelector('.google-signin-button'),
                {
                    theme: "outline",
                    size: "large",
                    text: "signup_with",
                    shape: "rectangular",
                    logo_alignment: "left"
                }
            );

            google.accounts.id.renderButton(
                document.querySelector('.google-login-button'),
                {
                    theme: "outline",
                    size: "large",
                    text: "signin_with",
                    shape: "rectangular",
                    logo_alignment: "left"
                }
            );
        }

        async function handleGoogleSignIn(response) {
            try {
                const user = jwt_decode(response.credential);
                
                const result = await clubManager.loginWithGoogle(response);
                
                if (result.success) {
                    showDashboard(result.member);
                    showToast("Google login successful! üéâ", "success");
                } else {
                    showToast(result.message, "error");
                }
            } catch (error) {
                console.error('Google sign-in error:', error);
                showToast("Google sign-in failed. Please try again.", "error");
            }
        }

        // UI Functions
        function showSignupScreen() {
            hideAllSections();
            document.getElementById('signupSection').classList.remove('hidden');
        }

        function showLoginScreen() {
            hideAllSections();
            document.getElementById('loginSection').classList.remove('hidden');
        }

        function showPasswordResetScreen() {
            hideAllSections();
            document.getElementById('passwordResetSection').classList.remove('hidden');
        }

        function showDashboard(member = null) {
            hideAllSections();
            document.getElementById('dashboardSection').classList.remove('hidden');
            
            if (member) {
                updateDashboard(member);
            } else if (clubManager.currentMember) {
                updateDashboard(clubManager.currentMember);
            }
        }

        function showAdminPanel() {
            hideAllSections();
            document.getElementById('adminSection').classList.remove('hidden');
            loadAdminData();
        }

        function showDeleteMemberSection() {
            hideAllSections();
            document.getElementById('deleteMemberSection').classList.remove('hidden');
        }

        function showVoucherManagementPanel() {
            hideAllSections();
            document.getElementById('voucherManagementSection').classList.remove('hidden');
            loadAllVouchers();
        }

        function showQRRedemptionPanel() {
            hideAllSections();
            document.getElementById('qrRedemptionSection').classList.remove('hidden');
        }

        function showQRRedemptionManagementPanel() {
            hideAllSections();
            document.getElementById('qrRedemptionManagementSection').classList.remove('hidden');
            loadQRRedemptionData();
        }

        async function signUpWithEmail() {
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const referralCode = document.getElementById('referralCode').value.trim();
            const newsletter = document.getElementById('newsletterSignup').checked;

            if (!name || !email || !password) {
                showToast("Please fill in all required fields", "error");
                return;
            }

            // NEW: Use enhanced email validation with fraud prevention
            const emailValidation = isValidEmailWithFraudPrevention(email);
            if (!emailValidation.valid) {
                showToast(emailValidation.message, "error");
                return;
            }

            const fakeEmails = ['test@test.com', 'example@example.com', 'user@user.com'];
            if (fakeEmails.includes(email.toLowerCase())) {
                showToast("Please use your real email address", "error");
                return;
            }

            if (password.length < 6) {
                showToast("Password must be at least 6 characters", "error");
                return;
            }

            // NEW: Check for self-referral
            if (referralCode) {
                const selfReferral = isSelfReferral(referralCode, email);
                if (selfReferral) {
                    showToast("You cannot use your own referral code. Please remove it or ask a friend for theirs.", "error");
                    return;
                }
            }

            showToast("Creating account...", "info");

            try {
                const result = await clubManager.createAccount(
                    { name, email, newsletter },
                    password,
                    referralCode
                );

                if (result.success) {
                    showDashboard(result.member);
                    showToast("Account created successfully! Welcome to Jeans Club! üéâ", "success");
                    
                    document.getElementById('userName').value = '';
                    document.getElementById('userEmail').value = '';
                    document.getElementById('userPassword').value = '';
                    document.getElementById('referralCode').value = '';
                    
                } else {
                    showToast(result.message, "error");
                }
            } catch (error) {
                console.error('Signup error:', error);
                showToast("An error occurred. Please try again.", "error");
            }
        }

        async function loginWithCredentials() {
            const jcId = document.getElementById('loginJCId').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!jcId || !password) {
                showToast("Please enter JC ID and password", "error");
                return;
            }

            showToast("Logging in...", "info");

            const result = await clubManager.loginWithCredentials(jcId, password);

            if (result.success) {
                showDashboard(result.member);
                showToast("Login successful! üéâ", "success");
            } else {
                showToast(result.message, "error");
            }
        }

        async function showAdminLogin() {
            const adminCode = prompt("Enter admin code:");
            if (!adminCode) return;

            showToast("Logging in as admin...", "info");

            const result = await clubManager.adminLogin(adminCode);

            if (result.success) {
                showAdminPanel();
                showToast("Admin login successful! üëë", "success");
            } else {
                showToast(result.message, "error");
            }
        }

        // Update dashboard with improved mobile card display
        function updateDashboard(member) {
            document.getElementById('memberJcId').textContent = member.jcId;
            document.getElementById('memberName').textContent = member.name;
            document.getElementById('memberEmail').textContent = member.email;
            document.getElementById('memberLoginMethod').textContent = member.loginMethod || 'email';
            document.getElementById('memberPoints').textContent = member.points?.toLocaleString() + ' points';
            document.getElementById('totalSpent').textContent = (member.totalSpent || 0).toLocaleString() + ' UGX';
            document.getElementById('memberReferralCode').textContent = member.referralCode;
            
            const tier = clubManager.getTier(member);
            document.getElementById('memberTier').textContent = `${tier.name} (${member.tier})`;
            
            const progress = clubManager.getTierProgress(member);
            document.getElementById('progressFill').style.width = progress.progress + '%';
            document.getElementById('tierProgressText').textContent = 
                `Progress to ${progress.nextTier || 'max tier'}: ${progress.currentPoints.toLocaleString()}/${progress.maxPoints.toLocaleString()} points`;
            
            const newsletterBtn = document.getElementById('newsletterToggle');
            if (member.newsletterSubscribed !== false) {
                newsletterBtn.textContent = "Unsubscribe from Newsletter";
                newsletterBtn.classList.add('secondary');
            } else {
                newsletterBtn.textContent = "Subscribe to Newsletter";
                newsletterBtn.classList.remove('secondary');
            }
            
            const referrals = member.referrals || [];
            document.getElementById('referralStats').textContent = 
                `You've referred ${referrals.length} members and earned ${referrals.length * 100} bonus points!`;
            
            updateActivityLog(member);
            updateMemberCard(member);
            updateMemberVouchers(member.jcId);
        }

        // Improved mobile card display
        function updateMemberCard(member) {
            const card = document.getElementById('memberCard');
            const tier = member.tier.toLowerCase();
            
            card.className = 'member-card';
            card.classList.add(tier);
            
            const jcId = member.jcId;
            const formattedNumber = jcId.split('').map(char => 
                `<span>${char}</span>`
            ).join('');
            
            document.getElementById('cardNumber').innerHTML = formattedNumber;
            document.getElementById('cardHolderName').textContent = member.name.toUpperCase();
            document.getElementById('cardTier').textContent = member.tier;
            
            const joinDate = new Date(member.joinedDate);
            const month = (joinDate.getMonth() + 1).toString().padStart(2, '0');
            const year = joinDate.getFullYear().toString();
            document.getElementById('cardDate').textContent = `${month}/${year}`;
        }

        function updateActivityLog(member) {
            const activityLog = document.getElementById('activityLog');
            const activities = member.activityLog || [];
            
            if (activities.length === 0) {
                activityLog.innerHTML = '<div class="activity-item">No activity yet</div>';
                return;
            }
            
            activityLog.innerHTML = activities.slice(0, 10).map(activity => `
                <div class="activity-item">
                    <strong>${activity.type}</strong>: ${activity.description}
                    ${activity.points ? ` (${activity.points > 0 ? '+' : ''}${activity.points} points)` : ''}
                    ${activity.details ? `<br><small>${activity.details}</small>` : ''}
                    <br><small>${new Date(activity.date).toLocaleString()}</small>
                </div>
            `).join('');
        }

        function updateMemberVouchers(memberJCId) {
            const vouchersList = document.getElementById('vouchersList');
            const vouchers = voucherSystem.getMemberVouchers(memberJCId);
            
            if (vouchers.length === 0) {
                vouchersList.innerHTML = '<div class="activity-item">No vouchers yet. Redeem your points for a discount voucher!</div>';
                return;
            }
            
            vouchersList.innerHTML = vouchers.map(voucher => {
                const statusClass = voucher.status === 'active' ? 'status-active' : 
                                  voucher.status === 'used' ? 'status-used' : 'status-expired';
                const statusText = voucher.status === 'active' ? 'ACTIVE' :
                                 voucher.status === 'used' ? 'USED' : 'EXPIRED';
                
                // Calculate UGX value from points
                const discountUGX = voucher.pointsUsed * jeansClubConfig.pointValue;
                
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(voucher.qrCodeData)}`;
                
                return `
                    <div class="voucher-item ${voucher.status}">
                        <div class="option-header">
                            <h4>${discountUGX.toLocaleString()} UGX Discount Voucher</h4>
                            <span class="voucher-status ${statusClass}">${statusText}</span>
                        </div>
                        <p><strong>Code:</strong> <span class="voucher-code">${voucher.code}</span></p>
                        <p><strong>Discount:</strong> ${voucher.discountPercentage}% (${discountUGX.toLocaleString()} UGX)</p>
                        <p><strong>Points Used:</strong> ${voucher.pointsUsed} points (${jeansClubConfig.pointValue} UGX per point)</p>
                        <p><strong>Created:</strong> ${new Date(voucher.createdDate).toLocaleDateString()}</p>
                        <p><strong>Expires:</strong> ${new Date(voucher.expiryDate).toLocaleDateString()}</p>
                        ${voucher.status === 'active' ? `
                            <div class="voucher-qr">
                                <img src="${qrCodeUrl}" alt="Voucher QR Code" style="max-width: 150px; border: 1px solid #ddd; border-radius: 5px;">
                                <p style="font-size: 12px; color: #666;">Show this QR code at checkout</p>
                            </div>
                        ` : ''}
                        ${voucher.usedDate ? `<p><strong>Redeemed:</strong> ${new Date(voucher.usedDate).toLocaleDateString()}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function calculateDiscount() {
            const pointsInput = document.getElementById('discountPoints');
            const points = parseInt(pointsInput.value);
            
            // UPDATED: Minimum 4 points (equivalent to 1,000 UGX discount)
            if (!points || points < 4) {
                showToast("Minimum 4 points required for discount (1,000 UGX)", "error");
                return;
            }
            
            const result = clubManager.calculateDiscount(points);
            
            const discountResult = document.getElementById('discountResult');
            if (result.success) {
                discountResult.className = 'discount-result discount-success';
                discountResult.innerHTML = `
                    <h4>Discount Calculation</h4>
                    <p><strong>Points to use:</strong> ${points} points</p>
                    <p><strong>Discount Value:</strong> ${result.discountValue}</p>
                    <p><strong>Point Value:</strong> ${result.pointValue}</p>
                    <p><strong>Discount Percentage:</strong> ${result.discountPercentage}% off</p>
                    <p><strong>Tier Multiplier:</strong> ${result.tierMultiplier}x</p>
                    <p><strong>Maximum Possible:</strong> ${result.maxPossible}</p>
                    <p><small>Minimum 4 points required (1,000 UGX discount)</small></p>
                `;
            } else {
                discountResult.className = 'discount-result discount-error';
                discountResult.textContent = result.message;
            }
        }

        async function redeemPoints() {
            const pointsInput = document.getElementById('discountPoints');
            const points = parseInt(pointsInput.value);
            
            // UPDATED: Minimum 4 points (equivalent to 1,000 UGX discount)
            if (!points || points < 4) {
                showToast("Minimum 4 points required for discount (1,000 UGX)", "error");
                return;
            }
            
            showToast("Creating discount voucher...", "info");
            
            const result = await clubManager.createDiscountVoucher(points);
            
            if (result.success) {
                showToast("Voucher created successfully! Check your email for details.", "success");
                updateDashboard(clubManager.currentMember);
                
                const discountUGX = points * jeansClubConfig.pointValue;
                
                const discountResult = document.getElementById('discountResult');
                discountResult.className = 'discount-result discount-success';
                discountResult.innerHTML = `
                    <h4>üéâ Voucher Created!</h4>
                    <p><strong>Voucher Code:</strong> <span class="voucher-code">${result.voucher.code}</span></p>
                    <p><strong>Discount Value:</strong> ${discountUGX.toLocaleString()} UGX</p>
                    <p><strong>Points Used:</strong> ${points} points</p>
                    <p><strong>Point Value:</strong> ${jeansClubConfig.pointValue} UGX per point</p>
                    <p><strong>Expires:</strong> ${new Date(result.voucher.expiryDate).toLocaleDateString()}</p>
                    <p><small>Check your email for QR code and details</small></p>
                `;
                
                pointsInput.value = '';
            } else {
                showToast(result.message, "error");
            }
        }

        async function toggleNewsletter() {
            if (!clubManager.currentMember) return;
            
            const currentlySubscribed = clubManager.currentMember.newsletterSubscribed !== false;
            const action = currentlySubscribed ? false : true;
            
            showToast("Updating newsletter preferences...", "info");
            
            const result = await clubManager.toggleNewsletter(
                clubManager.currentMember.email,
                action
            );
            
            if (result.success) {
                showToast(result.message, "success");
                updateDashboard(clubManager.currentMember);
            } else {
                showToast(result.message, "error");
            }
        }

        function shareReferral() {
            if (!clubManager.currentMember) return;
            
            const referralCode = clubManager.currentMember.referralCode;
            const message = `Join me on Jeans Club! Use my referral code ${referralCode} to get bonus points when you sign up. Earn 1 point per 1,000 UGX spent, redeem 1 point for 250 UGX discount! Sign up at https://elijah787.github.io/jeans-club`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Join Jeans Club',
                    text: message,
                    url: 'https://elijah787.github.io/jeans-club'
                });
            } else {
                navigator.clipboard.writeText(message);
                showToast("Referral code copied to clipboard! üìã", "success");
            }
        }

        function logout() {
            clubManager.logout();
            showLoginScreen();
            showToast("Logged out successfully", "info");
        }

        async function refreshData() {
            showToast("Refreshing data...", "info");
            const updatedMember = await clubManager.refreshData();
            if (updatedMember) {
                updateDashboard(updatedMember);
                showToast("Data refreshed!", "success");
            } else {
                showToast("Failed to refresh data", "error");
            }
        }

        async function adminAddPurchase() {
            const jcId = document.getElementById('purchaseJCId').value.trim();
            const amount = parseFloat(document.getElementById('purchaseAmount').value);
            const description = document.getElementById('purchaseDescription').value.trim();
            
            if (!jcId || !amount || !description) {
                showToast("Please fill in all fields", "error");
                return;
            }
            
            if (amount <= 0) {
                showToast("Amount must be positive", "error");
                return;
            }
            
            showToast("Recording purchase...", "info");
            
            const result = await clubManager.addPurchase(jcId, amount, description);
            
            const purchaseResult = document.getElementById('purchaseResult');
            if (result.success) {
                purchaseResult.className = 'success-message';
                purchaseResult.innerHTML = `
                    <strong>Success!</strong> ${result.message}<br>
                    <small>Member: ${result.member.name} (${result.member.jcId})</small><br>
                    <small>Base Points: ${result.basePoints} (1 point per 1,000 UGX)</small><br>
                    <small>Multiplier: ${result.multiplier}x</small><br>
                    <small>Total Points Earned: ${result.pointsEarned}</small>
                `;
                
                document.getElementById('purchaseJCId').value = '';
                document.getElementById('purchaseAmount').value = '';
                document.getElementById('purchaseDescription').value = '';
                
                loadAdminData();
            } else {
                purchaseResult.className = 'error-message';
                purchaseResult.textContent = result.message;
            }
        }

        async function sendNewsletter() {
            const subject = document.getElementById('newsletterSubject').value.trim();
            const content = document.getElementById('newsletterContent').value.trim();
            
            if (!subject || !content) {
                showToast("Please fill in subject and content", "error");
                return;
            }
            
            if (!confirm(`Send newsletter to all subscribers? This will send to everyone subscribed to the newsletter.`)) {
                return;
            }
            
            showToast("Sending newsletter... This may take a moment.", "info");
            
            const result = await clubManager.sendNewsletter(subject, content);
            
            const newsletterResult = document.getElementById('newsletterResult');
            if (result.success) {
                newsletterResult.className = 'success-message';
                newsletterResult.textContent = result.message;
                
                document.getElementById('newsletterSubject').value = '';
                document.getElementById('newsletterContent').value = '';
            } else {
                newsletterResult.className = 'error-message';
                newsletterResult.textContent = result.message;
            }
        }

        async function loadAdminData() {
            const adminContent = document.getElementById('adminContent');
            adminContent.innerHTML = '<div class="activity-item">Loading members...</div>';
            
            try {
                const members = await clubManager.db.getAllMembers();
                
                if (members.length === 0) {
                    adminContent.innerHTML = '<div class="activity-item">No members yet</div>';
                    return;
                }
                
                adminContent.innerHTML = `
                    <div class="info-card">
                        <h3>All Members (${members.length})</h3>
                        <div class="members-list">
                            ${members.map(member => `
                                <div class="admin-card">
                                    <h4>${member.name} <small style="color: #666;">(${member.jcId})</small></h4>
                                    <p><strong>Email:</strong> ${member.email}</p>
                                    <p><strong>Normalized Email:</strong> ${member.normalized_email || 'Not set'}</p>
                                    <p><strong>Tier:</strong> ${member.tier}</p>
                                    <p><strong>Points:</strong> ${member.points?.toLocaleString() || 0} (${jeansClubConfig.pointValue} UGX per point)</p>
                                    <p><strong>Total Spent:</strong> ${(member.totalSpent || 0).toLocaleString()} UGX</p>
                                    <p><strong>Points Earned:</strong> ${((member.totalSpent || 0) * jeansClubConfig.earningRate).toFixed(0)} points (approx)</p>
                                    <p><strong>IP Address:</strong> ${member.ip_address || 'Not logged'}</p>
                                    <p><strong>Joined:</strong> ${new Date(member.joinedDate).toLocaleDateString()}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading admin data:', error);
                adminContent.innerHTML = '<div class="activity-item error-message">Error loading members</div>';
            }
        }

        async function confirmDeleteMember() {
            const jcId = document.getElementById('deleteJCId').value.trim();
            
            if (!jcId) {
                showToast("Please enter JC ID", "error");
                return;
            }
            
            if (!confirm(`Are you absolutely sure you want to delete member ${jcId}? This action cannot be undone!`)) {
                return;
            }
            
            showToast("Deleting member...", "info");
            
            const result = await clubManager.deleteMember(jcId);
            
            const deleteResult = document.getElementById('deleteResult');
            if (result.success) {
                deleteResult.className = 'success-message';
                deleteResult.textContent = result.message;
                document.getElementById('deleteJCId').value = '';
            } else {
                deleteResult.className = 'error-message';
                deleteResult.textContent = result.message;
            }
        }

        async function loadAllVouchers() {
            const allVouchersList = document.getElementById('allVouchersList');
            allVouchersList.innerHTML = '<div class="activity-item">Loading vouchers...</div>';
            
            const stats = voucherSystem.getVoucherStats();
            document.getElementById('voucherStats').innerHTML = `
                <p><strong>Total Vouchers:</strong> ${stats.total}</p>
                <p><strong>Active:</strong> ${stats.active}</p>
                <p><strong>Used:</strong> ${stats.used}</p>
                <p><strong>Expired:</strong> ${stats.expired}</p>
                <p><strong>Redemption Rate:</strong> ${stats.redemptionRate}</p>
                <p><strong>Average Discount:</strong> ${stats.avgDiscount}%</p>
                <p><strong>Point Value:</strong> ${jeansClubConfig.pointValue} UGX per point</p>
            `;
            
            const vouchers = voucherSystem.getAllVouchers();
            
            if (vouchers.length === 0) {
                allVouchersList.innerHTML = '<div class="activity-item">No vouchers yet</div>';
                return;
            }
            
            allVouchersList.innerHTML = vouchers.map(voucher => {
                const statusClass = voucher.status === 'active' ? 'status-active' : 
                                  voucher.status === 'used' ? 'status-used' : 'status-expired';
                const statusText = voucher.status === 'active' ? 'ACTIVE' :
                                 voucher.status === 'used' ? 'USED' : 'EXPIRED';
                
                // Calculate UGX value from points
                const discountUGX = voucher.pointsUsed * jeansClubConfig.pointValue;
                
                return `
                    <div class="voucher-item ${voucher.status}">
                        <div class="option-header">
                            <h4>${voucher.memberName} (${voucher.memberJCId})</h4>
                            <span class="voucher-status ${statusClass}">${statusText}</span>
                        </div>
                        <p><strong>Voucher:</strong> <span class="voucher-code">${voucher.code}</span></p>
                        <p><strong>Discount Value:</strong> ${discountUGX.toLocaleString()} UGX</p>
                        <p><strong>Discount Percentage:</strong> ${voucher.discountPercentage}%</p>
                        <p><strong>Points Used:</strong> ${voucher.pointsUsed} (${jeansClubConfig.pointValue} UGX per point)</p>
                        <p><strong>Created:</strong> ${new Date(voucher.createdDate).toLocaleDateString()}</p>
                        <p><strong>Expires:</strong> ${new Date(voucher.expiryDate).toLocaleDateString()}</p>
                        ${voucher.usedDate ? `
                            <p><strong>Redeemed:</strong> ${new Date(voucher.usedDate).toLocaleDateString()}</p>
                            <p><strong>Redeemed By:</strong> ${voucher.redeemedBy || 'system'}</p>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        async function refreshVouchers() {
            showToast("Refreshing vouchers...", "info");
            loadAllVouchers();
            showToast("Vouchers refreshed!", "success");
        }

        async function requestPasswordReset() {
            const jcId = document.getElementById('resetJCId').value.trim();
            
            if (!jcId) {
                showToast("Please enter your JC ID", "error");
                return;
            }
            
            showToast("Sending reset code...", "info");
            
            const result = await clubManager.requestPasswordReset(jcId);
            
            const resetRequestResult = document.getElementById('resetRequestResult');
            if (result.success) {
                resetRequestResult.className = 'success-message';
                resetRequestResult.textContent = result.message;
                
                document.getElementById('resetForm').classList.remove('hidden');
            } else {
                resetRequestResult.className = 'error-message';
                resetRequestResult.textContent = result.message;
            }
        }

        async function executePasswordReset() {
            const jcId = document.getElementById('resetJCId').value.trim();
            const resetToken = document.getElementById('resetToken').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!jcId || !resetToken || !newPassword || !confirmPassword) {
                showToast("Please fill in all fields", "error");
                return;
            }
            
            if (newPassword.length < 6) {
                showToast("Password must be at least 6 characters", "error");
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast("Passwords do not match", "error");
                return;
            }
            
            showToast("Resetting password...", "info");
            
            const result = await clubManager.executePasswordReset(jcId, resetToken, newPassword);
            
            const resetExecuteResult = document.getElementById('resetExecuteResult');
            if (result.success) {
                resetExecuteResult.className = 'success-message';
                resetExecuteResult.textContent = result.message;
                
                document.getElementById('resetToken').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                setTimeout(() => {
                    document.getElementById('resetForm').classList.add('hidden');
                    resetExecuteResult.textContent = '';
                    showLoginScreen();
                }, 3000);
            } else {
                resetExecuteResult.className = 'error-message';
                resetExecuteResult.textContent = result.message;
            }
        }

        // QR Redemption Functions
        let selectedOptionIndex = -1;
        let currentRedemptionOptions = [];
        let currentPurchaseAmount = 0;

        async function calculateRedemptionOptions() {
            const purchaseAmount = parseFloat(document.getElementById('qrPurchaseAmount').value);
            
            if (!purchaseAmount || purchaseAmount <= 0) {
                showToast("Please enter a valid purchase amount", "error");
                return;
            }
            
            currentPurchaseAmount = purchaseAmount;
            
            showToast("Calculating redemption options...", "info");
            
            if (!clubManager.currentMember) {
                showToast("You must be logged in", "error");
                return;
            }
            
            const member = clubManager.currentMember;
            const memberPoints = member.points || 0;
            currentRedemptionOptions = qrRedemptionSystem.calculateRedemptionOptions(
                clubManager.currentMember, 
                purchaseAmount
            );
            
            if (!currentRedemptionOptions || currentRedemptionOptions.length === 0) {
                const redemptionOptions = document.getElementById('redemptionOptions');
                redemptionOptions.innerHTML = `
                    <div class="info-card">
                        <p>No redemption options available for your purchase amount and tier.</p>
                        <p><small>Pearl members only have discount voucher options. Higher tiers have pay-with-points options.</small></p>
                        <p><small>You may need to:</small></p>
                        <ul>
                            <li>Have at least 4 points for discount vouchers (1,000 UGX)</li>
                            <li>Meet spending thresholds for pay-with-points (higher tiers)</li>
                            <li>Earn more points through purchases</li>
                        </ul>
                    </div>
                `;
                selectedOptionIndex = -1;
                return;
            }
            
            const redemptionOptions = document.getElementById('redemptionOptions');
            redemptionOptions.innerHTML = currentRedemptionOptions.map((option, index) => {
                let optionHTML = '';
                
                if (option.type === 'points_redemption') {
                    optionHTML = `
                        <div class="redemption-option" onclick="selectRedemptionOption(${index})">
                            <div class="option-header">
                                <h4>üí∞ Pay with Points</h4>
                                <span class="option-tier tier-${option.tier.toLowerCase()}">${option.tier}</span>
                            </div>
                            <p><strong>Available:</strong> ${option.maxRedemption.toLocaleString()} UGX</p>
                            <p><strong>Points Equivalent:</strong> ${option.pointsEquivalent.toLocaleString()} points</p>
                            <p><strong>Description:</strong> ${option.description}</p>
                            <p><strong>Value:</strong> ${option.pointsValue} points multiplier</p>
                            <p><small>Uses your accumulated points for purchase credit</small></p>
                        </div>
                    `;
                } else if (option.type === 'discount_voucher') {
                    optionHTML = `
                        <div class="redemption-option" onclick="selectRedemptionOption(${index})">
                            <div class="option-header">
                                <h4>üé´ Discount Voucher</h4>
                                <span class="option-tier tier-${option.tier.toLowerCase()}">${option.tier}</span>
                            </div>
                            <p><strong>Discount Amount:</strong> ${option.discountAmount.toLocaleString()} UGX</p>
                            <p><strong>Discount Percentage:</strong> ${option.discountPercentage}%</p>
                            <p><strong>Applicable Amount:</strong> ${option.applicableAmount.toLocaleString()} UGX</p>
                            <p><strong>Points Required:</strong> ${option.pointsRequired.toLocaleString()} points</p>
                            <p><small>Get a fixed discount voucher for future use</small></p>
                        </div>
                    `;
                }
                
                return optionHTML;
            }).join('');
            
            selectedOptionIndex = -1;
            showToast(`${currentRedemptionOptions.length} redemption options available`, "success");
        }

        function selectRedemptionOption(index) {
            selectedOptionIndex = index;
            
            currentPurchaseAmount = parseFloat(document.getElementById('qrPurchaseAmount').value);
            
            if (!currentPurchaseAmount || currentPurchaseAmount <= 0) {
                showToast("Please enter a valid purchase amount first", "error");
                return;
            }
            
            currentRedemptionOptions = qrRedemptionSystem.calculateRedemptionOptions(
                clubManager.currentMember, 
                currentPurchaseAmount
            );
            
            if (!currentRedemptionOptions || currentRedemptionOptions.length === 0) {
                showToast("No redemption options available", "error");
                return;
            }
            
            if (index < 0 || index >= currentRedemptionOptions.length) {
                showToast("Invalid option selected", "error");
                return;
            }
            
            document.querySelectorAll('.redemption-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            const allOptions = document.querySelectorAll('.redemption-option');
            if (allOptions[index]) {
                allOptions[index].classList.add('selected');
            }
            
            const selectedOption = currentRedemptionOptions[index];
            const selectedOptionDetails = document.getElementById('selectedOptionDetails');
            
            let detailsHTML = '';
            if (selectedOption.type === 'points_redemption') {
                detailsHTML = `
                    <div class="selected-option-details">
                        <h4>üí∞ Pay with Points Selected</h4>
                        <p><strong>Tier:</strong> ${selectedOption.tier}</p>
                        <p><strong>Maximum Redemption:</strong> ${selectedOption.maxRedemption.toLocaleString()} UGX</p>
                        <p><strong>Points Required:</strong> ${selectedOption.pointsEquivalent.toLocaleString()} points</p>
                        <p><strong>Description:</strong> ${selectedOption.description}</p>
                        <p><strong>Your Points Balance:</strong> ${clubManager.currentMember.points.toLocaleString()} points</p>
                        <p><strong>Points After Redemption:</strong> ${(clubManager.currentMember.points - selectedOption.pointsEquivalent).toLocaleString()} points</p>
                        <button class="btn" onclick="generateQRCode()" style="margin-top: 15px;">
                            Generate QR Code
                        </button>
                    </div>
                `;
            } else if (selectedOption.type === 'discount_voucher') {
                detailsHTML = `
                    <div class="selected-option-details">
                        <h4>üé´ Discount Voucher Selected</h4>
                        <p><strong>Discount Amount:</strong> ${selectedOption.discountAmount.toLocaleString()} UGX</p>
                        <p><strong>Discount Percentage:</strong> ${selectedOption.discountPercentage}%</p>
                        <p><strong>Applicable Purchase:</strong> ${selectedOption.applicableAmount.toLocaleString()} UGX</p>
                        <p><strong>Points Required:</strong> ${selectedOption.pointsRequired.toLocaleString()} points</p>
                        <p><strong>Your Points Balance:</strong> ${clubManager.currentMember.points.toLocaleString()} points</p>
                        <p><strong>Points After Redemption:</strong> ${(clubManager.currentMember.points - selectedOption.pointsRequired).toLocaleString()} points</p>
                        <button class="btn" onclick="generateQRCode()" style="margin-top: 15px;">
                            Generate QR Code
                        </button>
                    </div>
                `;
            }
            
            selectedOptionDetails.innerHTML = detailsHTML;
        }

        async function generateQRCode() {
            try {
                if (selectedOptionIndex === -1) {
                    showToast("Please select a redemption option first", "error");
                    return { success: false, message: "No option selected" };
                }
                
                if (!clubManager.currentMember) {
                    showToast("You must be logged in", "error");
                    return { success: false, message: "Not logged in" };
                }
                
                const selectedOption = currentRedemptionOptions[selectedOptionIndex];
                const purchaseAmount = currentPurchaseAmount;
                
                const memberPoints = clubManager.currentMember.points || 0;
                let pointsNeeded = 0;
                
                if (selectedOption.type === 'points_redemption') {
                    pointsNeeded = selectedOption.pointsEquivalent || 0;
                } else if (selectedOption.type === 'discount_voucher') {
                    pointsNeeded = selectedOption.pointsRequired || 0;
                }
                
                if (memberPoints < pointsNeeded) {
                    const errorMsg = `‚ùå Insufficient points! You have ${memberPoints.toLocaleString()} points, but need ${pointsNeeded.toLocaleString()} points for this redemption.`;
                    showToast(errorMsg, "error");
                    
                    selectedOptionIndex = -1;
                    document.querySelectorAll('.redemption-option').forEach(el => {
                        el.classList.remove('selected');
                    });
                    document.getElementById('selectedOptionDetails').innerHTML = `
                        <div class="info-card">
                            <p style="color: #dc3545;">${errorMsg}</p>
                            <p>Please select a different option or add more points to your account.</p>
                        </div>
                    `;
                    
                    return { success: false, message: errorMsg };
                }
                
                showToast("Generating QR code...", "info");
                
                // üî• FIXED: Wait for redemption creation
                const redemption = await qrRedemptionSystem.createRedemption(
                    clubManager.currentMember,
                    selectedOption,
                    purchaseAmount
                );
                
                if (!redemption) {
                    showToast("Failed to create redemption", "error");
                    return { success: false, message: "Redemption creation failed" };
                }
                
                const oldPoints = clubManager.currentMember.points;
                const currentTier = clubManager.currentMember.tier;
                
                clubManager.currentMember.points -= pointsNeeded;
                clubManager.currentMember.tier = currentTier;
                
                clubManager.currentMember.activityLog.unshift({
                    type: 'points_redemption_qr',
                    description: `QR redemption: ${selectedOption.description}`,
                    date: new Date().toISOString(),
                    points: -pointsNeeded
                });
                
                const saved = await clubManager.db.saveMember(clubManager.currentMember);
                if (!saved) {
                    clubManager.currentMember.points = oldPoints;
                    showToast("Failed to save points deduction", "error");
                    return { success: false, message: "Database save failed" };
                }
                
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(redemption.qrCodeData)}`;
                
                const qrCodeContainer = document.getElementById('qrCodeContainer');
                qrCodeContainer.innerHTML = `
                    <div class="qr-code-container">
                        <h4>üéâ Redemption QR Code</h4>
                        <img src="${qrCodeUrl}" alt="Redemption QR Code" style="max-width: 250px; margin: 15px 0;">
                        <p><strong>QR Code ID:</strong> ${redemption.redemptionId}</p>
                        <p><strong>Type:</strong> ${selectedOption.type === 'points_redemption' ? 'Pay with Points (starts with RED)' : 'Discount Voucher (starts with JC)'}</p>
                        <p><strong>Amount:</strong> ${purchaseAmount.toLocaleString()} UGX</p>
                        <p><strong>Option:</strong> ${selectedOption.description}</p>
                        <p><strong>Points Deducted:</strong> ${pointsNeeded.toLocaleString()}</p>
                        <p><strong>Remaining Points:</strong> ${clubManager.currentMember.points.toLocaleString()}</p>
                        <p><strong>Point Value:</strong> ${jeansClubConfig.pointValue} UGX per point</p>
                        <p><strong>Your Tier:</strong> ${currentTier} (unchanged)</p>
                        <p style="font-size: 12px; color: #666; margin-top: 15px;">
                            Show this QR code to our staff at checkout. It's valid for 24 hours.
                        </p>
                    </div>
                `;
                
                showToast("QR code generated successfully! Show this to staff.", "success");
                
                document.getElementById('qrRedemptionResult').innerHTML = `
                    <div class="success-card">
                        <h4>‚úÖ QR Redemption Created!</h4>
                        <p>Your QR code has been generated successfully. Show it to our staff at checkout.</p>
                        <p><strong>QR Code ID:</strong> ${redemption.redemptionId}</p>
                        <p><strong>Type:</strong> ${selectedOption.type === 'points_redemption' ? 'Pay with Points' : 'Discount Voucher'}</p>
                        <p><strong>Status:</strong> Pending redemption</p>
                        <p><strong>Points Deducted:</strong> ${pointsNeeded.toLocaleString()}</p>
                        <p><strong>Point Value:</strong> ${jeansClubConfig.pointValue} UGX per point</p>
                        <p><strong>Remaining Points:</strong> ${clubManager.currentMember.points.toLocaleString()}</p>
                        <p><strong>Your Tier:</strong> ${currentTier} (no downgrade)</p>
                        <button class="btn" onclick="showDashboard(clubManager.currentMember)" style="margin-top: 10px;">
                            Back to Dashboard
                        </button>
                    </div>
                `;
                
                selectedOptionIndex = -1;
                document.querySelectorAll('.redemption-option').forEach(el => {
                    el.classList.remove('selected');
                });
                document.getElementById('selectedOptionDetails').innerHTML = `
                    <div class="info-card">
                        <p>Please calculate new options for another redemption.</p>
                    </div>
                `;
                
                return { success: true, redemption: redemption };
                
            } catch (error) {
                console.error("Error generating QR code:", error);
                showToast("Error generating QR code: " + error.message, "error");
                return { success: false, message: error.message };
            }
        }

        async function loadQRRedemptionData() {
            const stats = await qrRedemptionSystem.getRedemptionStats();
            document.getElementById('qrRedemptionStats').innerHTML = `
                <div class="info-card">
                    <h4>Redemption Statistics</h4>
                    <p><strong>Total Redemptions:</strong> ${stats.total}</p>
                    <p><strong>Pending:</strong> ${stats.pending}</p>
                    <p><strong>Completed:</strong> ${stats.completed}</p>
                    <p><strong>Expired:</strong> ${stats.expired}</p>
                    <p><strong>Completion Rate:</strong> ${stats.completionRate}</p>
                    <p><strong>Total Value Redeemed:</strong> ${stats.totalValue.toLocaleString()} UGX</p>
                    <p><strong>Point Value:</strong> ${jeansClubConfig.pointValue} UGX per point</p>
                </div>
            `;
            
            const allRedemptions = await qrRedemptionSystem.getAllRedemptions();
            const allRedemptionsList = document.getElementById('allRedemptionsList');
            
            if (allRedemptions.length === 0) {
                allRedemptionsList.innerHTML = '<div class="activity-item">No redemptions yet</div>';
                return;
            }
            
            allRedemptionsList.innerHTML = allRedemptions.map(redemption => {
                const statusClass = redemption.status === 'completed' ? 'status-active' : 
                                  redemption.status === 'expired' ? 'status-expired' : 'status-used';
                const statusText = redemption.status === 'completed' ? 'COMPLETED' :
                                 redemption.status === 'expired' ? 'EXPIRED' : 'PENDING';
                
                return `
                    <div class="redemption-item">
                        <div class="option-header">
                            <h4>${redemption.memberName} (${redemption.memberJCId})</h4>
                            <span class="redemption-status ${statusClass}">${statusText}</span>
                        </div>
                        <p><strong>Redemption ID:</strong> <span class="redemption-id">${redemption.redemptionId}</span></p>
                        <p><strong>Type:</strong> ${redemption.selectedOption && redemption.selectedOption.type === 'points_redemption' ? 'Pay with Points (RED)' : 'Discount Voucher (JC)'}</p>
                        <p><strong>Purchase Amount:</strong> ${redemption.purchaseAmount.toLocaleString()} UGX</p>
                        <p><strong>Option:</strong> ${redemption.selectedOption ? redemption.selectedOption.description : 'N/A'}</p>
                        <p><strong>Created:</strong> ${new Date(redemption.createdDate).toLocaleString()}</p>
                        ${redemption.redeemedDate ? `
                            <p><strong>Redeemed:</strong> ${new Date(redemption.redeemedDate).toLocaleString()}</p>
                            <p><strong>Redeemed By:</strong> ${redemption.redeemedBy}</p>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Process scan data - FIXED VERSION with snake_case support
        async function processScanData(qrData, salespersonName) {
            try {
                console.log("üîç Processing scan data:", qrData);
                console.log("üßë Salesperson:", salespersonName);
                
                // Check if it's a pay-with-points QR code (starts with RED)
                if (qrData.startsWith('RED')) {
                    console.log("üí∞ Detected Pay-with-Points QR code (RED)");
                    const redemptionResult = await qrRedemptionSystem.processRedemption(qrData, salespersonName);
                    console.log("üìä Redemption result:", redemptionResult);
                    
                    if (redemptionResult.success) {
                        return {
                            success: true,
                            type: 'points_redemption',
                            message: redemptionResult.message,
                            data: redemptionResult.redemption,
                            status: 'VERIFIED'
                        };
                    } else {
                        console.log("‚ùå Redemption failed:", redemptionResult.message);
                    }
                }
                // Check if it's a discount voucher (starts with JC)
                else if (qrData.startsWith('JC')) {
                    console.log("üé´ Detected Discount Voucher QR code (JC)");
                    const voucherResult = await voucherSystem.redeemVoucher(qrData, salespersonName);
                    console.log("üìä Voucher result:", voucherResult);
                    
                    if (voucherResult.success) {
                        return {
                            success: true,
                            type: 'voucher',
                            message: voucherResult.message,
                            data: voucherResult.voucher,
                            status: 'VERIFIED'
                        };
                    } else {
                        console.log("‚ùå Voucher redemption failed:", voucherResult.message);
                    }
                }
                // Try both systems as fallback
                else {
                    console.log("üîç Unknown QR format, trying both systems...");
                    
                    // First try voucher
                    const voucherResult = await voucherSystem.redeemVoucher(qrData, salespersonName);
                    console.log("üìä Voucher fallback result:", voucherResult);
                    
                    if (voucherResult.success) {
                        return {
                            success: true,
                            type: 'voucher',
                            message: voucherResult.message,
                            data: voucherResult.voucher,
                            status: 'VERIFIED'
                        };
                    }
                    
                    // Then try redemption
                    const redemptionResult = await qrRedemptionSystem.processRedemption(qrData, salespersonName);
                    console.log("üìä Redemption fallback result:", redemptionResult);
                    
                    if (redemptionResult.success) {
                        return {
                            success: true,
                            type: redemptionResult.type || 'redemption',
                            message: redemptionResult.message,
                            data: redemptionResult.redemption || redemptionResult.voucher,
                            status: 'VERIFIED'
                        };
                    }
                }
                
                // If not found in local storage, check Supabase
                console.log("‚òÅÔ∏è Checking Supabase for code...");
                
                // First check vouchers in Supabase
                if (window.supabaseDbInstance) {
                    const { supabase } = window.supabaseDbInstance;
                    const { data: supabaseVoucher, error: voucherError } = await supabase
                        .from('vouchers')
                        .select('*')
                        .eq('code', qrData)
                        .single();
                        
                    if (supabaseVoucher && !voucherError) {
                        console.log("‚úÖ Found voucher in Supabase:", supabaseVoucher);
                        // Try to redeem it
                        const voucherResult = await voucherSystem.redeemVoucher(qrData, salespersonName);
                        if (voucherResult.success) {
                            return {
                                success: true,
                                type: 'voucher',
                                message: voucherResult.message,
                                data: voucherResult.voucher,
                                status: 'VERIFIED'
                            };
                        }
                    }
                    
                    // Then check redemptions in Supabase
                    const { data: supabaseRedemption, error: redemptionError } = await supabase
                        .from('redemptions')
                        .select('*')
                        .eq('redemption_id', qrData) // Using snake_case column name
                        .single();
                        
                    if (supabaseRedemption && !redemptionError) {
                        console.log("‚úÖ Found redemption in Supabase:", supabaseRedemption);
                        // Try to redeem it
                        const redemptionResult = await qrRedemptionSystem.processRedemption(qrData, salespersonName);
                        if (redemptionResult.success) {
                            return {
                                success: true,
                                type: redemptionResult.type || 'redemption',
                                message: redemptionResult.message,
                                data: redemptionResult.redemption || redemptionResult.voucher,
                                status: 'VERIFIED'
                            };
                        }
                    }
                }
                
                console.log("‚ùå QR code not found anywhere");
                return {
                    success: false,
                    message: "Invalid QR code. Not found in system.",
                    status: 'REJECTED'
                };
                
            } catch (error) {
                console.error("‚ùå Scan processing error:", error);
                return {
                    success: false,
                    message: "Error processing QR code: " + error.message,
                    status: 'REJECTED'
                };
            }
        }

        // Display scan results
        function displayScanResults(result, success) {
            const resultsDiv = document.getElementById('scanResults');
            if (!resultsDiv) return;
            
            resultsDiv.classList.remove('hidden');
            
            if (success) {
                resultsDiv.className = 'scan-results success';
                
                let detailsHtml = '';
                if (result.type === 'voucher') {
                    const voucher = result.data;
                    const discountUGX = voucher.pointsUsed * jeansClubConfig.pointValue;
                    detailsHtml = `
                        <h4>‚úÖ Voucher ${result.status}!</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <strong>Voucher Code</strong>
                                <div>${voucher.code} (Discount Voucher)</div>
                            </div>
                            <div class="detail-item">
                                <strong>Member</strong>
                                <div>${voucher.memberName} (${voucher.memberJCId})</div>
                            </div>
                            <div class="detail-item">
                                <strong>Discount Value</strong>
                                <div>${discountUGX.toLocaleString()} UGX</div>
                            </div>
                            <div class="detail-item">
                                <strong>Discount Percentage</strong>
                                <div>${voucher.discountPercentage}%</div>
                            </div>
                            <div class="detail-item">
                                <strong>Points Used</strong>
                                <div>${voucher.pointsUsed} points (${jeansClubConfig.pointValue} UGX per point)</div>
                            </div>
                            <div class="detail-item">
                                <strong>Status</strong>
                                <div style="color: #28a745; font-weight: bold;">${result.status}</div>
                            </div>
                            <div class="detail-item">
                                <strong>Redeemed By</strong>
                                <div>${voucher.redeemedBy}</div>
                            </div>
                            <div class="detail-item">
                                <strong>Date</strong>
                                <div>${new Date(voucher.usedDate).toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                } else if (result.type === 'points_redemption') {
                    const redemption = result.data;
                    detailsHtml = `
                        <h4>‚úÖ Pay-with-Points Redemption ${result.status}!</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <strong>Redemption ID</strong>
                                <div>${redemption.redemptionId} (Pay with Points)</div>
                            </div>
                            <div class="detail-item">
                                <strong>Member</strong>
                                <div>${redemption.memberName} (${redemption.memberJCId})</div>
                            </div>
                            <div class="detail-item">
                                <strong>Purchase Amount</strong>
                                <div>${redemption.purchaseAmount.toLocaleString()} UGX</div>
                            </div>
                            <div class="detail-item">
                                <strong>Redemption Type</strong>
                                <div>Pay with Points (RED code)</div>
                            </div>
                            <div class="detail-item">
                                <strong>Point Value</strong>
                                <div>${jeansClubConfig.pointValue} UGX per point</div>
                            </div>
                            <div class="detail-item">
                                <strong>Status</strong>
                                <div style="color: #28a745; font-weight: bold;">${result.status}</div>
                            </div>
                            <div class="detail-item">
                                <strong>Redeemed By</strong>
                                <div>${redemption.redeemedBy}</div>
                            </div>
                            <div class="detail-item">
                                <strong>Date</strong>
                                <div>${new Date(redemption.redeemedDate).toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                }
                
                resultsDiv.innerHTML = detailsHtml;
            } else {
                resultsDiv.className = 'scan-results error';
                resultsDiv.innerHTML = `
                    <h4>‚ùå Scan ${result.status}</h4>
                    <p><strong>Error:</strong> ${result.message}</p>
                    <p>Please try again or enter the code manually.</p>
                `;
            }
        }

        // Process scan manually - FIXED
        async function processScan() {
            const qrData = document.getElementById('voucherCodeInput').value.trim();
            const salespersonName = document.getElementById('salespersonName').value.trim();
            
            if (!qrData) {
                showToast("Please enter a voucher code or QR data", "error");
                return;
            }
            
            if (!salespersonName) {
                showToast("Please enter your name", "error");
                return;
            }
            
            showToast("Processing scan...", "info");
            
            const result = await processScanData(qrData, salespersonName);
            
            if (result.success) {
                showToast(result.message, "success");
                displayScanResults(result, true);
            } else {
                showToast(result.message, "error");
                displayScanResults(result, false);
            }
        }

        // Enhanced email validation function
        function isValidEmail(email) {
            if (!email || typeof email !== 'string') return false;
            
            const trimmedEmail = email.trim();
            if (trimmedEmail.length < 8) return false;
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(trimmedEmail)) return false;
            
            const [localPart, domain] = trimmedEmail.toLowerCase().split('@');
            if (localPart.length === 0 || localPart.length > 64) return false;
            
            const localPartRegex = /^[a-zA-Z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&'*+/=?^_`{|}~-]+)*$/;
            if (!localPartRegex.test(localPart)) return false;
            
            if (domain.length < 4) return false;
            const domainParts = domain.split('.');
            if (domainParts.length < 2) return false;
            
            for (const part of domainParts) {
                if (part.length === 0 || part.length > 63) return false;
                if (!/^[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]$/.test(part)) return false;
            }
            
            const commonDomains = ['gmail.com', 'yahoo.com', 'outlook.com', 'hotmail.com', 'icloud.com', 'protonmail.com'];
            const domainWithoutTld = domain.slice(0, domain.lastIndexOf('.'));
            
            for (const commonDomain of commonDomains) {
                const commonDomainWithoutTld = commonDomain.slice(0, commonDomain.lastIndexOf('.'));
                if (domainWithoutTld === commonDomainWithoutTld) {
                    const expectedTld = commonDomain.slice(commonDomain.lastIndexOf('.') + 1);
                    const actualTld = domainParts[domainParts.length - 1];
                    
                    if (actualTld !== expectedTld) {
                        return false;
                    }
                }
            }
            
            const tld = domainParts[domainParts.length - 1];
            const validCommonTlds = ['com', 'org', 'net', 'edu', 'gov', 'mil', 'io', 'co', 'uk', 'us', 
                                   'ca', 'au', 'de', 'fr', 'jp', 'cn', 'in', 'br', 'ru', 'it', 'es', 
                                   'mx', 'kr', 'za', 'ng', 'ke', 'tz', 'ug'];
            
            if (tld.length <= 2 && !validCommonTlds.includes(tld.toLowerCase())) {
                return false;
            }
            
            if (tld.length < 2) return false;
            
            const fakePatterns = [
                'test@', 'example@', 'fake@', 'admin@', 'user@', 'temp@', 'dummy@',
                'a@a.a', 'aa@aa.aa', 'aaa@aaa.aaa',
                'con', 'c', 'com',
            ];
            
            const lowerEmail = trimmedEmail.toLowerCase();
            for (const pattern of fakePatterns) {
                if (lowerEmail.includes(pattern) && trimmedEmail.length < 10) {
                    return false;
                }
            }
            
            if (trimmedEmail.includes('..')) return false;
            if (trimmedEmail.includes('@@')) return false;
            if (trimmedEmail.startsWith('.') || trimmedEmail.endsWith('.')) return false;
            if (trimmedEmail.startsWith('@') || trimmedEmail.endsWith('@')) return false;
            
            if (/(\w)\1\1/.test(localPart)) {
                return false;
            }
            
            return true;
        }
         
        // Toast notification system
        function showToast(message, type = "info") {
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Add CSS for toast animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Information Page Functions
        function showMembershipInfo() {
            hideAllSections();
            document.getElementById('membershipInfoPage').classList.remove('hidden');
            toggleMobileMenu();
        }

        function showBenefits() {
            hideAllSections();
            document.getElementById('benefitsInfoPage').classList.remove('hidden');
            toggleMobileMenu();
        }

        function showTiers() {
            hideAllSections();
            document.getElementById('tiersInfoPage').classList.remove('hidden');
            toggleMobileMenu();
        }

        function showContact() {
            hideAllSections();
            document.getElementById('contactInfoPage').classList.remove('hidden');
            toggleMobileMenu();
        }

        function showRewards() {
            showQRRedemptionPanel();
            toggleMobileMenu();
        }

        function hideAllSections() {
            const sections = document.querySelectorAll('.card:not(.qr-share-section)');
            sections.forEach(section => section.classList.add('hidden'));
            
            const infoPages = document.querySelectorAll('.info-page');
            infoPages.forEach(page => page.classList.add('hidden'));
        }

        // Header and Navigation Functions
        function toggleMobileMenu() {
            const navLinks = document.getElementById('navLinks');
            navLinks.classList.toggle('active');
        }

        function toggleUserMenu() {
            if (clubManager.currentMember) {
                showDashboard(clubManager.currentMember);
            } else {
                showLoginScreen();
            }
        }

        // Navigation link handlers
        function showDashboardSection() {
            if (clubManager.currentMember) {
                showDashboard(clubManager.currentMember);
            } else {
                showLoginScreen();
            }
            toggleMobileMenu();
        }

        // Search Functionality
        function showSearch() {
            const modal = document.getElementById('searchModal');
            modal.classList.add('active');
            document.getElementById('searchInput').focus();
        }

        function hideSearch() {
            const modal = document.getElementById('searchModal');
            modal.classList.remove('active');
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        // Enhanced search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '<div class="search-result-item">Type at least 2 characters to search</div>';
                return;
            }
            
            performSearch(searchTerm).then(results => {
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-result-item">No results found</div>';
                    return;
                }
                
                resultsContainer.innerHTML = results.map(result => `
                    <div class="search-result-item" onclick="handleSearchResult('${result.type}', '${result.id}')">
                        <strong>${result.title}</strong>
                        <div style="font-size: 12px; opacity: 0.8;">${result.description}</div>
                        <div style="font-size: 11px; margin-top: 5px; color: #00AFF0;">${result.type.toUpperCase()}</div>
                    </div>
                `).join('');
            });
        });

        async function performSearch(term) {
            const results = [];
            
            try {
                // Search members
                const allMembers = await clubManager.db.getAllMembers();
                allMembers.forEach(member => {
                    if (
                        member.jcId.toLowerCase().includes(term) ||
                        member.name.toLowerCase().includes(term) ||
                        member.email.toLowerCase().includes(term)
                    ) {
                        results.push({
                            type: 'member',
                            id: member.jcId,
                            title: `${member.name} (${member.jcId})`,
                            description: `Tier: ${member.tier} | Points: ${member.points || 0} | Email: ${member.email}`
                        });
                    }
                });
                
                // Search vouchers
                const allVouchers = voucherSystem.getAllVouchers();
                allVouchers.forEach(voucher => {
                    if (
                        voucher.code.toLowerCase().includes(term) ||
                        voucher.memberJCId.toLowerCase().includes(term) ||
                        voucher.memberName.toLowerCase().includes(term)
                    ) {
                        results.push({
                            type: 'voucher',
                            id: voucher.code,
                            title: `Voucher: ${voucher.code}`,
                            description: `Member: ${voucher.memberName} (${voucher.memberJCId}) | Discount: ${voucher.discountPercentage}% | Status: ${voucher.status}`
                        });
                    }
                });
                
                // Search QR redemptions
                const allRedemptions = qrRedemptionSystem.getAllRedemptions();
                allRedemptions.forEach(redemption => {
                    if (
                        redemption.redemptionId.toLowerCase().includes(term) ||
                        redemption.memberJCId.toLowerCase().includes(term) ||
                        redemption.memberName.toLowerCase().includes(term)
                    ) {
                        results.push({
                            type: 'redemption',
                            id: redemption.redemptionId,
                            title: `Redemption: ${redemption.redemptionId}`,
                            description: `Member: ${redemption.memberName} | Amount: ${redemption.purchaseAmount} UGX | Status: ${redemption.status}`
                        });
                    }
                });
                
            } catch (error) {
                console.error('Search error:', error);
            }
            
            return results.slice(0, 20);
        }

        function handleSearchResult(type, id) {
            hideSearch();
            
            switch(type) {
                case 'member':
                    if (clubManager.isAdmin) {
                        showAdminPanel();
                        showToast(`Member: ${id} selected`, 'info');
                    }
                    break;
                    
                case 'voucher':
                    if (clubManager.isAdmin) {
                        showAdminPanel();
                        document.getElementById('voucherCodeInput').value = id;
                        showToast(`Voucher: ${id} selected`, 'info');
                    }
                    break;
                    
                case 'redemption':
                    if (clubManager.isAdmin) {
                        showAdminPanel();
                        document.getElementById('voucherCodeInput').value = id;
                        showToast(`Redemption: ${id} selected`, 'info');
                    }
                    break;
            }
        }

        // Show voucher details function
        async function showVoucherDetails(voucherCode) {
            const voucher = await voucherSystem.getVoucherByCode(voucherCode);
            if (!voucher) {
                showToast("Voucher not found", "error");
                return;
            }
            
            const detailsDiv = document.getElementById('scanDetails');
            const discountUGX = voucher.pointsUsed * jeansClubConfig.pointValue;
            
            detailsDiv.innerHTML = `
                <h4>Voucher Details</h4>
                <div class="details-grid">
                    <div class="detail-item">
                        <strong>Code</strong>
                        <div>${voucher.code}</div>
                    </div>
                    <div class="detail-item">
                        <strong>Member</strong>
                        <div>${voucher.memberName} (${voucher.memberJCId})</div>
                    </div>
                    <div class="detail-item">
                        <strong>Discount Value</strong>
                        <div>${discountUGX.toLocaleString()} UGX</div>
                    </div>
                    <div class="detail-item">
                        <strong>Points Used</strong>
                        <div>${voucher.pointsUsed} points</div>
                    </div>
                    <div class="detail-item">
                        <strong>Created</strong>
                        <div>${new Date(voucher.createdDate).toLocaleDateString()}</div>
                    </div>
                    <div class="detail-item">
                        <strong>Expires</strong>
                        <div>${new Date(voucher.expiryDate).toLocaleDateString()}</div>
                    </div>
                    <div class="detail-item">
                        <strong>Status</strong>
                        <div>${voucher.status}</div>
                    </div>
                </div>
            `;
            detailsDiv.classList.remove('hidden');
        }

        // ===========================
        // PAGE LOAD INITIALIZATION
        // ===========================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all systems
            initializeSystems();
            
            // Initialize Google Sign-In
            initGoogleSignIn();
            
            // Check if user is already logged in
            if (clubManager.currentMember) {
                showDashboard(clubManager.currentMember);
            } else {
                showLoginScreen();
            }
            
            // Set current year in footer
            document.querySelector('.footer-bottom p').innerHTML = 
                document.querySelector('.footer-bottom p').innerHTML.replace('2026', new Date().getFullYear());
            
            // Initialize newsletter checkbox
            const newsletterCheckbox = document.getElementById('newsletterSignup');
            if (newsletterCheckbox) {
                newsletterCheckbox.checked = true;
            }
            
            // Set up event listeners for camera scanner
            setupCameraScanner();
            
            // Make sure scanner result div is visible
            const scannerResult = document.getElementById('scannerResult');
            if (scannerResult) {
                scannerResult.style.display = 'block';
                scannerResult.style.visibility = 'visible';
                scannerResult.style.opacity = '1';
            }
            
            console.log("‚úÖ Jeans Club application fully initialized!");
        });

        // Setup camera scanner functionality
        function setupCameraScanner() {
            const modal = document.getElementById('cameraScannerModal');
            if (!modal) return;
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeCameraScanner();
                }
            });
            
            // Prevent closing when clicking inside the scanner container
            const cameraContainer = modal.querySelector('.camera-container');
            if (cameraContainer) {
                cameraContainer.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        }

        // ===========================
        // ADDITIONAL HELPER FUNCTIONS
        // ===========================
        
        function formatCurrency(amount) {
            return amount.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }) + ' UGX';
        }

        function formatPoints(points) {
            return points.toLocaleString() + ' points';
        }

        function calculateDiscountFromPoints(points) {
            return points * jeansClubConfig.pointValue;
        }

        function calculatePointsFromSpending(spending) {
            return Math.floor(spending * jeansClubConfig.earningRate);
        }

        // Error handling for camera access
        function handleCameraError(error) {
            console.error('Camera error:', error);
            updateScannerStatus('Camera error: ' + error.message, false);
            showToast('Camera access failed: ' + error.message, 'error');
        }

        // Close scanner when pressing Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('cameraScannerModal');
                if (modal && modal.classList.contains('active')) {
                    closeCameraScanner();
                }
            }
        });

        // Clean up resources when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && scannerStream) {
                stopScanner();
            }
        });

        // Initialize with proper checks
        function safeInitialize() {
            try {
                initializeSystems();
                
                // Check for required features
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.warn('Camera access not supported in this browser');
                    showToast('QR scanning requires camera access. Please use a modern browser.', 'info');
                }
                
                // Check localStorage availability
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                } catch (e) {
                    console.error('LocalStorage not available:', e);
                    showToast('Please enable local storage for full functionality', 'error');
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Application initialization failed. Please refresh the page.', 'error');
            }
        }

        // Run safe initialization
        safeInitialize();

        // Export functions to global scope
        window.openCameraScanner = openCameraScanner;
        window.closeCameraScanner = closeCameraScanner;
        window.processScan = processScan;
        window.showDashboardSection = showDashboardSection;
        window.showQRRedemptionPanel = showQRRedemptionPanel;
        window.calculateRedemptionOptions = calculateRedemptionOptions;
        window.selectRedemptionOption = selectRedemptionOption;
        window.generateQRCode = generateQRCode;
        window.showAdminPanel = showAdminPanel;
        window.showAdminLogin = showAdminLogin;
        window.logout = logout;
        window.refreshData = refreshData;
        window.showSignupScreen = showSignupScreen;
        window.showLoginScreen = showLoginScreen;
        window.signUpWithEmail = signUpWithEmail;
        window.loginWithCredentials = loginWithCredentials;
        window.calculateDiscount = calculateDiscount;
        window.redeemPoints = redeemPoints;
        window.shareReferral = shareReferral;
        window.toggleNewsletter = toggleNewsletter;
        window.showSearch = showSearch;
        window.hideSearch = hideSearch;
        window.showMembershipInfo = showMembershipInfo;
        window.showBenefits = showBenefits;
        window.showTiers = showTiers;
        window.showContact = showContact;
        window.showRewards = showRewards;
        window.showPasswordResetScreen = showPasswordResetScreen;
        window.requestPasswordReset = requestPasswordReset;
        window.executePasswordReset = executePasswordReset;
        window.showDeleteMemberSection = showDeleteMemberSection;
        window.confirmDeleteMember = confirmDeleteMember;
        window.adminAddPurchase = adminAddPurchase;
        window.sendNewsletter = sendNewsletter;
        window.showVoucherManagementPanel = showVoucherManagementPanel;
        window.refreshVouchers = refreshVouchers;
        window.showQRRedemptionManagementPanel = showQRRedemptionManagementPanel;

        // Mobile menu toggle
        window.toggleMobileMenu = toggleMobileMenu;

        // Final initialization message
        console.log("üöÄ Jeans Club Loyalty Program Loaded Successfully!");
        console.log("üìä Point System: 1 point per 1,000 UGX spent, 1 point = 250 UGX discount");
        console.log("üîí Fraud Prevention: Active with email normalization and IP tracking");
        console.log("üì± Camera Scanner: Ready for QR code scanning");
        console.log("‚òÅÔ∏è Supabase Database: Connected and ready");

        // Show welcome message if new visitor
        const firstVisit = !localStorage.getItem('jeansClubVisited');
        if (firstVisit) {
            localStorage.setItem('jeansClubVisited', 'true');
            setTimeout(() => {
                showToast("üéâ Welcome to Jeans Club Loyalty Program! Earn points, redeem rewards, and enjoy exclusive benefits!", "info");
            }, 1000);
        }
    </script>
</body>
</html>